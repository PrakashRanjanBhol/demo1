export class ChunkedJsonParserComponent implements OnInit {
  public isWaitingForApproval = false;
  public currentApprovalRequest: ApprovalRequest | null = null;
  public isProcessing = false;
  public executedItems: ToolData[] = [];
  public queuedItems: ToolData[] = [];
  public groupedExecutedItems: GroupedItem[] = [];
  public isApprovingChanges = false;

  constructor(
    private parserService: ChunkedJsonParserService,
    private cdr: ChangeDetectorRef
  ) {}

  // ... existing methods ...

  private setupCallbacks(): void {
    this.parserService.setCallbacks({
      onToolDetected: (toolData: ToolData) => {
        this.logToolDetected(toolData);
        this.updateLists();
        
        if (toolData.tool === 'READ') {
          this.appendReadContent(toolData);
        }
      },
      onApprovalRequest: (approvalRequest: ApprovalRequest) => {
        this.isWaitingForApproval = true;
        this.currentApprovalRequest = approvalRequest;
        this.isApprovingChanges = false; // Reset approving state
        this.logWaitingForApproval(approvalRequest.data);
        this.updateLists();
        this.cdr.detectChanges();
      },
      onCompletion: () => {
        this.isProcessing = false;
        this.isApprovingChanges = false; // Reset on completion
        this.logCompleted();
        this.updateLists();
      },
      onError: (error: string) => {
        this.isProcessing = false;
        this.isApprovingChanges = false; // Reset on error
        this.logError(error);
      },
      onFirstChunk: () => {
        this.logFirstChunkReceived();
      }
    });
  }

  // UPDATED approveAndContinue with timeout
  public approveAndContinue(): void {
    if (this.currentApprovalRequest && !this.isApprovingChanges) {
      console.log('✅ APPROVED:', this.currentApprovalRequest.data);
      console.log('Continuing with next operation...\n');
      
      // Set loading state immediately
      this.isApprovingChanges = true;
      this.cdr.detectChanges();
      
      // Wait for a minimum of 800ms to show the spinner (for better UX)
      const minDisplayTime = 800; // milliseconds
      const startTime = Date.now();
      
      // Process the approval after showing spinner
      setTimeout(() => {
        // Reset approval UI state
        this.isWaitingForApproval = false;
        this.currentApprovalRequest = null;
        
        // Approve and continue
        this.parserService.approveAndContinue();
        
        // Update lists
        this.updateLists();
        
        // Calculate remaining time to show spinner
        const elapsed = Date.now() - startTime;
        const remainingTime = Math.max(0, minDisplayTime - elapsed);
        
        // Keep spinner visible for minimum duration
        if (remainingTime > 0) {
          setTimeout(() => {
            this.isApprovingChanges = false;
            this.cdr.detectChanges();
          }, remainingTime);
        } else {
          this.isApprovingChanges = false;
          this.cdr.detectChanges();
        }
      }, 100); // Small delay to ensure UI updates
    }
  }

  // Keep rejectChanges as is
  public rejectChanges(): void {
    if (this.currentApprovalRequest) {
      console.log('❌ REJECTED:', this.currentApprovalRequest.data);
      console.log('Continuing with next operation...\n');
      
      // Mark as rejected and continue
      const rejectedData = { ...this.currentApprovalRequest.data, rejected: true };
      
      // Reset approval state
      this.isWaitingForApproval = false;
      this.currentApprovalRequest = null;
      
      this.parserService.approveAndContinue();
      this.updateLists();
    }
  }

  // ... rest of the existing methods (getDiffHtml, computeDiff, etc.) ...
}
