renderDiff(file: FileData, fileIndex: number): void {
  const diffString = this.generateDiffString(file);
  const diffOutputElement = document.getElementById(`diff-output-${fileIndex}`);

  if (diffOutputElement && typeof Diff2HtmlUI !== 'undefined') {
    // Clear existing content
    diffOutputElement.innerHTML = '';

    const diff2htmlUi = new Diff2HtmlUI(
      diffOutputElement,
      diffString,
      {
        drawFileList: false,
        matching: 'lines',
        outputFormat: this.viewMode === 'side-by-side' ? 'side-by-side' : 'line-by-line',
        highlight: true,
        renderNothingWhenEmpty: false,
        matchWordsThreshold: 0.25,
        maxLineSizeInBlockForComparison: 200,
        diffStyle: 'word', // This helps with better word-level diffs
      }
    );
    diff2htmlUi.draw();

    setTimeout(() => {
      this.insertCommentsAtLines(file, fileIndex);
    }, 300);
  }
}















/* Enable line wrapping for code content */
.pr-review-container ::ng-deep .d2h-code-line-ctn,
.pr-review-container ::ng-deep .d2h-code-side-line-ctn {
    color: var(--bitbucket-file-comparator-text-primary) !important;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    max-width: 100%;
}

/* Ensure code lines wrap properly */
.pr-review-container ::ng-deep .d2h-code-line,
.pr-review-container ::ng-deep .d2h-code-side-line {
    background-color: var(--bitbucket-file-comparator-bg-primary) !important;
    color: var(--bitbucket-file-comparator-text-primary) !important;
    width: auto;
    overflow: visible !important;
}

/* Prevent horizontal scroll on diff wrapper */
.pr-review-container ::ng-deep .d2h-wrapper {
    border: none !important;
    overflow-x: visible !important;
    max-width: 100%;
}

/* Ensure the diff table doesn't cause horizontal scroll */
.pr-review-container ::ng-deep .d2h-diff-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
    overflow-x: visible !important;
}

/* Code content should wrap, not scroll */
.pr-review-container ::ng-deep .d2h-code-line-ctn,
.pr-review-container ::ng-deep .d2h-code-side-line-ctn {
    padding-left: 8px !important;
    padding-right: 8px !important;
    overflow: visible !important;
}

/* Ensure pre tags don't cause scroll */
.pr-review-container ::ng-deep .d2h-code-line pre,
.pr-review-container ::ng-deep .d2h-code-side-line pre {
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    margin: 0;
    overflow: visible !important;
}

/* Line numbers should stay fixed width */
.pr-review-container ::ng-deep .d2h-code-linenumber,
.pr-review-container ::ng-deep .d2h-code-side-linenumber {
    background-color: var(--bitbucket-file-comparator-bg-tertiary) !important;
    border-color: var(--bitbucket-file-comparator-border-primary) !important;
    color: var(--bitbucket-file-comparator-text-secondary) !important;
    width: 1%;
    min-width: 50px;
    max-width: 80px;
    white-space: nowrap;
    text-align: right;
    padding-right: 10px;
    padding-left: 10px;
    vertical-align: top !important;
}

/* Ensure wrapped lines align properly */
.pr-review-container ::ng-deep .d2h-diff-tbody tr {
    vertical-align: top;
}

/* Code cells should take remaining space and wrap */
.pr-review-container ::ng-deep .d2h-code-line,
.pr-review-container ::ng-deep .d2h-code-side-line {
    width: auto;
    max-width: 100%;
    overflow: visible !important;
    vertical-align: top !important;
}

/* For side-by-side view, ensure both sides wrap independently */
.pr-review-container ::ng-deep .d2h-file-side-diff {
    background-color: var(--bitbucket-file-comparator-bg-primary) !important;
    overflow-x: visible !important;
}

.pr-review-container ::ng-deep .d2h-file-side-diff .d2h-code-side-line {
    width: 50%;
    max-width: 50%;
}

/* Inline changes (ins/del tags) should also wrap */
.pr-review-container ::ng-deep .d2h-code-line ins,
.pr-review-container ::ng-deep .d2h-code-side-line ins,
.pr-review-container ::ng-deep .d2h-code-line del,
.pr-review-container ::ng-deep .d2h-code-side-line del {
    background-color: var(--bitbucket-file-comparator-diff-insertion-change) !important;
    color: var(--bitbucket-file-comparator-diff-text-primary) !important;
    text-decoration: none !important;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
}

/* Preserve indentation when wrapping */
.pr-review-container ::ng-deep .d2h-code-line-ctn {
    display: block;
    padding-left: 8px;
    text-indent: 0;
}

/* Hide horizontal scrollbar if it appears */
.pr-review-container ::ng-deep .d2h-file-wrapper {
    overflow-x: hidden !important;
}

.pr-review-container .diff-container {
    padding: 0;
    position: relative;
    overflow: hidden;
    width: 100%;
}












/* Add this to your theme variables */
:host {
    --bitbucket-file-comparator-code-wrap: pre-wrap; /* or 'pre' for no wrapping */
}

/* Then use it */
.pr-review-container ::ng-deep .d2h-code-line-ctn,
.pr-review-container ::ng-deep .d2h-code-side-line-ctn {
    white-space: var(--bitbucket-file-comparator-code-wrap) !important;
}
