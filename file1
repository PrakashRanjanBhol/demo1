// Perform SSO login API call
private performSSOLogin(request: any): Observable<AuthResponse> {
  return this.http.post<AuthResponse>(`${this.apiUrl}/auth/sso/login`, request, {
    withCredentials: true
  }).pipe(
    tap(response => {
      // Map response to User object
      const user: User = {
        token: response.token,
        is_admin: response.is_admin,
        user_name: response.user_name
      };
      
      // Store user in localStorage and update subject ONLY after API success
      localStorage.setItem('currentUser', JSON.stringify(user));
      this.currentUserSubject.next(user);
    }),
    catchError(this.handleError)
  );
}






ngOnInit(): void {
  // Start with not authenticated
  this.isAuthenticated = false;
  this.currentUser = null;

  // Always attempt SSO login on page load/refresh
  this.attemptAutoSSO();

  // Load saved theme from localStorage
  const savedTheme = localStorage.getItem('theme') as 'light' | 'dark';
  if (savedTheme) {
    this.currentTheme = savedTheme;
    this.applyTheme(savedTheme);
  }

  // Load sidebar state from localStorage
  const savedSidebarState = localStorage.getItem('sidebarCollapsed');
  if (savedSidebarState !== null) {
    this.isSidebarCollapsed = savedSidebarState === 'true';
  }

  // Subscribe to current user changes
  this.authService.currentUser.subscribe(user => {
    this.currentUser = user;
    this.isAuthenticated = user !== null;
  });
}

// Attempt automatic SSO login
private attemptAutoSSO(): void {
  this.authService.initiateSSO().subscribe({
    next: (response) => {
      console.log('Auto SSO login successful:', response);
      // User is set via the subscription to currentUser
    },
    error: (error) => {
      console.error('Auto SSO login failed:', error);
      this.isAuthenticated = false;
      this.currentUser = null;
      // Redirect to SSO connect page on failure
      this.router.navigate(['/sso-connect'], { replaceUrl: true });
    }
  });
}
