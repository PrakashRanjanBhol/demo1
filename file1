ngOnInit(): void {
  // Always attempt SSO login on page load/refresh
  this.attemptAutoSSO();

  // Load saved theme from localStorage
  const savedTheme = localStorage.getItem('theme') as 'light' | 'dark';
  if (savedTheme) {
    this.currentTheme = savedTheme;
    this.applyTheme(savedTheme);
  }

  // Load sidebar state from localStorage
  const savedSidebarState = localStorage.getItem('sidebarCollapsed');
  if (savedSidebarState !== null) {
    this.isSidebarCollapsed = savedSidebarState === 'true';
  }

  // Subscribe to current user changes
  this.authService.currentUser.subscribe(user => {
    this.currentUser = user;
    this.isAuthenticated = user !== null;
  });
}

// Attempt automatic SSO login
private attemptAutoSSO(): void {
  this.authService.initiateSSO().subscribe({
    next: (response) => {
      console.log('Auto SSO login successful:', response);
      this.isAuthenticated = true;
      this.currentUser = response.user || this.authService.currentUserValue;
      // User will stay on whatever URL they entered
    },
    error: (error) => {
      console.error('Auto SSO login failed:', error);
      this.isAuthenticated = false;
      this.currentUser = null;
      // Redirect to SSO connect page on failure
      this.router.navigate(['/sso-connect'], { replaceUrl: true });
    }
  });
}
