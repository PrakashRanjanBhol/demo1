// Add new output event emitter at the top with other outputs:
@Output() onUploadComplete = new EventEmitter<{ id: number, status: 'Success' | 'Failed' }>();

// Update the uploadFileViaService method:
private uploadFileViaService(fileWithStatus: FileWithStatus): Promise<void> {
  return new Promise((resolve, reject) => {
    const sub = this.uploadGenerateService.uploadFile(fileWithStatus.file).subscribe({
      next: (event: any) => {
        if (event.type === HttpEventType.UploadProgress) {
          if (event.total) {
            fileWithStatus.progress = Math.round((100 * event.loaded) / event.total);
          }
        } else if (event.type === HttpEventType.Response) {
          const response = event.body as UploadResponse;
          if (response.status === 'Success') {
            fileWithStatus.uploadedFileId = response.data.id;
            fileWithStatus.uploadedFileName = response.data.original_name;
            fileWithStatus.uploadedAt = response.data.created_at;
            console.log('Upload successful:', response);
            
            // Emit success event to parent
            this.onUploadComplete.emit({
              id: response.data.id,
              status: 'Success'
            });
            
            resolve();
          } else {
            reject(new Error('Upload failed with status: ' + response.status));
          }
        }
      },
      error: (error) => {
        console.error('Upload error:', error);
        
        // Emit failure event to parent (if we have the file ID)
        if (fileWithStatus.uploadedFileId) {
          this.onUploadComplete.emit({
            id: fileWithStatus.uploadedFileId,
            status: 'Failed'
          });
        }
        
        reject(error);
      }
    });
    this.subscriptions.push(sub);
  });
}

// Also update the uploadFilesSequentially method to emit on error:
async uploadFilesSequentially(): Promise<void> {
  for (let i = 0; i < this.uploadedFilesWithStatus.length; i++) {
    const fileWithStatus = this.uploadedFilesWithStatus[i];

    // Skip already uploaded files
    if (fileWithStatus.status === 'uploaded') {
      continue;
    }

    fileWithStatus.status = 'uploading';
    fileWithStatus.progress = 0;

    try {
      await this.uploadFileViaService(fileWithStatus);
      fileWithStatus.status = 'uploaded';
      fileWithStatus.progress = 100;
    } catch (error) {
      fileWithStatus.status = 'error';
      console.error(`Failed to upload ${fileWithStatus.file.name}:`, error);
      
      // If upload failed and we don't have an ID yet, we can't emit with ID
      // The error emission is already handled in uploadFileViaService if ID exists
    }
  }
}



// In parent component template:
<app-upload-generate 
  [requestFile]="selectedFile"
  (onGenerate)="handleGenerate($event)"
  (onFileRemoved)="handleFileRemoved($event)"
  (onGenerationComplete)="handleGenerationComplete($event)"
  (onUploadComplete)="handleUploadComplete($event)">
</app-upload-generate>

// In parent component class:
handleUploadComplete(event: { id: number, status: 'Success' | 'Failed' }): void {
  console.log('Upload complete:', event);
  if (event.status === 'Success') {
    // Handle successful upload
    console.log(`File ${event.id} uploaded successfully`);
  } else {
    // Handle failed upload
    console.log(`File ${event.id} upload failed`);
  }
}
