updatePreview() {
  if (!this.artifactVersion) return;

  // Clear existing content first
  this.clearPreview();

  if (this.artifactVersion.type === 'html') {
    // Render HTML in iframe
    this.renderHtmlInIframe();
  } else if (this.artifactVersion.type === 'image') {
    // Render image as img tag
    this.renderImage();
  }
}





private clearPreview() {
  // Clear iframe
  if (this.previewFrame?.nativeElement) {
    const iframe = this.previewFrame.nativeElement;
    iframe.style.display = 'none';
    
    // Clear iframe content
    const doc = iframe.contentDocument || iframe.contentWindow?.document;
    if (doc) {
      doc.open();
      doc.write('');
      doc.close();
    }
  }
  
  // Clear image container
  const imgContainer = document.getElementById('image-preview-container');
  if (imgContainer) {
    imgContainer.innerHTML = '';
    imgContainer.style.display = 'none';
  }
  
  // Reset zoom level
  this.zoomLevel = 1;
}










private renderHtmlInIframe() {
  if (!this.previewFrame?.nativeElement) return;
  
  const iframe = this.previewFrame.nativeElement;
  
  // Hide image container if exists
  const imgContainer = document.getElementById('image-preview-container');
  if (imgContainer) {
    imgContainer.style.display = 'none';
    imgContainer.innerHTML = '';
  }
  
  // Show iframe
  iframe.style.display = 'block';
  
  // Show loader
  this.showLoader(iframe);

  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    doc.write(this.wrapHtmlWithLoadingDetection(this.artifactVersion!.content));
    doc.close();

    // Listen for messages from iframe
    this.setupIframeMessageListener(iframe);
  }
}







private renderImage() {
  if (!this.previewFrame?.nativeElement) return;
  
  const iframe = this.previewFrame.nativeElement;
  
  // Hide and clear iframe
  iframe.style.display = 'none';
  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    doc.write('');
    doc.close();
  }
  
  // Reset zoom level
  this.zoomLevel = 1;
  
  // Get or create image container
  let imgContainer = document.getElementById('image-preview-container');
  if (!imgContainer) {
    imgContainer = document.createElement('div');
    imgContainer.id = 'image-preview-container';
    imgContainer.className = 'image-preview-container';
    iframe.parentElement?.appendChild(imgContainer);
  }
  
  // Clear previous content
  imgContainer.innerHTML = '';
  
  // Show container
  imgContainer.style.display = 'flex';
  
  // Show loader
  imgContainer.innerHTML = `
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p style="margin-top: 20px; color: #666;">Loading image...</p>
    </div>
  `;
  
  try {
    const base64Content = this.convertUrlSafeBase64ToStandard(this.artifactVersion!.content);
    const dataUrl = this.createDataUrl(base64Content);
    
    // Create wrapper for the image
    const imgWrapper = document.createElement('div');
    imgWrapper.className = 'image-wrapper';
    
    const img = document.createElement('img');
    img.className = 'preview-image';
    img.alt = 'Artifact Image';
    
    img.onload = () => {
      const loader = imgContainer!.querySelector('.loading-overlay');
      if (loader) {
        loader.remove();
      }
      
      // Set initial size based on container
      const containerWidth = imgContainer!.clientWidth - 40;
      const containerHeight = imgContainer!.clientHeight - 40;
      const imgWidth = img.naturalWidth;
      const imgHeight = img.naturalHeight;
      
      const scaleX = containerWidth / imgWidth;
      const scaleY = containerHeight / imgHeight;
      const initialScale = Math.min(scaleX, scaleY, 1);
      
      img.style.width = `${imgWidth * initialScale}px`;
      img.style.height = `${imgHeight * initialScale}px`;
      
      console.log('Image loaded successfully');
    };
    
    img.onerror = () => {
      imgContainer!.innerHTML = `
        <div class="error-message">
          <h3>⚠️ Image Loading Failed</h3>
          <p>Failed to load the image.</p>
          <p style="font-size: 12px; color: #999;">The image data may be corrupted or in an invalid format.</p>
        </div>
      `;
      console.error('Image failed to load');
    };
    
    const timeout = setTimeout(() => {
      if (imgContainer!.querySelector('.loading-overlay')) {
        imgContainer!.innerHTML = `
          <div class="error-message">
            <h3>⚠️ Image Loading Timeout</h3>
            <p>Image took too long to load.</p>
            <p style="font-size: 12px; color: #999;">The image may be too large or corrupted.</p>
          </div>
        `;
      }
    }, 10000);
    
    img.addEventListener('load', () => clearTimeout(timeout));
    
    img.src = dataUrl;
    imgWrapper.appendChild(img);
    imgContainer.appendChild(imgWrapper);
    
  } catch (error) {
    console.error('Error processing base64 image:', error);
    imgContainer.innerHTML = `
      <div class="error-message">
        <h3>⚠️ Image Processing Failed</h3>
        <p>Failed to process the base64 image data.</p>
        <p style="font-size: 12px; color: #999;">The image data may be in an invalid format.</p>
      </div>
    `;
  }
}
