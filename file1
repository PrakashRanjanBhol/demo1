onGenerateComplete(data: { file: any, prompts: string, mode: string }): void {
  const fileId = data.file.fileID.toString();

  // Check if item already exists in history
  const existingItem = this.historyComponent?.historyItems.find((i: any) => i.id === fileId);

  if (existingItem) {
    // Item already exists, update its status to in-progress
    this.historyComponent.updateItemStatus(fileId, 'in-progress');
    this.selectedHistoryItem = existingItem;
  } else {
    // Create new item with in-progress status
    const newItem = {
      id: fileId,
      name: data.file.fileName,
      displayDate: 'Created on ' + new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }),
      date: new Date(),
      progress: 'in progress',  // CHANGED: Set to 'in progress' instead of 'completed'
      status: 'in-progress' as 'not-generated' | 'in-progress' | 'completed',  // CHANGED: Set status to 'in-progress'
      isClickable: false  // CHANGED: Set to false since it's still processing
    };

    // Add to history
    if (this.historyComponent) {
      this.historyComponent.addHistoryItem(newItem);
    }

    this.selectedHistoryItem = newItem;
  }

  // Don't load results yet since processing is in progress
  // Results will be loaded after completion
}

// ADD THIS NEW METHOD to be called when generation is actually complete
onGenerationComplete(fileId: string): void {
  // Update the item status to completed
  if (this.historyComponent) {
    this.historyComponent.updateItemStatus(fileId, 'completed');
  }

  // Now load the results
  this.loadResultsForItem(fileId);
}










// ADD THIS METHOD - Update item status
updateItemStatus(itemId: string, status: 'not-generated' | 'in-progress' | 'completed'): void {
  const item = this.historyItems.find(i => i.id === itemId);
  if (item) {
    item.status = status;
    item.progress = status === 'completed' ? 'completed' : 'in progress';
    item.isClickable = status === 'completed';
    
    // Update filtered history as well
    this.filterHistory();
  }
}

// MODIFY THIS METHOD - Make it public so parent can call it
public addHistoryItem(item: HistoryItem): void {
  // Check if item already exists
  const existingIndex = this.historyItems.findIndex(i => i.id === item.id);
  
  if (existingIndex !== -1) {
    // Update existing item
    this.historyItems[existingIndex] = item;
  } else {
    // Add new item at the beginning
    this.historyItems.unshift(item);
  }
  
  this.filteredHistory = [...this.historyItems];
}












onGenerateClick(): void {
  // ... your existing code to call the generate API
  
  this.generateService.generateAnalysis(request).subscribe({
    next: (response) => {
      // Immediately emit the event with the file info
      // This triggers the in-progress status
      this.onGenerate.emit({
        file: this.selectedFile,
        prompts: this.prompts,
        mode: this.selectedMode
      });
      
      // THEN start polling for progress or wait for completion
      this.pollProgress(this.selectedFile.fileID);
    },
    error: (error) => {
      console.error('Generate failed:', error);
    }
  });
}

// ADD THIS METHOD - Poll for progress completion
pollProgress(fileId: string): void {
  const pollInterval = setInterval(() => {
    this.generateService.getProgress(fileId).subscribe({
      next: (progressResponse) => {
        if (progressResponse.progress === 100 || progressResponse.status === 'completed') {
          clearInterval(pollInterval);
          
          // Notify parent that generation is complete
          // You'll need to add a new output event for this
          this.onGenerationComplete.emit(fileId);
        }
      },
      error: (error) => {
        console.error('Progress check failed:', error);
        clearInterval(pollInterval);
      }
    });
  }, 2000); // Poll every 2 seconds
}











import { Component, EventEmitter, Output } from '@angular/core';

@Component({
  selector: 'app-upload-generate',
  // ...
})
export class UploadGenerateComponent {
  @Output() onGenerate = new EventEmitter<{ file: any, prompts: string, mode: string }>();
  @Output() onGenerationComplete = new EventEmitter<string>(); // ADD THIS LINE
  
  // ... rest of your code
}

<!-- Upload & Generate Component -->
<app-upload-generate 
  (onGenerate)="onGenerateComplete($event)"
  (onGenerationComplete)="onGenerationComplete($event)">
</app-upload-generate>
