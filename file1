import React, { useState, useEffect } from 'react';
import { Dialog } from 'primereact/dialog';
import { Dropdown } from 'primereact/dropdown';
import { Button } from 'primereact/button';
import { ProgressSpinner } from 'primereact/progressspinner';
import axios from 'axios';
import styles from './SelectModel.module.css';

const SelectModel = ({ onHide }) => {
    const languageOptions = ['English', 'Hindi'];

    const modelOptionsByLanguage = {
        English: ['Model A', 'Model B', 'Model C'],
        Hindi: ['Model D', 'Model E', 'Model F']
    };

    const imageModelOptions = ['Auto', 'Custom Image Model'];
    const pptModelOptions = ['Auto', 'PPT Model X'];

    const [loading, setLoading] = useState(true);
    const [isLoadingModel, setIsLoadingModel] = useState(false);
    const [isLoadingImageModel, setIsLoadingImageModel] = useState(false);
    const [isLoadingPptModel, setIsLoadingPptModel] = useState(false);

    const [language, setLanguage] = useState(null);
    const [model, setModel] = useState(null);
    const [imageModel, setImageModel] = useState(null);
    const [pptModel, setPptModel] = useState(null);

    const [initialLanguage, setInitialLanguage] = useState(null);
    const [initialModel, setInitialModel] = useState(null);
    const [initialImageModel, setInitialImageModel] = useState(null);
    const [initialPptModel, setInitialPptModel] = useState(null);

    const [modelOptions, setModelOptions] = useState([]);

    useEffect(() => {
        const fetchDefaults = async () => {
            try {
                const [languageRes, modelRes] = await Promise.all([
                    axios.get('/api/language'),
                    axios.get('/api/model'),
                ]);

                const fetchedLanguage = languageRes.data.language || null;
                const fetchedModel = modelRes.data.model || null;

                setLanguage(fetchedLanguage);
                setModel(fetchedModel);
                setImageModel(modelRes.data.imageModel || null);
                setPptModel(modelRes.data.pptModel || null);

                setInitialLanguage(fetchedLanguage);
                setInitialModel(fetchedModel);
                setInitialImageModel(modelRes.data.imageModel || null);
                setInitialPptModel(modelRes.data.pptModel || null);

                if (fetchedLanguage && modelOptionsByLanguage[fetchedLanguage]) {
                    setModelOptions(modelOptionsByLanguage[fetchedLanguage]);
                }
            } catch (error) {
                setLanguage(null);
                setModel(null);
                setImageModel(null);
                setPptModel(null);

                setInitialLanguage(null);
                setInitialModel(null);
                setInitialImageModel(null);
                setInitialPptModel(null);
                setModelOptions([]);
            } finally {
                setLoading(false);
            }
        };

        fetchDefaults();
    }, []);

    useEffect(() => {
        if (language && modelOptionsByLanguage[language]) {
            setModelOptions(modelOptionsByLanguage[language]);
        } else {
            setModelOptions([]);
        }
        setModel(null); // reset model on language change
    }, [language]);

    const isModelButtonEnabled = language !== initialLanguage || model !== initialModel;
    const isImageModelButtonEnabled = imageModel !== initialImageModel;
    const isPptModelButtonEnabled = pptModel !== initialPptModel;

    const handleLoadModel = () => {
        setIsLoadingModel(true);
        setTimeout(() => {
            setIsLoadingModel(false);
            setInitialLanguage(language);
            setInitialModel(model);
        }, 1000);
    };

    const handleClearModel = () => {
        setModel(null);
    };

    const handleLoadImageModel = () => {
        setIsLoadingImageModel(true);
        setTimeout(() => {
            setIsLoadingImageModel(false);
            setInitialImageModel(imageModel);
        }, 1000);
    };

    const handleLoadPptModel = () => {
        setIsLoadingPptModel(true);
        setTimeout(() => {
            setIsLoadingPptModel(false);
            setInitialPptModel(pptModel);
        }, 1000);
    };

    if (loading) {
        return (
            <Dialog visible header="Model Selector" className={styles.dialog} onHide={onHide}>
                <div className={styles.loadingWrapper}>
                    <ProgressSpinner style={{ width: '1.5rem', height: '1.5rem' }} strokeWidth="6" />
                    <p>Loading models and settings...</p>
                </div>
            </Dialog>
        );
    }

    return (
        <Dialog
            visible
            onHide={onHide}
            header="Model Selector"
            className={styles.dialog}
            style={{ width: '80vw', maxWidth: '1000px' }}
        >
            <div className={styles.modelSelectorContainer}>
                {/* Left Section */}
                <div className={styles.left}>
                    <h3 className={styles.heading}>Vision Model</h3>

                    <div className={styles.field}>
                        <label>
                            Select Language <span className={styles.desc}>Choose your preferred language</span>
                        </label>
                        <Dropdown
                            value={language}
                            options={languageOptions}
                            onChange={(e) => setLanguage(e.value)}
                            placeholder="Please Select"
                            className={styles.dropdown}
                        />
                    </div>

                    <div className={styles.field}>
                        <label>
                            Select Model <span className={styles.desc}>Pick a model to load</span>
                        </label>
                        <Dropdown
                            value={model}
                            options={modelOptions}
                            onChange={(e) => setModel(e.value)}
                            placeholder="Please Select"
                            className={styles.dropdown}
                        />
                    </div>

                    <div className={styles.buttons}>
                        <Button
                            icon="pi pi-play"
                            label={
                                isLoadingModel ? (
                                    <span className={styles.spinnerWithLabel}>
                                        <ProgressSpinner
                                            style={{ width: '0.75rem', height: '0.75rem' }}
                                            strokeWidth="6"
                                            animationDuration=".5s"
                                        />
                                        <span className={styles.loadingText}>Loading...</span>
                                    </span>
                                ) : (
                                    'Load Model'
                                )
                            }
                            disabled={!isModelButtonEnabled || isLoadingModel}
                            className={`p-button-rounded ${styles.actionButton} ${styles.customBlue}`}
                            onClick={handleLoadModel}
                        />
                        <Button
                            label="Clear Model"
                            size="small"
                            className={`p-button-rounded ${styles.actionButton} ${styles.customOrange}`}
                            onClick={handleClearModel}
                        />
                    </div>
                </div>

                {/* Right Section */}
                <div className={styles.right}>
                    <h3 className={styles.heading}>Vision Model</h3>

                    <div className={styles.field}>
                        <label>
                            Select Image Model <span className={styles.desc}>Choose the image model to load</span>
                        </label>
                        <div className={styles.inlineInput}>
                            <Dropdown
                                value={imageModel}
                                options={imageModelOptions}
                                onChange={(e) => setImageModel(e.value)}
                                placeholder="Please Select"
                                className={styles.dropdown}
                            />
                            <Button
                                icon="pi pi-play"
                                label={
                                    isLoadingImageModel ? (
                                        <span className={styles.spinnerWithLabel}>
                                            <ProgressSpinner
                                                style={{ width: '0.65rem', height: '0.65rem' }}
                                                strokeWidth="5"
                                                animationDuration=".5s"
                                            />
                                            <span className={styles.loadingText}>Loading...</span>
                                        </span>
                                    ) : (
                                        'Load'
                                    )
                                }
                                disabled={!isImageModelButtonEnabled || isLoadingImageModel}
                                className={`p-button-rounded ${styles.actionButton} ${styles.customBlue}`}
                                size="small"
                                onClick={handleLoadImageModel}
                            />
                        </div>
                    </div>

                    <div className={styles.field}>
                        <label>
                            PPT Vision Model <span className={styles.desc}>Choose the PPT model to load</span>
                        </label>
                        <div className={styles.inlineInput}>
                            <Dropdown
                                value={pptModel}
                                options={pptModelOptions}
                                onChange={(e) => setPptModel(e.value)}
                                placeholder="Please Select"
                                className={styles.dropdown}
                            />
                            <Button
                                icon="pi pi-play"
                                label={
                                    isLoadingPptModel ? (
                                        <span className={styles.spinnerWithLabel}>
                                            <ProgressSpinner
                                                style={{ width: '0.75rem', height: '0.75rem' }}
                                                strokeWidth="6"
                                                animationDuration=".5s"
                                            />
                                            <span className={styles.loadingText}>Loading...</span>
                                        </span>
                                    ) : (
                                        'Load'
                                    )
                                }
                                disabled={!isPptModelButtonEnabled || isLoadingPptModel}
                                className={`p-button-rounded ${styles.actionButton} ${styles.customOrange}`}
                                size="small"
                                onClick={handleLoadPptModel}
                            />
                        </div>
                    </div>
                </div>
            </div>
        </Dialog>
    );
};

export default SelectModel;
