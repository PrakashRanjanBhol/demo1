<!-- AI Comments (hidden, will be moved to appropriate lines) -->
<div class="comments-hidden-container">
    <div class="ai-comment-thread" 
        *ngFor="let comment of responseData.files[selectedFileIndex].ai_comments; let commentIndex = index"
        [attr.data-line]="comment.line" 
        [id]="'comment-' + getCommentId(selectedFileIndex, commentIndex)">

        <div [class]="getCommentClasses(selectedFileIndex, commentIndex)"
            [id]="getCommentId(selectedFileIndex, commentIndex)">

            <!-- Comment Header -->
            <div class="comment-header">
                <span class="ai-badge">AI Review</span>
                <span class="severity-badge" [ngClass]="'severity-' + comment.severity">
                    {{ comment.severity }}
                </span>

                <span *ngIf="getCommentState(selectedFileIndex, commentIndex).status !== 'pending'"
                    class="status-badge"
                    [ngClass]="'status-' + getCommentState(selectedFileIndex, commentIndex).status">
                    {{ getCommentState(selectedFileIndex, commentIndex).status }}
                </span>

                <span class="comment-time">Line {{ comment.line }}</span>
            </div>

            <!-- Comment Body -->
            <div *ngIf="!getCommentState(selectedFileIndex, commentIndex).isEditing" class="comment-body"
                [id]="getCommentId(selectedFileIndex, commentIndex) + '-body'">
                {{ getCommentState(selectedFileIndex, commentIndex).currentText }}
            </div>

            <!-- Edit Mode -->
            <div *ngIf="getCommentState(selectedFileIndex, commentIndex).isEditing">
                <textarea class="comment-body-editable"
                    [(ngModel)]="editingCommentText[getCommentId(selectedFileIndex, commentIndex)]"
                    [id]="getCommentId(selectedFileIndex, commentIndex) + '-textarea'">
                </textarea>
            </div>

            <!-- Suggested Patch -->
            <div class="suggested-patch" *ngIf="comment.suggested_patch">
                <div class="suggested-patch-header">Suggested Fix:</div>
                <div class="suggested-patch-code">{{ comment.suggested_patch }}</div>
            </div>

            <!-- Comment Actions -->
            <div class="comment-actions" [id]="getCommentId(selectedFileIndex, commentIndex) + '-actions'">

                <!-- Pending State Actions (Accept, Reject, Modify + Navigation) -->
                <ng-container
                    *ngIf="getCommentState(selectedFileIndex, commentIndex).status === 'pending' && !getCommentState(selectedFileIndex, commentIndex).isEditing">
                    
                    <!-- Main Action Buttons -->
                    <button class="action-btn btn-accept"
                        (click)="acceptComment(selectedFileIndex, commentIndex)">
                        <span class="btn-icon">âœ“</span>
                        <span class="btn-text">Accept</span>
                    </button>
                    <button class="action-btn btn-reject"
                        (click)="rejectComment(selectedFileIndex, commentIndex)">
                        <span class="btn-icon">âœ—</span>
                        <span class="btn-text">Reject</span>
                    </button>
                    <button class="action-btn btn-modify"
                        (click)="modifyComment(selectedFileIndex, commentIndex)">
                        <span class="btn-icon">âœŽ</span>
                        <span class="btn-text">Modify</span>
                    </button>
                    
                    <!-- Separator -->
                    <div class="nav-separator"></div>
                    
                    <!-- Navigation Buttons -->
                    <button 
                        class="action-btn btn-nav btn-prev" 
                        (click)="goToPreviousComment()"
                        [disabled]="!hasPreviousComment()"
                        [title]="'Previous comment (' + getCurrentCommentPosition() + ')'">
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </span>
                    </button>
                    <button 
                        class="action-btn btn-nav btn-next" 
                        (click)="goToNextComment()"
                        [disabled]="!hasNextComment()"
                        [title]="'Next comment (' + getCurrentCommentPosition() + ')'">
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </span>
                    </button>
                </ng-container>

                <!-- Editing State Actions (Save, Cancel + Navigation) -->
                <ng-container *ngIf="getCommentState(selectedFileIndex, commentIndex).isEditing">
                    
                    <!-- Edit Action Buttons -->
                    <button class="action-btn btn-save"
                        (click)="saveModifiedComment(selectedFileIndex, commentIndex)">
                        <span class="btn-icon">ðŸ’¾</span>
                        <span class="btn-text">Save</span>
                    </button>
                    <button class="action-btn btn-cancel"
                        (click)="cancelModification(selectedFileIndex, commentIndex)">
                        <span class="btn-icon">âœ•</span>
                        <span class="btn-text">Cancel</span>
                    </button>
                    
                    <!-- Separator -->
                    <div class="nav-separator"></div>
                    
                    <!-- Navigation Buttons -->
                    <button 
                        class="action-btn btn-nav btn-prev" 
                        (click)="goToPreviousComment()"
                        [disabled]="!hasPreviousComment()"
                        [title]="'Previous comment (' + getCurrentCommentPosition() + ')'">
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </span>
                    </button>
                    <button 
                        class="action-btn btn-nav btn-next" 
                        (click)="goToNextComment()"
                        [disabled]="!hasNextComment()"
                        [title]="'Next comment (' + getCurrentCommentPosition() + ')'">
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </span>
                    </button>
                </ng-container>

                <!-- Accepted/Rejected State - Show Only Navigation -->
                <ng-container
                    *ngIf="getCommentState(selectedFileIndex, commentIndex).status !== 'pending' && !getCommentState(selectedFileIndex, commentIndex).isEditing">
                    
                    <!-- Only Navigation Buttons -->
                    <button 
                        class="action-btn btn-nav btn-prev" 
                        (click)="goToPreviousComment()"
                        [disabled]="!hasPreviousComment()"
                        [title]="'Previous comment (' + getCurrentCommentPosition() + ')'">
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </span>
                    </button>
                    <button 
                        class="action-btn btn-nav btn-next" 
                        (click)="goToNextComment()"
                        [disabled]="!hasNextComment()"
                        [title]="'Next comment (' + getCurrentCommentPosition() + ')'">
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </span>
                    </button>
                </ng-container>

            </div>
        </div>
    </div>
</div>
