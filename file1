import { Component, EventEmitter, Output, Input, OnInit, OnChanges, SimpleChanges } from '@angular/core';
import { HistoryService, FileItem } from './history.service';

interface HistoryItem {
  id: string;
  name: string;
  displayDate: string;
  date: Date;
  hasResult: boolean;
  summary_prompt: string | null;
  faq_prompt: string | null;
}

export interface HistoryItemSelect {
  id: string;
  name: string;
  displayDate: string;
  date: Date;
  summary_prompt: string | null;
  faq_prompt: string | null;
}

interface RemoveGenerateFile {
  id: number;
  name: string;
}

interface GenerationStatus {
  id: number;
  status: 'Success' | 'Failure';
  summary_prompt?: string;
  faq_prompt?: string;
}

interface NewUploadFile {
  id: number;
  original_name: string;
  created_at: string;
  summary_prompt: string | null;
  faq_prompt: string | null;
}

interface ProcessStatus {
  id: number | null;
  isProcessing: boolean;
}

@Component({
  selector: 'app-history',
  templateUrl: './history.component.html',
  styleUrls: ['./history.component.css']
})
export class HistoryComponent implements OnInit, OnChanges {
  @Input() removeGenerateFile: RemoveGenerateFile | null = null;
  @Input() generationStatus: GenerationStatus | null = null;
  @Input() newUploadFile: NewUploadFile | null = null;
  @Input() processStatus: ProcessStatus | null = null;  // New input
  
  @Output() onItemSelect = new EventEmitter<HistoryItemSelect>();
  @Output() onAddToContentGeneration = new EventEmitter<HistoryItem>();
  @Output() onRemoveFromContentGeneration = new EventEmitter<string>();

  selectedHistoryItem: HistoryItem | null = null;
  addedToGenerationId: string | null = null;
  processingItemId: string | null = null;  // Track which item is processing
  isPendingExpanded: boolean = true;
  isCompletedExpanded: boolean = true;

  startDate: string = '';
  endDate: string = '';

  historyItems: HistoryItem[] = [];
  isLoading: boolean = false;
  isRefreshing: boolean = false;
  errorMessage: string = '';

  // Filter properties
  isFilterVisible: boolean = false;
  filterFromDate: string = '';
  filterToDate: string = '';
  searchText: string = '';

  constructor(private historyService: HistoryService) {}

  ngOnInit(): void {
    this.initializeDateRange();
    this.fetchHistoryData();
  }

  ngOnChanges(changes: SimpleChanges): void {
    if (changes['removeGenerateFile'] && changes['removeGenerateFile'].currentValue) {
      const fileToRemove = changes['removeGenerateFile'].currentValue as RemoveGenerateFile;
      this.handleRemoveFromParent(fileToRemove);
    }

    if (changes['generationStatus'] && changes['generationStatus'].currentValue) {
      const statusUpdate = changes['generationStatus'].currentValue as GenerationStatus;
      this.handleGenerationStatusChange(statusUpdate);
    }

    if (changes['newUploadFile'] && changes['newUploadFile'].currentValue) {
      const newFile = changes['newUploadFile'].currentValue as NewUploadFile;
      this.handleNewFileUpload(newFile);
    }

    if (changes['processStatus'] && changes['processStatus'].currentValue) {
      const status = changes['processStatus'].currentValue as ProcessStatus;
      this.handleProcessStatusChange(status);
    }
  }

  get pendingFiles(): HistoryItem[] {
    return this.historyItems.filter(item => !item.hasResult);
  }

  get completedFiles(): HistoryItem[] {
    return this.historyItems.filter(item => item.hasResult);
  }

  get filteredPendingFiles(): HistoryItem[] {
    return this.applyTextSearch(this.pendingFiles);
  }

  get filteredCompletedFiles(): HistoryItem[] {
    return this.applyTextSearch(this.completedFiles);
  }

  isProcessing(itemId: string): boolean {
    return this.processingItemId === itemId;
  }

  private handleProcessStatusChange(status: ProcessStatus): void {
    if (status.id === null) {
      // Clear processing state for all items
      console.log('Clearing all processing states');
      this.processingItemId = null;
      return;
    }

    const itemId = status.id.toString();
    const item = this.historyItems.find(i => i.id === itemId);

    if (!item) {
      console.warn('Item not found for process status update:', itemId);
      return;
    }

    if (status.isProcessing) {
      // Set processing state
      console.log(`Setting processing state for item ${itemId}`);
      this.processingItemId = itemId;
    } else {
      // Clear processing state
      console.log(`Clearing processing state for item ${itemId}`);
      if (this.processingItemId === itemId) {
        this.processingItemId = null;
      }
    }
  }

  // ... rest of the methods remain the same ...
}









<!-- For Pending Files Section -->
<div class="history-item" 
     *ngFor="let item of filteredPendingFiles"
     [attr.data-item-id]="item.id"
     [class.selected]="selectedHistoryItem?.id === item.id"
     [class.processing]="isProcessing(item.id)"
     (click)="onHistoryItemClick(item.id)">
    <div class="history-item-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
        </svg>
    </div>
    <div class="history-item-details">
        <h4 class="history-item-name">
            <span class="file-id">#{{ item.id }}</span>
            <span class="file-name">{{ item.name }}</span>
            <!-- Processing Badge -->
            <span class="processing-badge" *ngIf="isProcessing(item.id)">
                <svg class="processing-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing
            </span>
        </h4>
        <p class="history-item-date">{{ item.displayDate }}</p>
    </div>
    <div class="history-item-actions">
        <button class="add-to-generation-btn" 
                [class.added]="isAddedToGeneration(item.id)"
                [disabled]="isProcessing(item.id)"
                (click)="onAddToGeneration($event, item)"
                [title]="isProcessing(item.id) ? 'Processing...' : (isAddedToGeneration(item.id) ? 'Remove from content generation' : 'Add to content generation')">
            <div class="btn-icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="plus-icon" *ngIf="!isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="minus-icon" *ngIf="isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="arrow-left-icon" *ngIf="!isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="arrow-right-icon" *ngIf="isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </div>
        </button>
    </div>
</div>

<!-- Same for Completed Files Section -->
<div class="history-item" 
     *ngFor="let item of filteredCompletedFiles"
     [attr.data-item-id]="item.id"
     [class.selected]="selectedHistoryItem?.id === item.id"
     [class.processing]="isProcessing(item.id)"
     (click)="onHistoryItemClick(item.id)">
    <div class="history-item-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
        </svg>
    </div>
    <div class="history-item-details">
        <h4 class="history-item-name">
            <span class="file-id">#{{ item.id }}</span>
            <span class="file-name">{{ item.name }}</span>
            <!-- Processing Badge -->
            <span class="processing-badge" *ngIf="isProcessing(item.id)">
                <svg class="processing-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing
            </span>
        </h4>
        <p class="history-item-date">{{ item.displayDate }}</p>
    </div>
    <div class="history-item-actions">
        <button class="add-to-generation-btn" 
                [class.added]="isAddedToGeneration(item.id)"
                [disabled]="isProcessing(item.id)"
                (click)="onAddToGeneration($event, item)"
                [title]="isProcessing(item.id) ? 'Processing...' : (isAddedToGeneration(item.id) ? 'Remove from content generation' : 'Add to content generation')">
            <div class="btn-icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="plus-icon" *ngIf="!isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="minus-icon" *ngIf="isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="arrow-left-icon" *ngIf="!isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="arrow-right-icon" *ngIf="isAddedToGeneration(item.id)">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </div>
        </button>
    </div>
</div>










/* Processing Badge */
.processing-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 3px 10px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.4);
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    color: #3b82f6;
    animation: fadeInBadge 0.3s ease;
    flex-shrink: 0;
}

.processing-spinner {
    width: 14px;
    height: 14px;
    animation: spin 1s linear infinite;
}

@keyframes fadeInBadge {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* Processing state for history item */
.history-item.processing {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(96, 165, 250, 0.08));
    border-color: rgba(59, 130, 246, 0.3);
}

.history-item.processing .history-item-icon {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.15));
    border-color: rgba(59, 130, 246, 0.3);
}

.history-item.processing .history-item-icon svg {
    stroke: #3b82f6;
}

.history-item.processing .file-id {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.2));
    color: #3b82f6;
    border-color: rgba(59, 130, 246, 0.4);
}

/* Disable button when processing */
.add-to-generation-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* Responsive Processing Badge */
@media screen and (max-width: 1400px) {
    .processing-badge {
        gap: 4px;
        padding: 2px 8px;
        font-size: 10px;
        border-radius: 10px;
    }

    .processing-spinner {
        width: 12px;
        height: 12px;
    }
}





processStatus: { 
    id: number | null; 
    isProcessing: boolean 
  } | null = null;

