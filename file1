// Initiate SSO login with WebSocket
initiateSSO(): Observable<any> {
  return new Observable(observer => {
    // Create WebSocket connection
    this.ws = new WebSocket(this.wsUrl);

    this.ws.onopen = () => {
      console.log('WebSocket connection opened');
      
      // Send initial message
      const message = {
        rqtype: environment.SSO.RQTYPE,
        token: '',
        data: environment.SSO.DATA
      };
      
      this.ws?.send(JSON.stringify(message));
    };

    this.ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        
        if (msg?.rpcode === 'RETURN_SUCCESS') {
          // Success - parse the data and make SSO API call
          const ssoInfo = JSON.parse(msg?.data);
          const request = {
            userInfo: ssoInfo.userInfo,
            aeskey: ssoInfo.key
          };
          
          this.performSSOLogin(request).subscribe({
            next: (response) => {
              observer.next(response);
              observer.complete();
              this.closeWebSocket();
            },
            error: (error) => {
              observer.error(error);
              this.closeWebSocket();
            }
          });
        } else {
          // SSO login failed
          const errorMsg = 'SSO login failed';
          this.ssoErrorSubject.next(errorMsg);
          observer.error(new Error(errorMsg));
          this.closeWebSocket();
        }
      } catch (error) {
        observer.error(error);
        this.closeWebSocket();
      }
    };

    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      observer.error(new Error('WebSocket connection error'));
      this.closeWebSocket();
    };

    this.ws.onclose = () => {
      console.log('WebSocket connection closed');
    };
  });
}

// Perform SSO login API call
private performSSOLogin(request: any): Observable<AuthResponse> {
  return this.http.post<AuthResponse>(`${this.apiUrl}/auth/sso/login`, request, {
    withCredentials: true
  }).pipe(
    tap(response => {
      // Store user in localStorage and update subject
      localStorage.setItem('currentUser', JSON.stringify(response.user));
      this.currentUserSubject.next(response.user);
    }),
    catchError(this.handleError)
  );
}
