// Updated TypeScript Component - Add this to ngOnInit and update date properties

export class PrSidebarComponent implements OnInit {
  // ... existing properties ...
  
  // Date range properties
  startDate: string = '';
  endDate: string = '';
  appliedStartDate: string = '';
  appliedEndDate: string = '';

  ngOnInit(): void {
    // Set initial date range (3 months ago to today)
    this.initializeDateRange();
    this.updatePRList();
  }

  // Initialize date range with last 3 months
  private initializeDateRange(): void {
    const today = new Date();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(today.getMonth() - 3);

    // Format dates to YYYY-MM-DD for HTML5 date input
    this.endDate = this.formatDateToYYYYMMDD(today);
    this.startDate = this.formatDateToYYYYMMDD(threeMonthsAgo);
    
    // Apply the initial date filter
    this.appliedStartDate = this.startDate;
    this.appliedEndDate = this.endDate;
  }

  // Format date to YYYY-MM-DD
  private formatDateToYYYYMMDD(date: Date): string {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  applyDateFilter(): void {
    this.appliedStartDate = this.startDate;
    this.appliedEndDate = this.endDate;
    this.updatePRList();
  }

  clearDateRange(): void {
    this.startDate = '';
    this.endDate = '';
    this.appliedStartDate = '';
    this.appliedEndDate = '';
    this.updatePRList();
  }

  // Helper method to convert date string (YYYY-MM-DD) to DD-MM-YYYY for display if needed
  private formatDateToDisplay(dateString: string): string {
    if (!dateString) return '';
    const [year, month, day] = dateString.split('-');
    return `${day}-${month}-${year}`;
  }

  // Helper method to parse date string for comparison
  private parseDate(dateString: string): Date | null {
    if (!dateString) return null;
    return new Date(dateString);
  }

  // Update the getFilteredPRs method to include date filtering
  private getFilteredPRs(): PullRequest[] {
    let filtered = this.prData;

    // Apply search filter
    if (this.searchQuery) {
      const query = this.searchQuery.toLowerCase();
      filtered = filtered.filter(pr => {
        return (
          pr.title.toLowerCase().includes(query) ||
          pr.author.toLowerCase().includes(query) ||
          pr.reviewers.some(reviewer => reviewer.toLowerCase().includes(query)) ||
          pr.id.toString().includes(query) ||
          pr.state.toLowerCase().includes(query)
        );
      });
    }

    // Apply date range filter (only when Apply button is clicked)
    if (this.appliedStartDate || this.appliedEndDate) {
      filtered = filtered.filter(pr => {
        // You'll need to add a 'created_at' or 'updated_at' field to your PR data
        // For now, this is a placeholder implementation
        if (!pr.created_at) return true; // Skip filtering if no date field
        
        const prDate = this.parseDate(pr.created_at);
        if (!prDate) return true;

        const startDateObj = this.parseDate(this.appliedStartDate);
        const endDateObj = this.parseDate(this.appliedEndDate);

        if (startDateObj) {
          startDateObj.setHours(0, 0, 0, 0);
          if (prDate < startDateObj) {
            return false;
          }
        }

        if (endDateObj) {
          endDateObj.setHours(23, 59, 59, 999);
          if (prDate > endDateObj) {
            return false;
          }
        }

        return true;
      });
    }

    return filtered;
  }

  // ... rest of the component ...
}

// Update your PullRequest interface to include date field
interface PullRequest {
  id: number;
  title: string;
  state: 'OPEN' | 'MERGED';
  author: string;
  reviewers: string[];
  user_comments: number;
  url: string;
  created_at?: string; // Add this field (format: 'YYYY-MM-DD' or ISO date string)
  updated_at?: string; // Or use this field
}

// Example PR data with dates:
/*
prData: PullRequest[] = [
  {
    id: 1,
    title: 'Sample PR',
    state: 'OPEN',
    author: 'Person4',
    reviewers: ['person1', 'person2', 'person3'],
    user_comments: 3,
    url: 'http://abc',
    created_at: '2024-11-01' // Add date in YYYY-MM-DD format
  },
  {
    id: 2,
    title: 'Sample PR1',
    state: 'MERGED',
    author: 'Person1',
    reviewers: ['person4', 'person2', 'person3'],
    user_comments: 2,
    url: 'http://abc',
    created_at: '2024-10-15'
  },
  {
    id: 3,
    title: 'Fix authentication bug in login flow',
    state: 'OPEN',
    author: 'Person2',
    reviewers: ['person1', 'person3'],
    user_comments: 5,
    url: 'http://abc',
    created_at: '2024-09-20'
  },
  {
    id: 4,
    title: 'Add new dashboard component with analytics',
    state: 'OPEN',
    author: 'Person3',
    reviewers: ['person1', 'person2', 'person4'],
    user_comments: 1,
    url: 'http://abc',
    created_at: '2024-08-10'
  },
  {
    id: 5,
    title: 'Update dependencies and fix security vulnerabilities',
    state: 'MERGED',
    author: 'Person5',
    reviewers: ['person1'],
    user_comments: 0,
    url: 'http://abc',
    created_at: '2024-07-05'
  }
];
*/
