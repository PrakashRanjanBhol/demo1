updatePreview() {
  if (!this.previewFrame?.nativeElement) return;
  if (!this.artifactVersion) return;

  const iframe = this.previewFrame.nativeElement;

  // Show loader
  this.showLoader(iframe);

  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    
    if (this.artifactVersion.type === 'html') {
      // Render as HTML with CDN loading detection
      doc.write(this.wrapHtmlWithLoadingDetection(this.artifactVersion.content));
    } else if (this.artifactVersion.type === 'image') {
      // Render as image
      doc.write(this.wrapImageWithLoadingDetection(this.artifactVersion.content));
    } else {
      // Handle null or unknown type
      doc.write('<html><body><p>No content available</p></body></html>');
    }
    
    doc.close();

    // Listen for messages from iframe
    this.setupIframeMessageListener(iframe);
  }
}

private wrapImageWithLoadingDetection(imageContent: string): string {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body {
          margin: 0;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          background: #f5f5f5;
        }
        .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          flex-direction: column;
        }
        .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .error-message {
          color: #d32f2f;
          font-family: Arial, sans-serif;
          text-align: center;
          padding: 20px;
        }
        .image-container {
          max-width: 100%;
          max-height: 100vh;
          padding: 20px;
          box-sizing: border-box;
        }
        .image-container img {
          max-width: 100%;
          max-height: 100%;
          object-fit: contain;
          display: block;
        }
      </style>
    </head>
    <body>
      <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #666;">Loading image...</p>
      </div>
      
      <div class="image-container">
        <img id="artifact-image" src="${this.escapeHtml(imageContent)}" alt="Artifact Image" />
      </div>
      
      <script>
        (function() {
          const img = document.getElementById('artifact-image');
          const overlay = document.getElementById('loading-overlay');
          
          function hideLoader() {
            if (overlay) {
              overlay.style.display = 'none';
            }
          }
          
          function showError() {
            if (overlay) {
              overlay.innerHTML = \`
                <div class="error-message">
                  <h3>⚠️ Image Loading Failed</h3>
                  <p>Failed to load the image.</p>
                  <p style="font-size: 12px; color: #999;">Please check the image URL or your internet connection.</p>
                </div>
              \`;
            }
            window.parent.postMessage({ type: 'image-load-error' }, '*');
          }
          
          img.addEventListener('load', function() {
            hideLoader();
            window.parent.postMessage({ type: 'image-load-complete' }, '*');
          });
          
          img.addEventListener('error', function() {
            showError();
          });
          
          // Timeout fallback (10 seconds)
          setTimeout(function() {
            if (overlay && overlay.style.display !== 'none') {
              showError();
            }
          }, 10000);
        })();
      </script>
    </body>
    </html>
  `;
}

private wrapHtmlWithLoadingDetection(html: string): string {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          flex-direction: column;
        }
        .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .error-message {
          color: #d32f2f;
          font-family: Arial, sans-serif;
          text-align: center;
          padding: 20px;
        }
      </style>
    </head>
    <body>
      <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #666;">Loading dependencies...</p>
      </div>
      
      ${html}
      
      <script>
        (function() {
          let scriptsToLoad = [];
          let linksToLoad = [];
          let loadedCount = 0;
          let totalResources = 0;
          let hasError = false;

          // Find all external scripts and stylesheets
          function findExternalResources() {
            const scripts = document.querySelectorAll('script[src]');
            const links = document.querySelectorAll('link[rel="stylesheet"][href]');
            
            scripts.forEach(script => {
              const src = script.getAttribute('src');
              if (src && (src.startsWith('http://') || src.startsWith('https://') || src.startsWith('//'))) {
                scriptsToLoad.push(script);
              }
            });
            
            links.forEach(link => {
              const href = link.getAttribute('href');
              if (href && (href.startsWith('http://') || href.startsWith('https://') || href.startsWith('//'))) {
                linksToLoad.push(link);
              }
            });
            
            totalResources = scriptsToLoad.length + linksToLoad.length;
          }

          function hideLoader() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
              overlay.style.display = 'none';
            }
          }

          function showError() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
              overlay.innerHTML = \`
                <div class="error-message">
                  <h3>⚠️ Dependency Loading Failed</h3>
                  <p>Failed to load one or more external resources.</p>
                  <p style="font-size: 12px; color: #999;">Please check your internet connection or CDN availability.</p>
                </div>
              \`;
            }
            window.parent.postMessage({ type: 'cdn-load-error' }, '*');
          }

          function checkComplete() {
            loadedCount++;
            if (loadedCount >= totalResources) {
              if (hasError) {
                showError();
              } else {
                hideLoader();
                window.parent.postMessage({ type: 'cdn-load-complete' }, '*');
              }
            }
          }

          function attachLoadListeners() {
            scriptsToLoad.forEach(script => {
              script.addEventListener('load', checkComplete);
              script.addEventListener('error', function() {
                hasError = true;
                checkComplete();
              });
            });

            linksToLoad.forEach(link => {
              link.addEventListener('load', checkComplete);
              link.addEventListener('error', function() {
                hasError = true;
                checkComplete();
              });
            });
          }

          // Initialize
          findExternalResources();
          
          if (totalResources === 0) {
            // No external resources, hide loader immediately
            hideLoader();
            window.parent.postMessage({ type: 'cdn-load-complete' }, '*');
          } else {
            attachLoadListeners();
            
            // Timeout fallback (10 seconds)
            setTimeout(function() {
              if (loadedCount < totalResources) {
                hasError = true;
                showError();
              }
            }, 10000);
          }
        })();
      </script>
    </body>
    </html>
  `;
}

private escapeHtml(text: string): string {
  const map: { [key: string]: string } = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, (m) => map[m]);
}

private setupIframeMessageListener(iframe: HTMLIFrameElement) {
  const messageHandler = (event: MessageEvent) => {
    // Verify message is from our iframe
    if (event.source !== iframe.contentWindow) return;

    switch(event.data.type) {
      case 'cdn-load-complete':
        console.log('All CDN resources loaded successfully');
        break;
      case 'cdn-load-error':
        console.error('CDN resources failed to load');
        break;
      case 'image-load-complete':
        console.log('Image loaded successfully');
        break;
      case 'image-load-error':
        console.error('Image failed to load');
        break;
    }
  };

  window.addEventListener('message', messageHandler);
  
  // Clean up listener when component is destroyed
  // Store the handler reference if you need to remove it later
}

private showLoader(iframe: HTMLIFrameElement) {
  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    doc.write(`
      <html>
      <head>
        <style>
          body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: #f5f5f5;
          }
          .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
          }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </head>
      <body>
        <div class="spinner"></div>
      </body>
      </html>
    `);
    doc.close();
  }
}
