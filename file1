handleGenerate(): void {
  if (this.uploadMode === 'new' && this.selectedUploadFile) {
    const fileWithStatus = this.uploadedFilesWithStatus.find(
      f => f.file.name === this.selectedUploadFile?.name
    );

    // EMIT IMMEDIATELY when Generate button is clicked
    this.onGenerate.emit({
      file: {
        fileID: fileWithStatus?.uploadedFileId || '',
        fileName: this.selectedUploadFile.name
      },
      prompts: this.optionalPrompts,
      mode: this.uploadMode
    });

    this.startProcessing(this.selectedUploadFile.name);

    const request: GenerateRequest = {
      fileID: fileWithStatus?.uploadedFileId || '',
      optional_prompt: this.optionalPrompts,
      model_name: this.selectedModel
    };

    this.generateAnalysis(request);

  } else if (this.uploadMode === 'previous' && this.selectedPreviousFile) {
    // EMIT IMMEDIATELY when Generate button is clicked
    this.onGenerate.emit({
      file: {
        fileID: this.selectedPreviousFile.id,
        fileName: this.selectedPreviousFile.name
      },
      prompts: this.optionalPrompts,
      mode: this.uploadMode
    });

    this.startProcessing(this.selectedPreviousFile.name);

    const request: GenerateRequest = {
      fileID: this.selectedPreviousFile.id,
      optional_prompt: this.optionalPrompts,
      model_name: this.selectedModel
    };

    this.generateAnalysis(request);
  }
}











private onProgressComplete(): void {
  this.stopPolling();

  // Update the history item status to completed
  const fileId = this.uploadMode === 'new'
    ? this.uploadedFilesWithStatus.find(f => f.file.name === this.selectedUploadFile?.name)?.uploadedFileId
    : this.selectedPreviousFile?.id;

  // Emit completion event to update status and load results
  this.onGenerate.emit({
    file: {
      fileID: fileId,
      fileName: this.uploadMode === 'new' ? this.selectedUploadFile?.name : this.selectedPreviousFile?.name,
      isComplete: true  // Add this flag to indicate completion
    },
    prompts: this.optionalPrompts,
    mode: this.uploadMode
  });

  setTimeout(() => {
    this.completeProcessing();
  }, 500);
}











onGenerateComplete(data: { file: any, prompts: string, mode: string }): void {
  const fileId = data.file.fileID.toString();
  const isComplete = data.file.isComplete || false;  // Check if this is completion event

  // Check if item already exists in history
  const existingItem = this.historyComponent?.historyItems.find((i: any) => i.id === fileId);

  if (isComplete) {
    // This is a completion event - update to completed status
    if (existingItem) {
      this.historyComponent.updateItemStatus(fileId, 'completed');
      this.selectedHistoryItem = existingItem;
      this.loadResultsForItem(fileId);
    }
    return;
  }

  if (existingItem) {
    // Item already exists, update its status to in-progress
    this.historyComponent.updateItemStatus(fileId, 'in-progress');
    this.selectedHistoryItem = existingItem;
    // Clear results while processing
    this.resultItems = [];
    return;
  }

  // Create new item with in-progress status
  const newItem = {
    id: fileId,
    name: data.file.fileName,
    displayDate: 'Created on ' + new Date().toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }),
    date: new Date(),
    progress: 'in progress',
    status: 'in-progress' as 'not-generated' | 'in-progress' | 'completed',
    isClickable: false  // Not clickable until completed
  };

  // Add to history
  if (this.historyComponent) {
    this.historyComponent.addHistoryItem(newItem);
  }

  // Set as selected but don't load results yet
  this.selectedHistoryItem = newItem;
  this.resultItems = [];
}
















/**
 * Update the status of an existing history item
 */
updateItemStatus(itemId: string, newStatus: 'not-generated' | 'in-progress' | 'completed'): void {
  // Find item in historyItems
  const item = this.historyItems.find(i => i.id === itemId);
  if (item) {
    item.status = newStatus;
    item.progress = newStatus === 'completed' ? 'completed' : 'in progress';
    item.isClickable = newStatus === 'completed';
    
    // Update filtered list
    this.filterHistory();
  }
}
