import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';

interface FileConfig {
  file_name: string;
  original_code: string;
  modified_code: string;
}

@Component({
  selector: 'app-diff-viewer-modal',
  templateUrl: './diff-viewer-modal.component.html',
  styleUrls: ['./diff-viewer-modal.component.css']
})
export class DiffViewerModalComponent implements OnInit {
  @Input() isOpen: boolean = false;
  @Input() files: FileConfig[] = [];
  @Output() close = new EventEmitter<void>();
  @Output() onAcceptAll = new EventEmitter<FileConfig[]>();
  @Output() onRejectAll = new EventEmitter<FileConfig[]>();
  @Output() onFileAccepted = new EventEmitter<{ file: FileConfig, index: number }>();
  @Output() onFileRejected = new EventEmitter<{ file: FileConfig, index: number }>();

  ngOnInit(): void {
    // Listen for escape key to close modal
    document.addEventListener('keydown', this.handleEscapeKey.bind(this));
  }

  ngOnDestroy(): void {
    document.removeEventListener('keydown', this.handleEscapeKey.bind(this));
  }

  handleEscapeKey(event: KeyboardEvent): void {
    if (event.key === 'Escape' && this.isOpen) {
      this.closeModal();
    }
  }

  closeModal(): void {
    this.close.emit();
  }

  handleBackdropClick(event: MouseEvent): void {
    // Close modal when clicking on backdrop (not on modal content)
    if ((event.target as HTMLElement).classList.contains('code-rag-modal-backdrop')) {
      this.closeModal();
    }
  }

  handleAcceptAll(): void {
    this.onAcceptAll.emit(this.files);
  }

  handleRejectAll(): void {
    this.onRejectAll.emit(this.files);
  }

  handleFileAccepted(data: { file: FileConfig, index: number }): void {
    this.onFileAccepted.emit(data);
  }

  handleFileRejected(data: { file: FileConfig, index: number }): void {
    this.onFileRejected.emit(data);
  }
}















<div class="code-rag-modal-backdrop" *ngIf="isOpen" (click)="handleBackdropClick($event)">
  <div class="code-rag-modal-container">
    <!-- Modal Header -->
    <div class="code-rag-modal-header">
      <h2 class="code-rag-modal-title">Review Code Changes</h2>
      <button class="code-rag-modal-close" (click)="closeModal()" aria-label="Close">
        Ã—
      </button>
    </div>

    <!-- Modal Body with Diff Viewer -->
    <div class="code-rag-modal-body">
      <app-diff-viewer 
        [files]="files"
        (onAcceptAll)="handleAcceptAll()"
        (onRejectAll)="handleRejectAll()"
        (onFileAccepted)="handleFileAccepted($event)"
        (onFileRejected)="handleFileRejected($event)">
      </app-diff-viewer>
    </div>
  </div>
</div>








.code-rag-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
    animation: fadeIn 0.3s ease;
    overflow-y: auto;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.code-rag-modal-container {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 1400px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    animation: slideIn 0.3s ease;
    margin: auto;
}

@keyframes slideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.code-rag-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 2px solid #d0d7de;
    background: #f6f8fa;
    border-radius: 12px 12px 0 0;
}

.code-rag-modal-title {
    font-size: 20px;
    font-weight: 600;
    color: #24292e;
    margin: 0;
}

.code-rag-modal-close {
    background: transparent;
    border: none;
    font-size: 32px;
    line-height: 1;
    color: #57606a;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.code-rag-modal-close:hover {
    background: #d0d7de;
    color: #24292e;
}

.code-rag-modal-body {
    overflow-y: auto;
    flex: 1;
    padding: 0;
}

/* Override wrapper styles for modal */
.code-rag-modal-body ::ng-deep .code-rag-wrapper {
    box-shadow: none;
    border: none;
    border-radius: 0;
    max-width: 100%;
}

/* Adjust padding for modal context */
.code-rag-modal-body ::ng-deep .code-rag-top-section {
    margin: 20px 20px 15px 20px;
}

.code-rag-modal-body ::ng-deep .code-rag-files-container {
    padding: 0 20px 20px 20px;
}

@media (max-width: 768px) {
    .code-rag-modal-backdrop {
        padding: 10px;
    }

    .code-rag-modal-container {
        max-height: 95vh;
    }

    .code-rag-modal-header {
        padding: 15px 20px;
    }

    .code-rag-modal-title {
        font-size: 18px;
    }

    .code-rag-modal-close {
        font-size: 28px;
        width: 28px;
        height: 28px;
    }
}











import { Component, OnInit, Input, Output, EventEmitter } from '@angular/core';
import * as Diff from 'diff';
import * as hljs from 'highlight.js';

interface FileConfig {
  file_name: string;
  original_code: string;
  modified_code: string;
}

interface FileState {
  addedCount: number;
  removedCount: number;
}

interface DiffLine {
  type: 'added' | 'removed' | 'context';
  content: string;
  oldLineNum: number | null;
  newLineNum: number | null;
  highlightedContent: string;
}

@Component({
  selector: 'app-diff-viewer',
  templateUrl: './diff-viewer.component.html',
  styleUrls: ['./diff-viewer.component.css']
})
export class DiffViewerComponent implements OnInit {
  @Input() files: FileConfig[] = [];
  
  // Output events for modal integration
  @Output() onAcceptAll = new EventEmitter<void>();
  @Output() onRejectAll = new EventEmitter<void>();
  @Output() onFileAccepted = new EventEmitter<{ file: FileConfig, index: number }>();
  @Output() onFileRejected = new EventEmitter<{ file: FileConfig, index: number }>();

  acceptedFiles: Set<number> = new Set();
  rejectedFiles: Set<number> = new Set();
  fileStates: FileState[] = [];
  processedDiffs: Map<number, { lines: DiffLine[], isNewFile: boolean }> = new Map();

  ngOnInit(): void {
    this.processAllFiles();
  }

  ngOnChanges(): void {
    this.processAllFiles();
  }

  processAllFiles(): void {
    this.files.forEach((file, index) => {
      const isNewFile = !file.original_code || file.original_code.trim() === '';
      
      if (isNewFile) {
        const lines = this.processNewFile(file);
        this.processedDiffs.set(index, { lines, isNewFile: true });
        this.fileStates[index] = { addedCount: lines.length, removedCount: 0 };
      } else {
        const lines = this.processDiff(file);
        const addedCount = lines.filter(l => l.type === 'added').length;
        const removedCount = lines.filter(l => l.type === 'removed').length;
        this.processedDiffs.set(index, { lines, isNewFile: false });
        this.fileStates[index] = { addedCount, removedCount };
      }
    });
  }

  processNewFile(file: FileConfig): DiffLine[] {
    const lines = file.modified_code.split('\n');
    const diffLines: DiffLine[] = [];
    
    lines.forEach((line, index) => {
      diffLines.push({
        type: 'added',
        content: line,
        oldLineNum: null,
        newLineNum: index + 1,
        highlightedContent: this.highlightCode(line, file.file_name)
      });
    });
    
    return diffLines;
  }

  processDiff(file: FileConfig): DiffLine[] {
    const diff = Diff.diffLines(file.original_code, file.modified_code);
    const diffLines: DiffLine[] = [];
    let oldLineNum = 1;
    let newLineNum = 1;

    diff.forEach(part => {
      const lines = part.value.split('\n');
      if (lines[lines.length - 1] === '') {
        lines.pop();
      }

      lines.forEach(line => {
        if (part.added) {
          diffLines.push({
            type: 'added',
            content: line,
            oldLineNum: null,
            newLineNum: newLineNum++,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        } else if (part.removed) {
          diffLines.push({
            type: 'removed',
            content: line,
            oldLineNum: oldLineNum++,
            newLineNum: null,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        } else {
          diffLines.push({
            type: 'context',
            content: line,
            oldLineNum: oldLineNum++,
            newLineNum: newLineNum++,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        }
      });
    });

    return diffLines;
  }

  highlightCode(code: string, fileName: string): string {
    try {
      const lang = this.detectLanguage(fileName);
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      } else {
        return hljs.highlightAuto(code).value;
      }
    } catch (e) {
      console.error('Highlighting error:', e);
      return this.escapeHtml(code);
    }
  }

  detectLanguage(fileName: string): string {
    const extension = fileName.split('.').pop()?.toLowerCase() || '';
    const languageMap: { [key: string]: string } = {
      'js': 'javascript',
      'jsx': 'javascript',
      'ts': 'typescript',
      'tsx': 'typescript',
      'py': 'python',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'cpp',
      'h': 'cpp',
      'hpp': 'cpp',
      'css': 'css',
      'html': 'html',
      'php': 'php',
      'rb': 'ruby',
      'go': 'go',
      'rs': 'rust',
      'sh': 'bash',
      'json': 'json',
      'xml': 'xml',
      'sql': 'sql'
    };
    return languageMap[extension] || 'plaintext';
  }

  escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  acceptFile(index: number): void {
    console.log(`File ${index} accepted:`, this.files[index].file_name);
    console.log('Applied code:', this.files[index].modified_code);
    this.acceptedFiles.add(index);
    
    // Emit event for modal
    this.onFileAccepted.emit({ file: this.files[index], index });
  }

  rejectFile(index: number): void {
    console.log(`File ${index} rejected:`, this.files[index].file_name);
    console.log('Keeping original code:', this.files[index].original_code);
    this.rejectedFiles.add(index);
    
    // Emit event for modal
    this.onFileRejected.emit({ file: this.files[index], index });
  }

  acceptAll(): void {
    console.log('All files accepted');
    this.files.forEach((file, index) => {
      console.log(`${file.file_name}: Applied code`, file.modified_code);
      this.acceptFile(index);
    });
    
    // Emit event for modal
    this.onAcceptAll.emit();
  }

  rejectAll(): void {
    console.log('All files rejected');
    this.files.forEach((file, index) => {
      console.log(`${file.file_name}: Keeping original code`, file.original_code);
      this.rejectFile(index);
    });
    
    // Emit event for modal
    this.onRejectAll.emit();
  }

  isFileAccepted(index: number): boolean {
    return this.acceptedFiles.has(index);
  }

  isFileRejected(index: number): boolean {
    return this.rejectedFiles.has(index);
  }

  isFileProcessed(index: number): boolean {
    return this.isFileAccepted(index) || this.isFileRejected(index);
  }

  allFilesProcessed(): boolean {
    return (this.acceptedFiles.size + this.rejectedFiles.size) === this.files.length;
  }

  getDiffLines(index: number): DiffLine[] {
    return this.processedDiffs.get(index)?.lines || [];
  }

  isNewFile(index: number): boolean {
    return this.processedDiffs.get(index)?.isNewFile || false;
  }

  getFileState(index: number): FileState {
    return this.fileStates[index] || { addedCount: 0, removedCount: 0 };
  }
}











// example-modal-usage.component.ts
import { Component } from '@angular/core';

interface FileConfig {
  file_name: string;
  original_code: string;
  modified_code: string;
}

@Component({
  selector: 'app-example-modal-usage',
  template: `
    <div style="padding: 40px;">
      <h1>Diff Viewer Modal Example</h1>
      <p>Click the button below to open the diff viewer in a modal:</p>
      
      <button 
        (click)="openModal()" 
        style="padding: 12px 24px; background: #0366d6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
        Open Diff Viewer Modal
      </button>

      <!-- Modal Component -->
      <app-diff-viewer-modal
        [isOpen]="isModalOpen"
        [files]="fileChanges"
        (close)="closeModal()"
        (onAcceptAll)="handleAcceptAll()"
        (onRejectAll)="handleRejectAll()"
        (onFileAccepted)="handleFileAccepted($event)"
        (onFileRejected)="handleFileRejected($event)">
      </app-diff-viewer-modal>

      <!-- Status Display -->
      <div *ngIf="statusMessage" style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #0366d6; border-radius: 4px;">
        <strong>Status:</strong> {{ statusMessage }}
      </div>
    </div>
  `,
  styles: [`
    h1 {
      color: #24292e;
      margin-bottom: 10px;
    }
    p {
      color: #57606a;
      margin-bottom: 20px;
    }
  `]
})
export class ExampleModalUsageComponent {
  isModalOpen = false;
  statusMessage = '';

  fileChanges: FileConfig[] = [
    {
      file_name: 'example.js',
      original_code: `function calculateSum(a, b) {
    return a + b;
}

function greet(name) {
    console.log("Hello " + name);
}

const result = calculateSum(5, 3);`,
      modified_code: `function calculateSum(a, b) {
    // Added validation
    if (typeof a !== 'number' || typeof b !== 'number') {
        throw new Error('Invalid input');
    }
    return a + b;
}

function greet(name) {
    console.log(\`Hello \${name}!\`);
}

const result = calculateSum(5, 3);
console.log('Result:', result);`
    },
    {
      file_name: 'utils.py',
      original_code: `def add(x, y):
    return x + y

def multiply(x, y):
    return x * y`,
      modified_code: `def add(x, y):
    """Add two numbers"""
    if not isinstance(x, (int, float)) or not isinstance(y, (int, float)):
        raise TypeError("Arguments must be numbers")
    return x + y

def multiply(x, y):
    """Multiply two numbers"""
    return x * y

def subtract(x, y):
    """Subtract y from x"""
    return x - y`
    },
    {
      file_name: 'newfile.ts',
      original_code: '',  // Empty means new file
      modified_code: `export interface User {
    id: number;
    name: string;
    email: string;
}

export class UserService {
    getUser(id: number): User {
        return { id, name: 'John', email: 'john@example.com' };
    }
}`
    }
  ];

  openModal(): void {
    this.isModalOpen = true;
    this.statusMessage = '';
  }

  closeModal(): void {
    this.isModalOpen = false;
  }

  handleAcceptAll(): void {
    this.statusMessage = 'All files accepted!';
    console.log('All files accepted');
    
    // You can add your logic here, e.g., send to API
    // this.apiService.acceptAllChanges(this.fileChanges).subscribe(...);
    
    // Optionally close modal after a delay
    setTimeout(() => {
      this.closeModal();
    }, 2000);
  }

  handleRejectAll(): void {
    this.statusMessage = 'All files rejected!';
    console.log('All files rejected');
    
    // You can add your logic here
    // this.apiService.rejectAllChanges(this.fileChanges).subscribe(...);
    
    // Optionally close modal after a delay
    setTimeout(() => {
      this.closeModal();
    }, 2000);
  }

  handleFileAccepted(event: { file: FileConfig, index: number }): void {
    this.statusMessage = `File "${event.file.file_name}" accepted!`;
    console.log('File accepted:', event.file.file_name);
    
    // You can add your logic here
    // this.apiService.acceptFile(event.file).subscribe(...);
  }

  handleFileRejected(event: { file: FileConfig, index: number }): void {
    this.statusMessage = `File "${event.file.file_name}" rejected!`;
    console.log('File rejected:', event.file.file_name);
    
    // You can add your logic here
    // this.apiService.rejectFile(event.file).subscribe(...);
  }
}
