import { Component, OnInit, Input, Output, EventEmitter, HostListener } from '@angular/core';
import { CommonModule } from '@angular/common';

interface FileItem {
  name: string;
  type: 'file' | 'folder';
  children?: FileItem[];
}

@Component({
  selector: 'app-file-explorer',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './file-explorer.component.html',
  styleUrls: ['./file-explorer.component.css']
})
export class FileExplorerComponent implements OnInit {
  @Input() fileStructure: FileItem[] = [];
  @Input() theme: 'light' | 'dark' = 'light';
  @Output() fileSelected = new EventEmitter<{ name: string; path: string[] }>();

  currentPath: string[] = [];
  currentItems: FileItem[] = [];
  selectedFile: string | null = null;
  private focusedIndex: number = -1;

  ngOnInit(): void {
    this.currentItems = this.fileStructure;
  }

  ngOnChanges(): void {
    if (this.fileStructure && this.fileStructure.length > 0) {
      this.currentItems = this.fileStructure;
    }
  }

  navigateIntoFolder(folder: FileItem): void {
    if (folder.type === 'folder') {
      this.currentPath.push(folder.name);
      this.currentItems = folder.children || [];
      this.selectedFile = null;
      this.focusedIndex = -1;
    }
  }

  navigateToPath(index: number): void {
    if (index === -1) {
      // Navigate to root
      this.currentPath = [];
      this.currentItems = this.fileStructure;
    } else {
      // Navigate to specific path level
      this.currentPath = this.currentPath.slice(0, index + 1);
      let items = this.fileStructure;
      
      for (let i = 0; i <= index; i++) {
        const folderName = this.currentPath[i];
        const folder = items.find(item => item.name === folderName && item.type === 'folder');
        if (folder && folder.children) {
          items = folder.children;
        } else {
          items = [];
          break;
        }
      }
      
      this.currentItems = items;
    }
    this.selectedFile = null;
    this.focusedIndex = -1;
  }

  selectFile(item: FileItem): void {
    if (item.type === 'file') {
      this.selectedFile = item.name;
      this.fileSelected.emit({
        name: item.name,
        path: [...this.currentPath, item.name]
      });
    }
  }

  // Keyboard navigation
  @HostListener('document:keydown', ['$event'])
  handleKeyboardNavigation(event: KeyboardEvent): void {
    if (this.currentItems.length === 0) return;

    switch(event.key) {
      case 'ArrowDown':
        event.preventDefault();
        this.focusedIndex = Math.min(this.focusedIndex + 1, this.currentItems.length - 1);
        this.focusItem(this.focusedIndex);
        break;
      case 'ArrowUp':
        event.preventDefault();
        this.focusedIndex = Math.max(this.focusedIndex - 1, 0);
        this.focusItem(this.focusedIndex);
        break;
      case 'Backspace':
        if (this.currentPath.length > 0) {
          event.preventDefault();
          this.navigateToPath(this.currentPath.length - 2);
        }
        break;
    }
  }

  private focusItem(index: number): void {
    const items = document.querySelectorAll('.sidebar-item');
    if (items[index]) {
      (items[index] as HTMLElement).focus();
    }
  }

  getFileIcon(filename: string): string {
    return '';
  }

  trackByIndex(index: number): number {
    return index;
  }
}

















<div class="file-explorer-container" [attr.data-theme]="theme">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">File Explorer</div>
      <nav class="breadcrumb" role="navigation" aria-label="Breadcrumb">
        <span 
          class="breadcrumb-item" 
          [class.current]="currentPath.length === 0"
          (click)="navigateToPath(-1)"
          (keydown.enter)="navigateToPath(-1)"
          (keydown.space)="$event.preventDefault(); navigateToPath(-1)"
          tabindex="0"
          role="button"
          [attr.aria-current]="currentPath.length === 0 ? 'page' : null">
          Root
        </span>
        
        <ng-container *ngFor="let pathItem of currentPath; let i = index">
          <span class="breadcrumb-separator" aria-hidden="true">/</span>
          <span 
            class="breadcrumb-item" 
            [class.current]="i === currentPath.length - 1"
            (click)="i < currentPath.length - 1 ? navigateToPath(i) : null"
            (keydown.enter)="i < currentPath.length - 1 ? navigateToPath(i) : null"
            (keydown.space)="$event.preventDefault(); i < currentPath.length - 1 ? navigateToPath(i) : null"
            [tabindex]="i < currentPath.length - 1 ? 0 : -1"
            [attr.role]="i < currentPath.length - 1 ? 'button' : null"
            [attr.aria-current]="i === currentPath.length - 1 ? 'page' : null">
            {{ pathItem }}
          </span>
        </ng-container>
      </nav>
    </div>
    
    <div class="sidebar-content" role="list">
      <div *ngIf="currentItems.length === 0" class="empty-sidebar">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 8px;">
          <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
        </svg>
        <div>No items in this folder</div>
      </div>
      
      <div 
        *ngFor="let item of currentItems; trackBy: trackByIndex"
        class="sidebar-item"
        [class.folder]="item.type === 'folder'"
        [class.selected]="item.type === 'file' && selectedFile === item.name"
        (click)="item.type === 'folder' ? navigateIntoFolder(item) : selectFile(item)"
        (keydown.enter)="item.type === 'folder' ? navigateIntoFolder(item) : selectFile(item)"
        (keydown.space)="$event.preventDefault(); item.type === 'folder' ? navigateIntoFolder(item) : selectFile(item)"
        tabindex="0"
        role="listitem"
        [attr.aria-label]="item.type === 'folder' ? 'Folder: ' + item.name : 'File: ' + item.name">
        <div class="icon" aria-hidden="true">
          <ng-container *ngIf="item.type === 'folder'">üìÅ</ng-container>
          <svg *ngIf="item.type === 'file'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
        </div>
        <div class="name">{{ item.name }}</div>
      </div>
    </div>
  </div>
</div>















/* Light Mode Variables */
:host {
  --code-rag-documentation-bg-primary: #ffffff;
  --code-rag-documentation-bg-secondary: #f5f5f5;
  --code-rag-documentation-bg-header: #e8e8e8;
  --code-rag-documentation-bg-hover: #e0e0e0;
  --code-rag-documentation-bg-hover-breadcrumb: #d8d8d8;
  --code-rag-documentation-border: #ddd;
  --code-rag-documentation-text-primary: #333;
  --code-rag-documentation-text-secondary: #666;
  --code-rag-documentation-text-link: #0066cc;
  --code-rag-documentation-text-muted: #999;
}

/* Dark Mode Variables */
.file-explorer-container[data-theme="dark"] {
  --code-rag-documentation-bg-primary: #1a1a1c;
  --code-rag-documentation-bg-secondary: #111113;
  --code-rag-documentation-bg-header: #1e1e20;
  --code-rag-documentation-bg-hover: #2a2a2c;
  --code-rag-documentation-bg-hover-breadcrumb: #333335;
  --code-rag-documentation-border: #2a2a2c;
  --code-rag-documentation-text-primary: #e0e0e0;
  --code-rag-documentation-text-secondary: #b0b0b0;
  --code-rag-documentation-text-link: #4da6ff;
  --code-rag-documentation-text-muted: #808080;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.file-explorer-container {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  height: 100vh;
  display: flex;
  background-color: var(--code-rag-documentation-bg-primary);
  font-size: 0.875rem; /* 14px */
}

/* Sidebar Styles */
.sidebar {
  width: 320px;
  background-color: var(--code-rag-documentation-bg-secondary);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--code-rag-documentation-border);
}

.sidebar-header {
  padding: 10px;
  background-color: var(--code-rag-documentation-bg-header);
  border-bottom: 1px solid var(--code-rag-documentation-border);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  position: sticky;
  top: 0;
  z-index: 10;
}

.sidebar-title {
  font-weight: 500;
  font-size: 0.8125rem; /* 13px */
  color: var(--code-rag-documentation-text-primary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.75rem; /* 12px */
  flex-wrap: wrap;
  line-height: 1.4;
}

.breadcrumb-item {
  color: var(--code-rag-documentation-text-link);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
  position: relative;
}

.breadcrumb-item:not(.current):hover {
  background-color: var(--code-rag-documentation-bg-hover-breadcrumb);
  transform: translateY(-1px);
}

.breadcrumb-item:not(.current):active {
  transform: translateY(0);
}

.breadcrumb-item.current {
  color: var(--code-rag-documentation-text-primary);
  font-weight: 450;
  cursor: default;
  background-color: var(--code-rag-documentation-bg-hover-breadcrumb);
}

.breadcrumb-separator {
  color: var(--code-rag-documentation-text-muted);
  font-size: 0.75rem; /* 12px */
  opacity: 0.6;
}

.sidebar-content {
  flex: 1;
  padding: 6px;
  overflow-y: auto;
  animation: slideIn 0.2s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.sidebar-item {
  padding: 7px 10px;
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 8px;
  border-radius: 4px;
  margin: 2px 0;
  transition: all 0.2s ease;
  color: var(--code-rag-documentation-text-primary);
  font-size: 0.8125rem; /* 13px */
  line-height: 1.4;
  position: relative;
}

.sidebar-item:hover {
  background-color: var(--code-rag-documentation-bg-hover);
  transform: translateX(2px);
  padding-left: 12px;
}

.sidebar-item.folder {
  font-weight: 450;
}

.sidebar-item.folder:hover .icon {
  transform: scale(1.1);
}

.sidebar-item.folder:active .icon {
  transform: scale(0.95);
}

.sidebar-item.selected {
  background-color: var(--code-rag-documentation-bg-hover);
  border-left: 3px solid var(--code-rag-documentation-text-link);
  padding-left: 7px;
  font-weight: 500;
}

.sidebar-item .icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9375rem; /* 15px */
  flex-shrink: 0;
  transition: transform 0.2s ease;
}

.sidebar-item .icon svg {
  transition: all 0.2s ease;
}

.sidebar-item:hover .icon svg {
  stroke: var(--code-rag-documentation-text-link);
}

.sidebar-item .name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.empty-sidebar {
  text-align: center;
  color: var(--code-rag-documentation-text-muted);
  padding: 40px 12px;
  font-size: 0.75rem; /* 12px */
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Active/Focus states for accessibility */
.sidebar-item:focus-visible,
.breadcrumb-item:focus-visible {
  outline: 2px solid var(--code-rag-documentation-text-link);
  outline-offset: 2px;
}

/* Folder indicator */
.sidebar-item.folder::after {
  content: '';
  margin-left: auto;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.sidebar-item.folder:hover::after {
  opacity: 0.3;
  background-color: var(--code-rag-documentation-text-link);
}

/* Scrollbar Styles */
.sidebar::-webkit-scrollbar,
.sidebar-content::-webkit-scrollbar {
  width: 8px;
}

.sidebar::-webkit-scrollbar-track,
.sidebar-content::-webkit-scrollbar-track {
  background: var(--code-rag-documentation-bg-secondary);
}

.sidebar::-webkit-scrollbar-thumb,
.sidebar-content::-webkit-scrollbar-thumb {
  background: var(--code-rag-documentation-text-muted);
  border-radius: 4px;
  transition: background 0.2s ease;
}

.sidebar::-webkit-scrollbar-thumb:hover,
.sidebar-content::-webkit-scrollbar-thumb:hover {
  background: var(--code-rag-documentation-text-secondary);
}
