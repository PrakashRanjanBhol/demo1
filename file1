import { Component, OnInit, Renderer2 } from '@angular/core';
import { CommonModule } from '@angular/common';

interface ChatSession {
  session_id: string;
  created_date: string;
  count: number;
  first_prompt: string;
  ps_session_id: number;
}

interface DayGroup {
  label: string;
  date: Date;
  chats: ChatSession[];
}

@Component({
  selector: 'app-chat-sessions',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './chat-sessions.component.html',
  styleUrls: ['./chat-sessions.component.css']
})
export class ChatSessionsComponent implements OnInit {
  chatData: ChatSession[] = [
    { session_id: 'abc1', created_date: '2025-01-10 14:30:00', count: 5, first_prompt: 'Write a Java code for sorting an array', ps_session_id: 1 },
    { session_id: 'abc2', created_date: '2025-01-10 09:15:00', count: 12, first_prompt: 'How to implement binary search in Python?', ps_session_id: 2 },
    { session_id: 'abc3', created_date: '2025-01-09 16:45:00', count: 3, first_prompt: 'Explain React hooks', ps_session_id: 3 },
    { session_id: 'abc4', created_date: '2025-01-09 11:20:00', count: 8, first_prompt: 'Create a REST API with Node.js', ps_session_id: 4 },
    { session_id: 'abc5', created_date: '2025-01-08 13:10:00', count: 15, first_prompt: 'Database optimization techniques', ps_session_id: 5 },
    { session_id: 'abc6', created_date: '2025-01-08 10:30:00', count: 6, first_prompt: 'CSS Grid layout tutorial', ps_session_id: 6 },
    { session_id: 'abc7', created_date: '2025-01-07 15:20:00', count: 9, first_prompt: 'Machine learning basics', ps_session_id: 7 },
    { session_id: 'abc8', created_date: '2025-01-06 08:45:00', count: 4, first_prompt: 'Docker container setup', ps_session_id: 8 },
  ];

  groupedChats: DayGroup[] = [];
  selectedChats = new Set<string>();
  isSelectionMode = false;
  activeChatId: string | null = null;

  constructor(private renderer: Renderer2) {}

  ngOnInit(): void {
    this.renderChatHistory();
  }

  renderChatHistory(): void {
    if (!this.chatData || this.chatData.length === 0) {
      this.groupedChats = [];
      return;
    }

    const sortedChats = [...this.chatData].sort((a, b) => {
      return new Date(b.created_date).getTime() - new Date(a.created_date).getTime();
    });

    this.groupedChats = this.groupChatsByDay(sortedChats);
  }

  groupChatsByDay(chats: ChatSession[]): DayGroup[] {
    const groups: { [key: string]: DayGroup } = {};
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    chats.forEach(chat => {
      const chatDate = new Date(chat.created_date);
      chatDate.setHours(0, 0, 0, 0);

      let label: string;
      const timeDiff = today.getTime() - chatDate.getTime();
      const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

      if (daysDiff === 0) {
        label = 'Today';
      } else if (daysDiff === 1) {
        label = 'Yesterday';
      } else {
        label = chatDate.toLocaleDateString('en-US', {
          month: 'long',
          day: '2-digit',
          year: 'numeric'
        });
      }

      if (!groups[label]) {
        groups[label] = {
          label,
          date: chatDate,
          chats: []
        };
      }
      groups[label].chats.push(chat);
    });

    return Object.values(groups).sort((a, b) => {
      return b.date.getTime() - a.date.getTime();
    });
  }

  formatTime(dateString: string): string {
    const date = new Date(dateString);
    return date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  }

  toggleSelectionMode(): void {
    this.isSelectionMode = !this.isSelectionMode;
    
    if (this.isSelectionMode) {
      this.renderer.addClass(document.body, 'selection-mode');
    } else {
      this.renderer.removeClass(document.body, 'selection-mode');
      this.selectedChats.clear();
    }
    
    console.log('Selection mode:', this.isSelectionMode ? 'ON' : 'OFF');
  }

  onChatClick(sessionId: string, event: Event): void {
    // Check if click is on action button
    const target = event.target as HTMLElement;
    if (target.closest('.action-btn')) {
      return;
    }

    if (this.isSelectionMode) {
      this.toggleChatSelection(sessionId);
    } else {
      this.activeChatId = sessionId;
      const chat = this.chatData.find(c => c.session_id === sessionId);
      console.log('Chat selected:', {
        session_id: sessionId,
        chat_name: chat?.first_prompt,
        ps_session_id: chat?.ps_session_id
      });
    }
  }

  toggleChatSelection(sessionId: string): void {
    if (this.selectedChats.has(sessionId)) {
      this.selectedChats.delete(sessionId);
    } else {
      this.selectedChats.add(sessionId);
    }
  }

  isSelected(sessionId: string): boolean {
    return this.selectedChats.has(sessionId);
  }

  isActive(sessionId: string): boolean {
    return this.activeChatId === sessionId;
  }

  toggleSelectAll(): void {
    const allChatIds = this.chatData.map(chat => chat.session_id);
    const allSelected = allChatIds.every(id => this.selectedChats.has(id));

    if (allSelected) {
      this.selectedChats.clear();
      console.log('Deselected all chats');
    } else {
      allChatIds.forEach(id => this.selectedChats.add(id));
      console.log('Selected all chats:', Array.from(this.selectedChats));
    }
  }

  get selectedCount(): number {
    return this.selectedChats.size;
  }

  get selectAllLinkText(): string {
    const allChatIds = this.chatData.map(chat => chat.session_id);
    const allSelected = allChatIds.every(id => this.selectedChats.has(id));
    return allSelected ? 'Deselect all' : 'Select all';
  }

  handleEdit(sessionId: string, event: Event): void {
    event.stopPropagation();
    const chat = this.chatData.find(c => c.session_id === sessionId);
    console.log('Edit clicked for:', {
      session_id: sessionId,
      chat_name: chat?.first_prompt,
      ps_session_id: chat?.ps_session_id
    });
  }

  handleShare(sessionId: string, event: Event): void {
    event.stopPropagation();
    const chat = this.chatData.find(c => c.session_id === sessionId);
    console.log('Share clicked for:', {
      session_id: sessionId,
      chat_name: chat?.first_prompt,
      ps_session_id: chat?.ps_session_id
    });
  }

  handleDelete(sessionId: string, event: Event): void {
    event.stopPropagation();
    const chat = this.chatData.find(c => c.session_id === sessionId);
    console.log('Delete clicked for:', {
      session_id: sessionId,
      chat_name: chat?.first_prompt,
      ps_session_id: chat?.ps_session_id
    });
  }

  bulkDelete(): void {
    const selectedIds = Array.from(this.selectedChats);
    const selectedChatsData = this.chatData.filter(chat => this.selectedChats.has(chat.session_id));

    console.log('Bulk delete clicked:', {
      count: selectedIds.length,
      session_ids: selectedIds,
      chats: selectedChatsData.map(c => ({
        session_id: c.session_id,
        chat_name: c.first_prompt,
        ps_session_id: c.ps_session_id
      }))
    });
  }
}










/* ... keep all previous styles ... */

/* Add these new styles for selection mode */
body.selection-mode .chat-select-indicator {
  display: flex;
}

body.selection-mode .chat-item {
  padding-left: 16px;
}

body.selection-mode .chat-actions {
  display: none !important;
}

/* Update these existing styles */
.chat-select-indicator {
  width: 20px;
  height: 20px;
  border: 2px solid #3a3a3c;
  border-radius: 50%;
  flex-shrink: 0;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.chat-item.selected .chat-select-indicator {
  border-color: #8b5cf6;
  background: #8b5cf6;
}

.chat-select-indicator svg {
  width: 12px;
  height: 12px;
  color: white;
  display: none;
}

.chat-item.selected .chat-select-indicator svg {
  display: block;
}
