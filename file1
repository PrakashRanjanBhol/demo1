import { Injectable } from '@angular/core';
import { Router, CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot } from '@angular/router';
import { AuthService } from '../services/auth.service';

@Injectable({
  providedIn: 'root'
})
export class AuthGuard implements CanActivate {
  constructor(
    private router: Router,
    private authService: AuthService
  ) {}

  canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): boolean {
    const currentUser = this.authService.currentUserValue;
    
    if (currentUser) {
      // User is authenticated
      return true;
    }

    // Not authenticated - block access and return false
    return false;
  }
}









ngOnInit(): void {
  // Always attempt SSO login on page load/refresh
  this.attemptAutoSSO();

  // Load saved theme from localStorage
  const savedTheme = localStorage.getItem('theme') as 'light' | 'dark';
  if (savedTheme) {
    this.currentTheme = savedTheme;
    this.applyTheme(savedTheme);
  }

  // Load sidebar state from localStorage
  const savedSidebarState = localStorage.getItem('sidebarCollapsed');
  if (savedSidebarState !== null) {
    this.isSidebarCollapsed = savedSidebarState === 'true';
  }

  // Subscribe to current user changes
  this.authService.currentUser.subscribe(user => {
    this.currentUser = user;
    this.isAuthenticated = user !== null;
    
    // If user becomes authenticated and current route is blocked, navigate to content-analytics
    if (user && this.router.url === '/') {
      this.router.navigate(['/content-analytics']);
    }
  });
}

// Attempt automatic SSO login
private attemptAutoSSO(): void {
  const currentUrl = this.router.url;
  
  this.authService.initiateSSO().subscribe({
    next: (response) => {
      console.log('Auto SSO login successful:', response);
      this.isAuthenticated = true;
      this.currentUser = response.user || this.authService.currentUserValue;
      
      // Navigate to intended URL or default to content-analytics
      if (currentUrl === '/' || currentUrl === '/sso-connect') {
        this.router.navigate(['/content-analytics']);
      } else {
        this.router.navigate([currentUrl]);
      }
    },
    error: (error) => {
      console.error('Auto SSO login failed:', error);
      this.isAuthenticated = false;
      this.currentUser = null;
      // Redirect to SSO connect page on failure
      this.router.navigate(['/sso-connect'], { replaceUrl: true });
    }
  });
}
