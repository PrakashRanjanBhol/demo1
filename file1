import { Component, OnInit, Input } from '@angular/core';
import * as Diff from 'diff';
import * as hljs from 'highlight.js';

interface FileConfig {
  file_name: string;
  original_code: string;
  modified_code: string;
}

interface FileState {
  addedCount: number;
  removedCount: number;
}

interface DiffLine {
  type: 'added' | 'removed' | 'context';
  content: string;
  oldLineNum: number | null;
  newLineNum: number | null;
  highlightedContent: string;
}

@Component({
  selector: 'app-diff-viewer',
  templateUrl: './diff-viewer.component.html',
  styleUrls: ['./diff-viewer.component.css']
})
export class DiffViewerComponent implements OnInit {
  @Input() files: FileConfig[] = [];

  acceptedFiles: Set<number> = new Set();
  rejectedFiles: Set<number> = new Set();
  fileStates: FileState[] = [];
  processedDiffs: Map<number, { lines: DiffLine[], isNewFile: boolean }> = new Map();

  ngOnInit(): void {
    this.processAllFiles();
  }

  ngOnChanges(): void {
    this.processAllFiles();
  }

  processAllFiles(): void {
    this.files.forEach((file, index) => {
      const isNewFile = !file.original_code || file.original_code.trim() === '';
      
      if (isNewFile) {
        const lines = this.processNewFile(file);
        this.processedDiffs.set(index, { lines, isNewFile: true });
        this.fileStates[index] = { addedCount: lines.length, removedCount: 0 };
      } else {
        const lines = this.processDiff(file);
        const addedCount = lines.filter(l => l.type === 'added').length;
        const removedCount = lines.filter(l => l.type === 'removed').length;
        this.processedDiffs.set(index, { lines, isNewFile: false });
        this.fileStates[index] = { addedCount, removedCount };
      }
    });
  }

  processNewFile(file: FileConfig): DiffLine[] {
    const lines = file.modified_code.split('\n');
    const diffLines: DiffLine[] = [];
    
    lines.forEach((line, index) => {
      diffLines.push({
        type: 'added',
        content: line,
        oldLineNum: null,
        newLineNum: index + 1,
        highlightedContent: this.highlightCode(line, file.file_name)
      });
    });
    
    return diffLines;
  }

  processDiff(file: FileConfig): DiffLine[] {
    const diff = Diff.diffLines(file.original_code, file.modified_code);
    const diffLines: DiffLine[] = [];
    let oldLineNum = 1;
    let newLineNum = 1;

    diff.forEach(part => {
      const lines = part.value.split('\n');
      if (lines[lines.length - 1] === '') {
        lines.pop();
      }

      lines.forEach(line => {
        if (part.added) {
          diffLines.push({
            type: 'added',
            content: line,
            oldLineNum: null,
            newLineNum: newLineNum++,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        } else if (part.removed) {
          diffLines.push({
            type: 'removed',
            content: line,
            oldLineNum: oldLineNum++,
            newLineNum: null,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        } else {
          diffLines.push({
            type: 'context',
            content: line,
            oldLineNum: oldLineNum++,
            newLineNum: newLineNum++,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        }
      });
    });

    return diffLines;
  }

  highlightCode(code: string, fileName: string): string {
    try {
      const lang = this.detectLanguage(fileName);
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      } else {
        return hljs.highlightAuto(code).value;
      }
    } catch (e) {
      console.error('Highlighting error:', e);
      return this.escapeHtml(code);
    }
  }

  detectLanguage(fileName: string): string {
    const extension = fileName.split('.').pop()?.toLowerCase() || '';
    const languageMap: { [key: string]: string } = {
      'js': 'javascript',
      'jsx': 'javascript',
      'ts': 'typescript',
      'tsx': 'typescript',
      'py': 'python',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'cpp',
      'h': 'cpp',
      'hpp': 'cpp',
      'css': 'css',
      'html': 'html',
      'php': 'php',
      'rb': 'ruby',
      'go': 'go',
      'rs': 'rust',
      'sh': 'bash',
      'json': 'json',
      'xml': 'xml',
      'sql': 'sql'
    };
    return languageMap[extension] || 'plaintext';
  }

  escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  acceptFile(index: number): void {
    console.log(`File ${index} accepted:`, this.files[index].file_name);
    console.log('Applied code:', this.files[index].modified_code);
    this.acceptedFiles.add(index);
  }

  rejectFile(index: number): void {
    console.log(`File ${index} rejected:`, this.files[index].file_name);
    console.log('Keeping original code:', this.files[index].original_code);
    this.rejectedFiles.add(index);
  }

  acceptAll(): void {
    console.log('All files accepted');
    this.files.forEach((file, index) => {
      console.log(`${file.file_name}: Applied code`, file.modified_code);
      this.acceptFile(index);
    });
  }

  rejectAll(): void {
    console.log('All files rejected');
    this.files.forEach((file, index) => {
      console.log(`${file.file_name}: Keeping original code`, file.original_code);
      this.rejectFile(index);
    });
  }

  isFileAccepted(index: number): boolean {
    return this.acceptedFiles.has(index);
  }

  isFileRejected(index: number): boolean {
    return this.rejectedFiles.has(index);
  }

  isFileProcessed(index: number): boolean {
    return this.isFileAccepted(index) || this.isFileRejected(index);
  }

  allFilesProcessed(): boolean {
    return (this.acceptedFiles.size + this.rejectedFiles.size) === this.files.length;
  }

  getDiffLines(index: number): DiffLine[] {
    return this.processedDiffs.get(index)?.lines || [];
  }

  isNewFile(index: number): boolean {
    return this.processedDiffs.get(index)?.isNewFile || false;
  }

  getFileState(index: number): FileState {
    return this.fileStates[index] || { addedCount: 0, removedCount: 0 };
  }
}



















<div class="code-rag-wrapper">
  <!-- Top Section: Draft Header and Action Buttons -->
  <div class="code-rag-top-section" *ngIf="!allFilesProcessed()">
    <!-- Draft Header -->
    <div class="code-rag-draft-header">
      <div class="code-rag-draft-icon">‚ö†Ô∏è</div>
      <div class="code-rag-draft-text">
        <div class="code-rag-draft-title">Confirmation Required</div>
        <div class="code-rag-draft-subtitle">
          Review and approve changes for {{ files.length }} file{{ files.length > 1 ? 's' : '' }}
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="code-rag-top-actions">
      <button 
        class="code-rag-btn-small code-rag-btn-accept" 
        (click)="acceptAll()">
        Accept All
      </button>
      <button 
        class="code-rag-btn-small code-rag-btn-reject" 
        (click)="rejectAll()">
        Reject All
      </button>
    </div>
  </div>

  <!-- Files Container -->
  <div class="code-rag-files-container">
    <ng-container *ngFor="let file of files; let i = index">
      <!-- Accepted File Message -->
      <div class="code-rag-file-accepted" *ngIf="isFileAccepted(i)">
        <div class="code-rag-file-accepted-icon">‚úì</div>
        <div class="code-rag-file-accepted-text">Changes Accepted</div>
        <div class="code-rag-file-accepted-filename">{{ file.file_name }}</div>
      </div>

      <!-- Rejected File Message -->
      <div class="code-rag-file-rejected" *ngIf="isFileRejected(i)">
        <div class="code-rag-file-rejected-icon">‚úó</div>
        <div class="code-rag-file-rejected-text">Changes Rejected</div>
        <div class="code-rag-file-rejected-filename">{{ file.file_name }}</div>
      </div>

      <!-- File Block (not yet processed) -->
      <div class="code-rag-file-block" *ngIf="!isFileProcessed(i)">
        <!-- File Header -->
        <div class="code-rag-header">
          <div class="code-rag-file-info">
            <span class="code-rag-file-icon">üìÑ</span>
            <span>{{ file.file_name }}</span>
            <span class="code-rag-file-badge new" *ngIf="isNewFile(i)">New File</span>
          </div>
          <div class="code-rag-stats">
            <div class="code-rag-stat-item code-rag-stat-added">
              <span>++<span>{{ getFileState(i).addedCount }}</span></span>
            </div>
            <div class="code-rag-stat-item code-rag-stat-removed" *ngIf="!isNewFile(i)">
              <span>--<span>{{ getFileState(i).removedCount }}</span></span>
            </div>
          </div>
        </div>

        <!-- Diff Block -->
        <div class="code-rag-diff-block">
          <div class="code-rag-diff-header">
            {{ isNewFile(i) ? 'New file with syntax highlighting' : 'Showing changes with syntax highlighting' }}
          </div>

          <!-- Diff Content for Regular Files -->
          <div class="code-rag-diff-content" *ngIf="!isNewFile(i)">
            <div 
              *ngFor="let line of getDiffLines(i)" 
              class="code-rag-diff-line code-rag-line-{{ line.type }}">
              <div class="code-rag-line-numbers">
                <div class="code-rag-line-number">{{ line.oldLineNum || '' }}</div>
                <div class="code-rag-line-number">{{ line.newLineNum || '' }}</div>
              </div>
              <div class="code-rag-line-content">
                <code [innerHTML]="line.highlightedContent"></code>
              </div>
            </div>
          </div>

          <!-- New File Content -->
          <div class="code-rag-new-file-content" *ngIf="isNewFile(i)">
            <div 
              *ngFor="let line of getDiffLines(i)" 
              class="code-rag-new-file-line">
              <div class="code-rag-line-numbers">
                <div class="code-rag-line-number"></div>
                <div class="code-rag-line-number">{{ line.newLineNum }}</div>
              </div>
              <div class="code-rag-line-content">
                <code [innerHTML]="line.highlightedContent"></code>
              </div>
            </div>
          </div>
        </div>

        <!-- File Actions -->
        <div class="code-rag-file-actions">
          <button 
            class="code-rag-btn code-rag-btn-accept" 
            (click)="acceptFile(i)">
            <span>‚úì</span>
            <span>Accept</span>
          </button>
          <button 
            class="code-rag-btn code-rag-btn-reject" 
            (click)="rejectFile(i)">
            <span>‚úó</span>
            <span>Reject</span>
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>
















.code-rag-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 3px dotted #f59e0b;
}

.code-rag-top-section {
    margin: 15px;
}

.code-rag-draft-header {
    background: #fff8e6;
    border-left: 4px solid #f59e0b;
    padding: 15px 20px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.code-rag-draft-icon {
    font-size: 24px;
}

.code-rag-draft-text {
    flex: 1;
}

.code-rag-draft-title {
    font-size: 16px;
    font-weight: 600;
    color: #92400e;
    margin-bottom: 4px;
}

.code-rag-draft-subtitle {
    font-size: 13px;
    color: #b45309;
}

.code-rag-top-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.code-rag-btn-small {
    padding: 8px 18px;
    border: 2px solid;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    background: white;
}

.code-rag-btn-small.code-rag-btn-accept {
    border-color: #2da44e;
    color: #2da44e;
    background: white;
}

.code-rag-btn-small.code-rag-btn-accept:hover {
    background: #2da44e !important;
    color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(45, 164, 78, 0.3);
}

.code-rag-btn-small.code-rag-btn-reject {
    border-color: #cf222e;
    color: #cf222e;
    background: white;
}

.code-rag-btn-small.code-rag-btn-reject:hover {
    background: #cf222e !important;
    color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(207, 34, 46, 0.3);
}

.code-rag-files-container {
    padding: 20px;
    background: #f6f8fa;
}

.code-rag-file-block {
    background: white;
    border: 1px solid #d0d7de;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.code-rag-file-block:last-child {
    margin-bottom: 0;
}

.code-rag-header {
    background: #24292e;
    color: white;
    padding: 12px 20px;
    border-bottom: 2px solid #0366d6;
    display: flex;
    align-items: center;
}

.code-rag-file-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: #8b949e;
}

.code-rag-file-icon {
    font-size: 18px;
}

.code-rag-file-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #0969da;
    color: white;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
    text-transform: uppercase;
}

.code-rag-file-badge.new {
    background: #1a7f37;
}

.code-rag-stats {
    display: flex;
    gap: 20px;
    font-size: 13px;
    margin-left: auto;
}

.code-rag-stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.code-rag-stat-added {
    color: #2da44e;
    font-weight: 600;
}

.code-rag-stat-removed {
    color: #cf222e;
    font-weight: 600;
}

.code-rag-diff-container {
    background: #ffffff;
    padding: 0;
}

.code-rag-diff-block {
    background: white;
}

.code-rag-diff-header {
    background: #f6f8fa;
    padding: 10px 15px;
    border-bottom: 1px solid #d0d7de;
    border-top: 1px solid #d0d7de;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #57606a;
    font-weight: 600;
}

.code-rag-diff-content {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
}

.code-rag-diff-line {
    display: flex;
    min-height: 22px;
    position: relative;
}

.code-rag-line-numbers {
    display: flex;
    background: #f6f8fa;
    border-right: 1px solid #d0d7de;
    flex-shrink: 0;
    position: sticky;
    left: 0;
    z-index: 1;
}

.code-rag-line-number {
    width: 45px;
    padding: 0 8px;
    text-align: right;
    user-select: none;
    color: #57606a;
    font-size: 12px;
}

.code-rag-line-content {
    padding: 0 10px;
    flex: 1;
    white-space: pre;
    overflow-x: auto;
}

.code-rag-line-content code {
    background: transparent !important;
    padding: 0 !important;
    font-family: inherit;
}

.code-rag-line-added {
    background: #e6ffec;
}

.code-rag-line-added .code-rag-line-numbers {
    background: #ccffd8;
}

.code-rag-line-added .code-rag-line-content::before {
    content: '+';
    color: #2da44e;
    margin-right: 8px;
    font-weight: bold;
    display: inline-block;
    width: 10px;
}

.code-rag-line-removed {
    background: #ffebe9;
}

.code-rag-line-removed .code-rag-line-numbers {
    background: #ffd7d5;
}

.code-rag-line-removed .code-rag-line-content::before {
    content: '-';
    color: #cf222e;
    margin-right: 8px;
    font-weight: bold;
    display: inline-block;
    width: 10px;
}

.code-rag-line-context {
    background: white;
}

.code-rag-line-context .code-rag-line-content::before {
    content: ' ';
    margin-right: 8px;
    display: inline-block;
    width: 10px;
}

.code-rag-new-file-content {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
    background: #f0f9ff;
}

.code-rag-new-file-line {
    display: flex;
    min-height: 22px;
    background: #dbeafe;
}

.code-rag-new-file-line .code-rag-line-numbers {
    background: #bfdbfe;
}

.code-rag-new-file-line .code-rag-line-content::before {
    content: '+';
    color: #0969da;
    margin-right: 8px;
    font-weight: bold;
    display: inline-block;
    width: 10px;
}

.code-rag-line-added .hljs-keyword,
.code-rag-line-added .hljs-selector-tag,
.code-rag-line-added .hljs-built_in {
    color: #0a6e28;
}

.code-rag-line-removed .hljs-keyword,
.code-rag-line-removed .hljs-selector-tag,
.code-rag-line-removed .hljs-built_in {
    color: #8b0000;
}

.code-rag-line-added .hljs-string {
    color: #0a6e28;
}

.code-rag-line-removed .hljs-string {
    color: #8b0000;
}

.code-rag-file-actions {
    padding: 12px 20px;
    background: #f6f8fa;
    border-top: 1px solid #d0d7de;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.code-rag-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.code-rag-btn-accept {
    background: #2da44e;
    color: white;
}

.code-rag-btn-accept:hover {
    background: #2c974b;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 164, 78, 0.4);
}

.code-rag-btn-reject {
    background: #cf222e;
    color: white;
}

.code-rag-btn-reject:hover {
    background: #a40e26;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(207, 34, 46, 0.4);
}

.code-rag-btn:active {
    transform: translateY(0);
}

.code-rag-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.code-rag-file-accepted {
    padding: 30px 20px;
    text-align: center;
    background: #dafbe1;
    border: 2px solid #2da44e;
    border-radius: 6px;
    margin: 15px;
}

.code-rag-file-accepted-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.code-rag-file-accepted-text {
    font-size: 16px;
    color: #1a7f37;
    font-weight: 600;
    margin-bottom: 5px;
}

.code-rag-file-accepted-filename {
    font-size: 14px;
    color: #24292e;
    font-family: 'Courier New', monospace;
}

.code-rag-file-rejected {
    padding: 30px 20px;
    text-align: center;
    background: #ffebe9;
    border: 2px solid #cf222e;
    border-radius: 6px;
    margin: 15px;
}

.code-rag-file-rejected-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.code-rag-file-rejected-text {
    font-size: 16px;
    color: #a40e26;
    font-weight: 600;
    margin-bottom: 5px;
}

.code-rag-file-rejected-filename {
    font-size: 14px;
    color: #24292e;
    font-family: 'Courier New', monospace;
}

@media (max-width: 768px) {
    .code-rag-header {
        padding: 10px 15px;
    }

    .code-rag-file-actions {
        flex-direction: column;
    }

    .code-rag-btn {
        width: 100%;
        justify-content: center;
    }

    .code-rag-line-number {
        width: 35px;
        padding: 0 5px;
    }
}



// example-usage.component.ts
import { Component } from '@angular/core';

@Component({
  selector: 'app-example-usage',
  template: `
    <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
      <app-diff-viewer [files]="fileChanges"></app-diff-viewer>
    </div>
  `
})
export class ExampleUsageComponent {
  fileChanges = [
    {
      file_name: 'example.js',
      original_code: `function calculateSum(a, b) {
    return a + b;
}

function greet(name) {
    console.log("Hello " + name);
}

const result = calculateSum(5, 3);`,
      modified_code: `function calculateSum(a, b) {
    // Added validation
    if (typeof a !== 'number' || typeof b !== 'number') {
        throw new Error('Invalid input');
    }
    return a + b;
}

function greet(name) {
    console.log(\`Hello \${name}!\`);
}

const result = calculateSum(5, 3);
console.log('Result:', result);`
    },
    {
      file_name: 'utils.py',
      original_code: `def add(x, y):
    return x + y

def multiply(x, y):
    return x * y`,
      modified_code: `def add(x, y):
    """Add two numbers"""
    if not isinstance(x, (int, float)) or not isinstance(y, (int, float)):
        raise TypeError("Arguments must be numbers")
    return x + y

def multiply(x, y):
    """Multiply two numbers"""
    return x * y

def subtract(x, y):
    """Subtract y from x"""
    return x - y`
    },
    {
      file_name: 'newfile.ts',
      original_code: '',  // Empty means new file
      modified_code: `export interface User {
    id: number;
    name: string;
    email: string;
}

export class UserService {
    getUser(id: number): User {
        // Implementation here
        return { id, name: 'John', email: 'john@example.com' };
    }
}`
    }
  ];
}
