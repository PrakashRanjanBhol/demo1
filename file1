export class ChunkedJsonParserComponent implements OnInit {
  public isWaitingForApproval = false;
  public currentApprovalRequest: ApprovalRequest | null = null;
  public isProcessing = false;
  public executedItems: ToolData[] = [];
  public queuedItems: ToolData[] = [];
  public groupedExecutedItems: GroupedItem[] = [];
  public isApprovingChanges = false;

  constructor(
    private parserService: ChunkedJsonParserService,
    private cdr: ChangeDetectorRef
  ) {}

  ngOnInit(): void {
    // Callbacks will be set up when user clicks RUN
  }

  private setupCallbacks(): void {
    this.parserService.setCallbacks({
      onToolDetected: (toolData: ToolData) => {
        this.logToolDetected(toolData);
        this.updateLists();
        
        if (toolData.tool === 'READ') {
          this.appendReadContent(toolData);
        }
      },
      onApprovalRequest: (approvalRequest: ApprovalRequest) => {
        this.isWaitingForApproval = true;
        this.currentApprovalRequest = approvalRequest;
        this.isApprovingChanges = false; // ADDED: Reset approving state when new approval comes
        this.logWaitingForApproval(approvalRequest.data);
        this.updateLists();
        this.cdr.detectChanges();
      },
      onCompletion: () => {
        this.isProcessing = false;
        this.isApprovingChanges = false; // ADDED: Reset on completion
        this.logCompleted();
        this.updateLists();
      },
      onError: (error: string) => {
        this.isProcessing = false;
        this.isApprovingChanges = false; // ADDED: Reset on error
        this.logError(error);
      },
      onFirstChunk: () => {
        this.logFirstChunkReceived();
      }
    });
  }

  // CORRECTED approveAndContinue method
  public approveAndContinue(): void {
    if (this.currentApprovalRequest && !this.isApprovingChanges) {
      console.log('✅ APPROVED:', this.currentApprovalRequest.data);
      console.log('Continuing with next operation...\n');
      
      // Set loading state immediately
      this.isApprovingChanges = true;
      
      // Force change detection to show the spinner immediately
      this.cdr.detectChanges();
      
      // Use requestAnimationFrame to ensure the UI updates before processing
      requestAnimationFrame(() => {
        // Reset approval UI state
        this.isWaitingForApproval = false;
        this.currentApprovalRequest = null;
        
        // Approve and continue - this will trigger the next operation
        this.parserService.approveAndContinue();
        
        // Update lists
        this.updateLists();
        
        // The isApprovingChanges will be reset when:
        // 1. Next approval comes (in onApprovalRequest callback)
        // 2. Stream completes (in onCompletion callback)
        // 3. Error occurs (in onError callback)
      });
    }
  }

  // Keep rejectChanges as is
  public rejectChanges(): void {
    if (this.currentApprovalRequest) {
      console.log('❌ REJECTED:', this.currentApprovalRequest.data);
      console.log('Continuing with next operation...\n');
      
      // Mark as rejected and continue
      const rejectedData = { ...this.currentApprovalRequest.data, rejected: true };
      
      // Reset approval state
      this.isWaitingForApproval = false;
      this.currentApprovalRequest = null;
      
      this.parserService.approveAndContinue();
      this.updateLists();
    }
  }

  // ... rest of the methods remain the same ...
}
