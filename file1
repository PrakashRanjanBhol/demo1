<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunked JSON Parser with Approval</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #approvalSection {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }

        #approvalSection.show {
            display: block;
        }

        #pendingData {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        #status {
            margin-top: 10px;
            padding: 10px;
            color: #666;
            font-weight: bold;
        }

        .warning {
            color: #ff6b6b;
        }

        .success {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <button id="runBtn" onclick="runDemo()">Run Demo</button>
    
    <div id="status"></div>

    <div id="approvalSection">
        <h3>‚ö†Ô∏è Approval Required for WRITE/MODIFY Tool</h3>
        <p>The following operation requires your approval:</p>
        <div id="pendingData"></div>
        <button id="acceptBtn" onclick="approveAndContinue()">‚úì Accept and Continue</button>
    </div>

    <script>
        class ChunkedJSONParser {
            constructor() {
                this.buffer = '';
            }

            processChunk(chunk) {
                this.buffer += chunk;

                try {
                    const parsed = JSON.parse(this.buffer);
                    const result = { success: true, data: parsed };
                    this.buffer = '';
                    return result;
                } catch (error) {
                    return { success: false, data: null };
                }
            }

            reset() {
                this.buffer = '';
            }
        }

        // Queue system for handling approvals
        let pendingQueue = [];
        let isWaitingForApproval = false;
        let isStreamComplete = false;
        let currentPendingData = null;

        function showApprovalUI(data) {
            document.getElementById('approvalSection').classList.add('show');
            document.getElementById('pendingData').textContent = JSON.stringify(data, null, 2);
            document.getElementById('acceptBtn').disabled = false;
            currentPendingData = data;
        }

        function hideApprovalUI() {
            document.getElementById('approvalSection').classList.remove('show');
            document.getElementById('pendingData').textContent = '';
            currentPendingData = null;
        }

        function approveAndContinue() {
            if (currentPendingData) {
                console.log('‚úÖ APPROVED AND LOGGED:');
                console.log(currentPendingData);
                console.log('');
                
                hideApprovalUI();
                isWaitingForApproval = false;
                
                // Process next item in queue
                processQueue();
            }
        }

        function processQueue() {
            if (pendingQueue.length > 0 && !isWaitingForApproval) {
                const nextItem = pendingQueue.shift();
                handleParsedJSON(nextItem);
            } else if (pendingQueue.length === 0 && isStreamComplete && !isWaitingForApproval) {
                // All done
                console.log('\nüéâ ‚úÖ COMPLETED - All operations processed!');
                document.getElementById('status').innerHTML = '<span class="success">‚úÖ COMPLETED</span>';
            }
        }

        function handleParsedJSON(data) {
            const tool = data.tool;

            if (tool === 'READ') {
                // READ tool - log immediately
                console.log('üìñ READ Tool - Logged immediately:');
                console.log(data);
                console.log('');
                
                // Continue processing queue
                processQueue();
            } else if (tool === 'WRITE' || tool === 'MODIFY') {
                // WRITE/MODIFY tool - require approval
                console.log(`‚ö†Ô∏è ${tool} Tool detected - Waiting for approval...`);
                document.getElementById('status').innerHTML = `<span class="warning">‚ö†Ô∏è Waiting for approval (${pendingQueue.length} in queue)</span>`;
                
                isWaitingForApproval = true;
                showApprovalUI(data);
            } else {
                // Unknown tool - log immediately
                console.log('‚ùì Unknown Tool - Logged immediately:');
                console.log(data);
                console.log('');
                
                // Continue processing queue
                processQueue();
            }
        }

        async function runDemo() {
            console.clear();
            console.log('üöÄ Starting streaming demo with approval flow...\n');
            
            // Reset state
            pendingQueue = [];
            isWaitingForApproval = false;
            isStreamComplete = false;
            hideApprovalUI();
            
            document.getElementById('status').textContent = 'Streaming...';
            document.getElementById('runBtn').disabled = true;

            // Simulated test data
            const testData = [
                {tool: "READ", content: "Initializing system..."},
                {tool: "READ", content: "Loading configuration..."},
                {tool: "WRITE", content: {
                    reasoning: "Need to create a new configuration file",
                    files: [{
                        file_path: "/app/config",
                        file_name: "settings.json",
                        original_code: "",
                        modified_code: '{"theme": "dark", "language": "en"}'
                    }]
                }},
                {tool: "READ", content: "Reading file: config.json"},
                {tool: "READ", content: "Validating configuration..."},
                {tool: "MODIFY", content: {
                    reasoning: "Update existing file with new settings",
                    files: [{
                        file_path: "/app/config",
                        file_name: "settings.json",
                        original_code: '{"theme": "dark", "language": "en"}',
                        modified_code: '{"theme": "dark", "language": "en", "notifications": true}'
                    }]
                }},
                {tool: "READ", content: "Configuration updated successfully"},
                {tool: "WRITE", content: {
                    reasoning: "Create log file",
                    files: [{
                        file_path: "/app/logs",
                        file_name: "app.log",
                        original_code: "",
                        modified_code: 'System started at ' + new Date().toISOString()
                    }]
                }},
                {tool: "READ", content: "Processing complete!"}
            ];

            try {
                const parser = new ChunkedJSONParser();

                // Simulate streaming character by character
                for (let i = 0; i < testData.length; i++) {
                    const item = testData[i];
                    const jsonString = JSON.stringify(item);
                    
                    console.log(`\nüì¶ Streaming object ${i + 1}/${testData.length}...`);

                    // Stream character by character
                    for (let j = 0; j < jsonString.length; j++) {
                        const char = jsonString[j];
                        const result = parser.processChunk(char);
                        
                        if (result.success) {
                            console.log('‚úÖ Valid JSON parsed');
                            
                            // Add to queue
                            pendingQueue.push(result.data);
                            
                            // If not waiting for approval, process immediately
                            if (!isWaitingForApproval) {
                                processQueue();
                            } else {
                                document.getElementById('status').innerHTML = `<span class="warning">‚ö†Ô∏è Waiting for approval (${pendingQueue.length} in queue)</span>`;
                            }
                        }

                        // Simulate network delay
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                }

                // Mark stream as complete
                isStreamComplete = true;
                console.log('\nüì° Stream ended');
                
                // Check if we're done or still waiting
                if (!isWaitingForApproval && pendingQueue.length === 0) {
                    console.log('\nüéâ ‚úÖ COMPLETED - All operations processed!');
                    document.getElementById('status').innerHTML = '<span class="success">‚úÖ COMPLETED</span>';
                } else if (isWaitingForApproval) {
                    document.getElementById('status').innerHTML = `<span class="warning">‚ö†Ô∏è Waiting for approval (${pendingQueue.length} pending)</span>`;
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('status').innerHTML = '<span class="warning">Error: ' + error.message + '</span>';
            } finally {
                document.getElementById('runBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
