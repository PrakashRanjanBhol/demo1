import { Component, OnInit, Input, Output, EventEmitter } from '@angular/core';
import * as Diff from 'diff';
import * as hljs from 'highlight.js';

// Updated interfaces to match your structure
interface FileItem {
  file_path: string;
  file_name: string;
  original_code: string;
  modified_code: string;
}

interface FileConfigContent {
  reasoning: string;
  files: FileItem[];
}

interface FileConfig {
  tool: string;
  content: FileConfigContent;
}

interface FileState {
  addedCount: number;
  removedCount: number;
}

interface DiffLine {
  type: 'added' | 'removed' | 'context';
  content: string;
  oldLineNum: number | null;
  newLineNum: number | null;
  highlightedContent: string;
}

type ViewMode = 'unified' | 'split';

@Component({
  selector: 'app-diff-viewer',
  templateUrl: './diff-viewer.component.html',
  styleUrls: ['./diff-viewer.component.css']
})
export class DiffViewerComponent implements OnInit {
  @Input() config!: FileConfig;
  @Input() defaultViewMode: ViewMode = 'unified'; // Allow parent to set default
  
  // Output events for modal integration
  @Output() onAcceptAll = new EventEmitter<void>();
  @Output() onRejectAll = new EventEmitter<void>();
  @Output() onFileAccepted = new EventEmitter<{ file: FileItem, index: number }>();
  @Output() onFileRejected = new EventEmitter<{ file: FileItem, index: number }>();

  acceptedFiles: Set<number> = new Set();
  rejectedFiles: Set<number> = new Set();
  fileStates: FileState[] = [];
  processedDiffs: Map<number, { lines: DiffLine[], isNewFile: boolean }> = new Map();
  
  // View mode state
  viewMode: ViewMode = 'unified';

  // Getter for files array
  get files(): FileItem[] {
    return this.config?.content?.files || [];
  }

  // Getter for tool type
  get toolType(): string {
    return this.config?.tool || '';
  }

  // Getter for reasoning
  get reasoning(): string {
    return this.config?.content?.reasoning || '';
  }

  ngOnInit(): void {
    this.viewMode = this.defaultViewMode;
    this.processAllFiles();
  }

  ngOnChanges(): void {
    // Reset state when config changes
    this.acceptedFiles.clear();
    this.rejectedFiles.clear();
    this.fileStates = [];
    this.processedDiffs.clear();
    this.processAllFiles();
  }

  toggleViewMode(): void {
    this.viewMode = this.viewMode === 'unified' ? 'split' : 'unified';
  }

  setViewMode(mode: ViewMode): void {
    this.viewMode = mode;
  }

  isUnifiedView(): boolean {
    return this.viewMode === 'unified';
  }

  isSplitView(): boolean {
    return this.viewMode === 'split';
  }

  processAllFiles(): void {
    this.files.forEach((file, index) => {
      const isNewFile = !file.original_code || file.original_code.trim() === '';
      
      if (isNewFile) {
        const lines = this.processNewFile(file);
        this.processedDiffs.set(index, { lines, isNewFile: true });
        this.fileStates[index] = { addedCount: lines.length, removedCount: 0 };
      } else {
        const lines = this.processDiff(file);
        const addedCount = lines.filter(l => l.type === 'added').length;
        const removedCount = lines.filter(l => l.type === 'removed').length;
        this.processedDiffs.set(index, { lines, isNewFile: false });
        this.fileStates[index] = { addedCount, removedCount };
      }
    });
  }

  processNewFile(file: FileItem): DiffLine[] {
    const lines = file.modified_code.split('\n');
    const diffLines: DiffLine[] = [];
    
    lines.forEach((line, index) => {
      diffLines.push({
        type: 'added',
        content: line,
        oldLineNum: null,
        newLineNum: index + 1,
        highlightedContent: this.highlightCode(line, file.file_name)
      });
    });
    
    return diffLines;
  }

  processDiff(file: FileItem): DiffLine[] {
    const diff = Diff.diffLines(file.original_code, file.modified_code);
    const diffLines: DiffLine[] = [];
    let oldLineNum = 1;
    let newLineNum = 1;

    diff.forEach(part => {
      const lines = part.value.split('\n');
      if (lines[lines.length - 1] === '') {
        lines.pop();
      }

      lines.forEach(line => {
        if (part.added) {
          diffLines.push({
            type: 'added',
            content: line,
            oldLineNum: null,
            newLineNum: newLineNum++,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        } else if (part.removed) {
          diffLines.push({
            type: 'removed',
            content: line,
            oldLineNum: oldLineNum++,
            newLineNum: null,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        } else {
          diffLines.push({
            type: 'context',
            content: line,
            oldLineNum: oldLineNum++,
            newLineNum: newLineNum++,
            highlightedContent: this.highlightCode(line, file.file_name)
          });
        }
      });
    });

    return diffLines;
  }

  // Get split view data with diff information and alignment
  getSplitViewData(index: number): { 
    oldLines: Array<{lineNum: number | null, content: string, highlighted: string, type: 'added' | 'removed' | 'context' | 'empty'}>,
    newLines: Array<{lineNum: number | null, content: string, highlighted: string, type: 'added' | 'removed' | 'context' | 'empty'}>
  } {
    const file = this.files[index];
    if (!file) {
      return { oldLines: [], newLines: [] };
    }

    const diff = Diff.diffLines(file.original_code, file.modified_code);
    const oldLines: Array<{lineNum: number | null, content: string, highlighted: string, type: 'added' | 'removed' | 'context' | 'empty'}> = [];
    const newLines: Array<{lineNum: number | null, content: string, highlighted: string, type: 'added' | 'removed' | 'context' | 'empty'}> = [];
    
    let oldLineNum = 1;
    let newLineNum = 1;

    diff.forEach(part => {
      const lines = part.value.split('\n');
      if (lines[lines.length - 1] === '') {
        lines.pop();
      }

      if (part.added) {
        // Added lines only appear in new/modified code
        // Add empty placeholders in old code for alignment
        lines.forEach(line => {
          oldLines.push({
            lineNum: null,
            content: '',
            highlighted: '',
            type: 'empty'
          });
          newLines.push({
            lineNum: newLineNum++,
            content: line,
            highlighted: this.highlightCode(line, file.file_name),
            type: 'added'
          });
        });
      } else if (part.removed) {
        // Removed lines only appear in old/original code
        // Add empty placeholders in new code for alignment
        lines.forEach(line => {
          oldLines.push({
            lineNum: oldLineNum++,
            content: line,
            highlighted: this.highlightCode(line, file.file_name),
            type: 'removed'
          });
          newLines.push({
            lineNum: null,
            content: '',
            highlighted: '',
            type: 'empty'
          });
        });
      } else {
        // Context lines appear in both
        lines.forEach(line => {
          oldLines.push({
            lineNum: oldLineNum++,
            content: line,
            highlighted: this.highlightCode(line, file.file_name),
            type: 'context'
          });
          newLines.push({
            lineNum: newLineNum++,
            content: line,
            highlighted: this.highlightCode(line, file.file_name),
            type: 'context'
          });
        });
      }
    });

    return { oldLines, newLines };
  }

  highlightCode(code: string, fileName: string): string {
    try {
      const lang = this.detectLanguage(fileName);
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      } else {
        return hljs.highlightAuto(code).value;
      }
    } catch (e) {
      console.error('Highlighting error:', e);
      return this.escapeHtml(code);
    }
  }

  detectLanguage(fileName: string): string {
    const extension = fileName.split('.').pop()?.toLowerCase() || '';
    const languageMap: { [key: string]: string } = {
      'js': 'javascript',
      'jsx': 'javascript',
      'ts': 'typescript',
      'tsx': 'typescript',
      'py': 'python',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'cpp',
      'h': 'cpp',
      'hpp': 'cpp',
      'css': 'css',
      'html': 'html',
      'php': 'php',
      'rb': 'ruby',
      'go': 'go',
      'rs': 'rust',
      'sh': 'bash',
      'json': 'json',
      'xml': 'xml',
      'sql': 'sql'
    };
    return languageMap[extension] || 'plaintext';
  }

  escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  acceptFile(index: number): void {
    console.log(`File ${index} accepted:`, this.files[index].file_name);
    console.log('File path:', this.files[index].file_path);
    console.log('Applied code:', this.files[index].modified_code);
    this.acceptedFiles.add(index);
    
    // Emit event for modal
    this.onFileAccepted.emit({ file: this.files[index], index });
  }

  rejectFile(index: number): void {
    console.log(`File ${index} rejected:`, this.files[index].file_name);
    console.log('File path:', this.files[index].file_path);
    console.log('Keeping original code:', this.files[index].original_code);
    this.rejectedFiles.add(index);
    
    // Emit event for modal
    this.onFileRejected.emit({ file: this.files[index], index });
  }

  acceptAll(): void {
    console.log('All files accepted');
    console.log('Tool:', this.toolType);
    console.log('Reasoning:', this.reasoning);
    this.files.forEach((file, index) => {
      console.log(`${file.file_name} (${file.file_path}): Applied code`, file.modified_code);
      this.acceptFile(index);
    });
    
    // Emit event for modal
    this.onAcceptAll.emit();
  }

  rejectAll(): void {
    console.log('All files rejected');
    console.log('Tool:', this.toolType);
    console.log('Reasoning:', this.reasoning);
    this.files.forEach((file, index) => {
      console.log(`${file.file_name} (${file.file_path}): Keeping original code`, file.original_code);
      this.rejectFile(index);
    });
    
    // Emit event for modal
    this.onRejectAll.emit();
  }

  isFileAccepted(index: number): boolean {
    return this.acceptedFiles.has(index);
  }

  isFileRejected(index: number): boolean {
    return this.rejectedFiles.has(index);
  }

  isFileProcessed(index: number): boolean {
    return this.isFileAccepted(index) || this.isFileRejected(index);
  }

  allFilesProcessed(): boolean {
    return (this.acceptedFiles.size + this.rejectedFiles.size) === this.files.length;
  }

  getDiffLines(index: number): DiffLine[] {
    return this.processedDiffs.get(index)?.lines || [];
  }

  isNewFile(index: number): boolean {
    return this.processedDiffs.get(index)?.isNewFile || false;
  }

  getFileState(index: number): FileState {
    return this.fileStates[index] || { addedCount: 0, removedCount: 0 };
  }

  getFilePath(index: number): string {
    return this.files[index]?.file_path || '';
  }
}





















<div class="code-rag-wrapper">
  <!-- Top Section: Draft Header and Action Buttons -->
  <div class="code-rag-top-section" *ngIf="!allFilesProcessed()">
    <!-- Draft Header -->
    <div class="code-rag-draft-header">
      <div class="code-rag-draft-icon">‚ö†Ô∏è</div>
      <div class="code-rag-draft-text">
        <div class="code-rag-draft-title">Confirmation Required - {{ toolType }}</div>
        <div class="code-rag-draft-subtitle" *ngIf="reasoning">
          {{ reasoning }}
        </div>
        <div class="code-rag-draft-subtitle" *ngIf="!reasoning">
          Review and approve changes for {{ files.length }} file{{ files.length > 1 ? 's' : '' }}
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="code-rag-top-actions">
      <button 
        class="code-rag-btn-small code-rag-btn-accept" 
        (click)="acceptAll()">
        Accept All
      </button>
      <button 
        class="code-rag-btn-small code-rag-btn-reject" 
        (click)="rejectAll()">
        Reject All
      </button>
    </div>
  </div>

  <!-- Files Container -->
  <div class="code-rag-files-container">
    <ng-container *ngFor="let file of files; let i = index">
      <!-- Accepted File Message -->
      <div class="code-rag-file-accepted" *ngIf="isFileAccepted(i)">
        <div class="code-rag-file-accepted-icon">‚úì</div>
        <div class="code-rag-file-accepted-text">Changes Accepted</div>
        <div class="code-rag-file-accepted-filename">{{ file.file_name }}</div>
        <div class="code-rag-file-path">{{ file.file_path }}</div>
      </div>

      <!-- Rejected File Message -->
      <div class="code-rag-file-rejected" *ngIf="isFileRejected(i)">
        <div class="code-rag-file-rejected-icon">‚úó</div>
        <div class="code-rag-file-rejected-text">Changes Rejected</div>
        <div class="code-rag-file-rejected-filename">{{ file.file_name }}</div>
        <div class="code-rag-file-path">{{ file.file_path }}</div>
      </div>

      <!-- File Block (not yet processed) -->
      <div class="code-rag-file-block" *ngIf="!isFileProcessed(i)">
        <!-- File Header -->
        <div class="code-rag-header">
          <div class="code-rag-file-info">
            <span class="code-rag-file-icon">üìÑ</span>
            <div class="code-rag-file-name-container">
              <span class="code-rag-file-name">{{ file.file_name }}</span>
              <span class="code-rag-file-badge new" *ngIf="isNewFile(i)">New File</span>
              <div class="code-rag-file-path-header">{{ file.file_path }}</div>
            </div>
          </div>
          <div class="code-rag-stats">
            <div class="code-rag-stat-item code-rag-stat-added">
              <span>++<span>{{ getFileState(i).addedCount }}</span></span>
            </div>
            <div class="code-rag-stat-item code-rag-stat-removed" *ngIf="!isNewFile(i)">
              <span>--<span>{{ getFileState(i).removedCount }}</span></span>
            </div>
          </div>
        </div>

        <!-- Diff Block -->
        <div class="code-rag-diff-block">
          <!-- Diff Header with View Toggle -->
          <div class="code-rag-diff-header">
            <span>
              {{ isNewFile(i) ? 'New file with syntax highlighting' : 'Showing changes with syntax highlighting' }}
            </span>
            <div class="code-rag-view-toggle" *ngIf="!isNewFile(i)">
              <button 
                class="code-rag-view-btn" 
                [class.active]="isUnifiedView()"
                (click)="setViewMode('unified')"
                title="Unified view">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                Unified
              </button>
              <button 
                class="code-rag-view-btn" 
                [class.active]="isSplitView()"
                (click)="setViewMode('split')"
                title="Split view">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="18"></rect>
                  <rect x="14" y="3" width="7" height="18"></rect>
                </svg>
                Split
              </button>
            </div>
          </div>

          <!-- Unified View -->
          <div class="code-rag-diff-content" *ngIf="isUnifiedView() && !isNewFile(i)">
            <div 
              *ngFor="let line of getDiffLines(i)" 
              class="code-rag-diff-line code-rag-line-{{ line.type }}">
              <div class="code-rag-line-numbers">
                <div class="code-rag-line-number">{{ line.oldLineNum || '' }}</div>
                <div class="code-rag-line-number">{{ line.newLineNum || '' }}</div>
              </div>
              <div class="code-rag-line-content">
                <code [innerHTML]="line.highlightedContent"></code>
              </div>
            </div>
          </div>

          <!-- Split View -->
          <div class="code-rag-split-view" *ngIf="isSplitView() && !isNewFile(i)">
            <!-- Original Code (Left) -->
            <div class="code-rag-split-pane code-rag-split-original">
              <div class="code-rag-split-header">Original</div>
              <div class="code-rag-split-content">
                <div 
                  *ngFor="let line of getSplitViewData(i).oldLines" 
                  class="code-rag-split-line"
                  [class.code-rag-split-line-removed]="line.type === 'removed'"
                  [class.code-rag-split-line-context]="line.type === 'context'"
                  [class.code-rag-split-line-empty]="line.type === 'empty'">
                  <div class="code-rag-split-line-number">{{ line.lineNum || '' }}</div>
                  <div class="code-rag-split-line-content">
                    <code [innerHTML]="line.highlighted || '&nbsp;'"></code>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modified Code (Right) -->
            <div class="code-rag-split-pane code-rag-split-modified">
              <div class="code-rag-split-header">Modified</div>
              <div class="code-rag-split-content">
                <div 
                  *ngFor="let line of getSplitViewData(i).newLines" 
                  class="code-rag-split-line"
                  [class.code-rag-split-line-added]="line.type === 'added'"
                  [class.code-rag-split-line-context]="line.type === 'context'"
                  [class.code-rag-split-line-empty]="line.type === 'empty'">
                  <div class="code-rag-split-line-number">{{ line.lineNum || '' }}</div>
                  <div class="code-rag-split-line-content">
                    <code [innerHTML]="line.highlighted || '&nbsp;'"></code>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- New File Content -->
          <div class="code-rag-new-file-content" *ngIf="isNewFile(i)">
            <div 
              *ngFor="let line of getDiffLines(i)" 
              class="code-rag-new-file-line">
              <div class="code-rag-line-numbers">
                <div class="code-rag-line-number"></div>
                <div class="code-rag-line-number">{{ line.newLineNum }}</div>
              </div>
              <div class="code-rag-line-content">
                <code [innerHTML]="line.highlightedContent"></code>
              </div>
            </div>
          </div>
        </div>

        <!-- File Actions -->
        <div class="code-rag-file-actions">
          <button 
            class="code-rag-btn code-rag-btn-accept" 
            (click)="acceptFile(i)">
            <span>‚úì</span>
            <span>Accept</span>
          </button>
          <button 
            class="code-rag-btn code-rag-btn-reject" 
            (click)="rejectFile(i)">
            <span>‚úó</span>
            <span>Reject</span>
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>
























/* Import theme variables */
@import './vibe-coding-theme-variables.css';

/* ===================================================================
   VIEW TOGGLE STYLES
   =================================================================== */

.code-rag-diff-header {
    background: var(--vibe-coding-secondary-bg);
    padding: 10px 15px;
    border-bottom: 1px solid var(--vibe-coding-border-primary);
    border-top: 1px solid var(--vibe-coding-border-primary);
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: var(--vibe-coding-text-secondary);
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-rag-view-toggle {
    display: flex;
    gap: 4px;
    background: var(--vibe-coding-primary-bg);
    border-radius: 6px;
    padding: 2px;
    border: 1px solid var(--vibe-coding-border-primary);
}

.code-rag-view-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: transparent;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    color: var(--vibe-coding-text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.code-rag-view-btn svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
}

.code-rag-view-btn:hover {
    background: var(--vibe-coding-secondary-bg);
    color: var(--vibe-coding-text-primary);
}

.code-rag-view-btn.active {
    background: var(--vibe-coding-header-border);
    color: white;
}

.code-rag-view-btn.active:hover {
    background: var(--vibe-coding-header-border);
}

/* ===================================================================
   SPLIT VIEW STYLES
   =================================================================== */

.code-rag-split-view {
    display: flex;
    height: 500px;
    overflow: hidden;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
}

.code-rag-split-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.code-rag-split-original {
    border-right: 2px solid var(--vibe-coding-border-primary);
}

.code-rag-split-header {
    background: var(--vibe-coding-secondary-bg);
    padding: 8px 12px;
    border-bottom: 1px solid var(--vibe-coding-border-primary);
    font-weight: 600;
    font-size: 12px;
    color: var(--vibe-coding-text-primary);
    text-align: center;
}

.code-rag-split-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: auto;
    background: var(--vibe-coding-primary-bg);
}

.code-rag-split-line {
    display: flex;
    min-height: 22px;
}

.code-rag-split-line-added {
    background: var(--vibe-coding-diff-added-bg);
}

.code-rag-split-line-removed {
    background: var(--vibe-coding-diff-removed-bg);
}

.code-rag-split-line-context {
    background: var(--vibe-coding-primary-bg);
}

.code-rag-split-line-empty {
    background: var(--vibe-coding-secondary-bg);
    opacity: 0.5;
}

.code-rag-split-line-number {
    width: 50px;
    padding: 0 10px;
    text-align: right;
    user-select: none;
    color: var(--vibe-coding-text-tertiary);
    background: var(--vibe-coding-secondary-bg);
    border-right: 1px solid var(--vibe-coding-border-primary);
    font-size: 12px;
    flex-shrink: 0;
}

.code-rag-split-line-content {
    padding: 0 10px;
    flex: 1;
    white-space: pre;
    overflow-x: auto;
}

.code-rag-split-line-content code {
    background: transparent !important;
    padding: 0 !important;
    font-family: inherit;
}

/* Synchronized scrolling styles (optional enhancement) */
.code-rag-split-content::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

.code-rag-split-content::-webkit-scrollbar-track {
    background: var(--vibe-coding-secondary-bg);
}

.code-rag-split-content::-webkit-scrollbar-thumb {
    background: var(--vibe-coding-border-primary);
    border-radius: 5px;
}

.code-rag-split-content::-webkit-scrollbar-thumb:hover {
    background: var(--vibe-coding-border-secondary);
}

/* ===================================================================
   RESPONSIVE ADJUSTMENTS
   =================================================================== */

@media (max-width: 1024px) {
    .code-rag-split-view {
        height: 400px;
    }
}

@media (max-width: 768px) {
    .code-rag-diff-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }

    .code-rag-view-toggle {
        width: 100%;
    }

    .code-rag-view-btn {
        flex: 1;
        justify-content: center;
    }

    .code-rag-split-view {
        flex-direction: column;
        height: auto;
    }

    .code-rag-split-pane {
        height: 300px;
    }

    .code-rag-split-original {
        border-right: none;
        border-bottom: 2px solid var(--vibe-coding-border-primary);
    }

    .code-rag-split-line-number {
        width: 40px;
        padding: 0 8px;
    }
}

@media (max-width: 480px) {
    .code-rag-view-btn {
        font-size: 11px;
        padding: 4px 8px;
    }

    .code-rag-view-btn svg {
        width: 12px;
        height: 12px;
    }

    .code-rag-split-pane {
        height: 250px;
    }
}
