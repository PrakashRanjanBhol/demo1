function extractCodeBlocks(text) {
    const result = [];
    const lines = text.split('\n');
    let currentBlock = null;
    let nonCodeLines = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        // Check if this line starts with ```
        if (trimmedLine.startsWith('```')) {
            if (currentBlock === null) {
                // Starting a new code block
                // Save any accumulated non-code content
                if (nonCodeLines.length > 0) {
                    const content = nonCodeLines.join('\n').trim();
                    if (content) {
                        result.push({ type: 'non-code', content });
                    }
                    nonCodeLines = [];
                }
                
                // Extract language (everything after ``` on the same line)
                const language = trimmedLine.substring(3).trim() || null;
                currentBlock = {
                    type: 'code',
                    language: language,
                    content: []
                };
            } else {
                // Ending the current code block
                result.push({
                    type: 'code',
                    language: currentBlock.language,
                    content: currentBlock.content.join('\n').trim()
                });
                currentBlock = null;
            }
        } else {
            // Regular line
            if (currentBlock !== null) {
                // Inside a code block
                currentBlock.content.push(line);
            } else {
                // Outside a code block
                nonCodeLines.push(line);
            }
        }
    }
    
    // Handle any remaining content
    if (currentBlock !== null) {
        // Unclosed code block
        result.push({
            type: 'code',
            language: currentBlock.language,
            content: currentBlock.content.join('\n').trim()
        });
    }
    
    if (nonCodeLines.length > 0) {
        const content = nonCodeLines.join('\n').trim();
        if (content) {
            result.push({ type: 'non-code', content });
        }
    }
    
    return result;
}
