updatePreview() {
  if (!this.previewFrame?.nativeElement) return;
  
  const consolidatedHtml = `<html>Hello</html>`;
  const iframe = this.previewFrame.nativeElement;

  // Show loader
  this.showLoader(iframe);

  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    doc.write(this.wrapHtmlWithLoadingDetection(consolidatedHtml));
    doc.close();

    // Listen for messages from iframe
    this.setupIframeMessageListener(iframe);
  }
}

private wrapHtmlWithLoadingDetection(html: string): string {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          flex-direction: column;
        }
        .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .error-message {
          color: #d32f2f;
          font-family: Arial, sans-serif;
          text-align: center;
          padding: 20px;
        }
      </style>
    </head>
    <body>
      <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #666;">Loading dependencies...</p>
      </div>
      
      ${html}
      
      <script>
        (function() {
          let scriptsToLoad = [];
          let linksToLoad = [];
          let loadedCount = 0;
          let totalResources = 0;
          let hasError = false;

          // Find all external scripts and stylesheets
          function findExternalResources() {
            const scripts = document.querySelectorAll('script[src]');
            const links = document.querySelectorAll('link[rel="stylesheet"][href]');
            
            scripts.forEach(script => {
              const src = script.getAttribute('src');
              if (src && (src.startsWith('http://') || src.startsWith('https://') || src.startsWith('//'))) {
                scriptsToLoad.push(script);
              }
            });
            
            links.forEach(link => {
              const href = link.getAttribute('href');
              if (href && (href.startsWith('http://') || href.startsWith('https://') || href.startsWith('//'))) {
                linksToLoad.push(link);
              }
            });
            
            totalResources = scriptsToLoad.length + linksToLoad.length;
          }

          function hideLoader() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
              overlay.style.display = 'none';
            }
          }

          function showError() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
              overlay.innerHTML = \`
                <div class="error-message">
                  <h3>⚠️ Dependency Loading Failed</h3>
                  <p>Failed to load one or more external resources.</p>
                  <p style="font-size: 12px; color: #999;">Please check your internet connection or CDN availability.</p>
                </div>
              \`;
            }
            window.parent.postMessage({ type: 'cdn-load-error' }, '*');
          }

          function checkComplete() {
            loadedCount++;
            if (loadedCount >= totalResources) {
              if (hasError) {
                showError();
              } else {
                hideLoader();
                window.parent.postMessage({ type: 'cdn-load-complete' }, '*');
              }
            }
          }

          function attachLoadListeners() {
            scriptsToLoad.forEach(script => {
              script.addEventListener('load', checkComplete);
              script.addEventListener('error', function() {
                hasError = true;
                checkComplete();
              });
            });

            linksToLoad.forEach(link => {
              link.addEventListener('load', checkComplete);
              link.addEventListener('error', function() {
                hasError = true;
                checkComplete();
              });
            });
          }

          // Initialize
          findExternalResources();
          
          if (totalResources === 0) {
            // No external resources, hide loader immediately
            hideLoader();
            window.parent.postMessage({ type: 'cdn-load-complete' }, '*');
          } else {
            attachLoadListeners();
            
            // Timeout fallback (10 seconds)
            setTimeout(function() {
              if (loadedCount < totalResources) {
                hasError = true;
                showError();
              }
            }, 10000);
          }
        })();
      </script>
    </body>
    </html>
  `;
}

private setupIframeMessageListener(iframe: HTMLIFrameElement) {
  const messageHandler = (event: MessageEvent) => {
    // Verify message is from our iframe
    if (event.source !== iframe.contentWindow) return;

    if (event.data.type === 'cdn-load-complete') {
      console.log('All CDN resources loaded successfully');
      // You can add additional logic here
    } else if (event.data.type === 'cdn-load-error') {
      console.error('CDN resources failed to load');
      // You can add additional error handling here
    }
  };

  window.addEventListener('message', messageHandler);
  
  // Clean up listener when component is destroyed
  // Store the handler reference if you need to remove it later
}

private showLoader(iframe: HTMLIFrameElement) {
  // Optional: Show a loader outside the iframe as well
  // This is useful while the iframe is being set up
  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    doc.write(`
      <html>
      <head>
        <style>
          body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: #f5f5f5;
          }
          .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
          }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </head>
      <body>
        <div class="spinner"></div>
      </body>
      </html>
    `);
    doc.close();
  }
}
