import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

// ... existing interfaces ...

@Component({
  selector: 'app-workflow-sidebar',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './workflow-sidebar.component.html',
  styleUrls: ['./workflow-sidebar.component.css']
})
export class WorkflowSidebarComponent implements OnInit, OnDestroy {
  // ... existing properties ...

  private pollingInterval: any; // Add this property
  private readonly POLLING_INTERVAL_MS = 120000; // 2 minutes in milliseconds

  ngOnInit(): void {
    this.loadWorkflows();
    this.startPolling(); // Start polling on init
  }

  ngOnDestroy(): void {
    this.stopPolling(); // Clean up polling on destroy
  }

  // Add polling methods
  startPolling(): void {
    // Poll every 2 minutes
    this.pollingInterval = setInterval(() => {
      console.log('Polling workflows...', new Date().toISOString());
      this.pollWorkflows();
    }, this.POLLING_INTERVAL_MS);
  }

  stopPolling(): void {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
      this.pollingInterval = null;
      console.log('Polling stopped');
    }
  }

  pollWorkflows(): void {
    // Don't poll if there's an error or initial refresh in progress
    if (this.hasError || this.isRefreshing) {
      console.log('Skipping poll - error or refresh in progress');
      return;
    }

    // Simulate API calls to fetch updated data
    // In production, replace with actual API calls
    console.log('Fetching My Workflows...');
    this.fetchMyWorkflows();

    console.log('Fetching Active Workflows...');
    this.fetchActiveWorkflows();

    console.log('Fetching Shared Workflows...');
    this.fetchSharedWorkflows();
  }

  // Add individual fetch methods
  fetchMyWorkflows(): void {
    // In production: make API call to fetch my workflows
    // Example:
    // this.http.get<Workflow[]>('your-api/my-workflows').subscribe(
    //   data => {
    //     this.myWorkflows = data;
    //     console.log('My Workflows updated:', data.length);
    //   },
    //   error => {
    //     console.error('Error fetching My Workflows:', error);
    //   }
    // );

    // For demo: just log
    console.log('My Workflows fetched successfully');
  }

  fetchActiveWorkflows(): void {
    // In production: make API call to fetch active workflows
    // Example:
    // this.http.get<Workflow[]>('your-api/active-workflows').subscribe(
    //   data => {
    //     this.activeWorkflows = data;
    //     console.log('Active Workflows updated:', data.length);
    //   },
    //   error => {
    //     console.error('Error fetching Active Workflows:', error);
    //   }
    // );

    // For demo: just log
    console.log('Active Workflows fetched successfully');
  }

  fetchSharedWorkflows(): void {
    // In production: make API call to fetch shared workflows
    // Example:
    // this.http.get<SharedWorkflow[]>('your-api/shared-workflows').subscribe(
    //   data => {
    //     this.sharedWorkflows = data;
    //     console.log('Shared Workflows updated:', data.length);
    //   },
    //   error => {
    //     console.error('Error fetching Shared Workflows:', error);
    //   }
    // );

    // For demo: just log
    console.log('Shared Workflows fetched successfully');
  }

  // Update loadWorkflows to also fetch all workflows
  loadWorkflows(): void {
    this.isRefreshing = true;
    this.hasError = false;

    // Simulate API call with potential failure
    setTimeout(() => {
      const isSuccess = Math.random() > 0.3;
      
      if (isSuccess) {
        // Fetch all workflows on initial load
        this.fetchMyWorkflows();
        this.fetchActiveWorkflows();
        this.fetchSharedWorkflows();
        
        this.isRefreshing = false;
        
        if (this.myWorkflows.length > 0) {
          this.activeWorkflowId = this.myWorkflows[0].id;
        }
        
        console.log('Workflows loaded successfully');
      } else {
        this.isRefreshing = false;
        this.hasError = true;
        this.myWorkflows = [];
        this.activeWorkflows = [];
        this.sharedWorkflows = [];
        console.error('Failed to load workflows');
      }
    }, 2000);
  }

  // ... rest of existing methods ...
}
