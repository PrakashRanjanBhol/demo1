/* CSS Variables for Theming */
:host {
    /* Light Theme (Default) */
    --bitbucket-file-comparator-bg-primary: #ffffff;
    --bitbucket-file-comparator-bg-secondary: #f5f5f5;
    --bitbucket-file-comparator-bg-tertiary: #fafbfc;
    --bitbucket-file-comparator-bg-overlay: #f0f7ff;
    
    --bitbucket-file-comparator-text-primary: #24292e;
    --bitbucket-file-comparator-text-secondary: #6c757d;
    --bitbucket-file-comparator-text-tertiary: #57606a;
    
    --bitbucket-file-comparator-border-primary: #e1e4e8;
    --bitbucket-file-comparator-border-secondary: #d0d7de;
    --bitbucket-file-comparator-border-tertiary: #d1d5db;
    
    --bitbucket-file-comparator-accent-primary: #0052cc;
    --bitbucket-file-comparator-accent-secondary: #0065ff;
    
    --bitbucket-file-comparator-comment-bg: #ffffff;
    --bitbucket-file-comparator-comment-border: #e0d4ff;
    --bitbucket-file-comparator-comment-shadow: rgba(0, 0, 0, 0.08);
    
    --bitbucket-file-comparator-success-bg: #f0fdf4;
    --bitbucket-file-comparator-success-border: #86efac;
    --bitbucket-file-comparator-success-text: #166534;
    --bitbucket-file-comparator-success-bg-light: #dcfce7;
    
    --bitbucket-file-comparator-error-bg: #fef2f2;
    --bitbucket-file-comparator-error-border: #fca5a5;
    --bitbucket-file-comparator-error-text: #991b1b;
    --bitbucket-file-comparator-error-bg-light: #fee2e2;
    
    --bitbucket-file-comparator-warning-bg: #fef3c7;
    --bitbucket-file-comparator-warning-text: #92400e;
    
    --bitbucket-file-comparator-info-bg: #dbeafe;
    --bitbucket-file-comparator-info-text: #1e40af;
    
    --bitbucket-file-comparator-purple-bg: #f3e8ff;
    --bitbucket-file-comparator-purple-text: #7c3aed;
    --bitbucket-file-comparator-purple-border: #7c3aed;
    
    --bitbucket-file-comparator-highlight-comment: #faf5ff;
    --bitbucket-file-comparator-highlight-accepted: #f0fdf4;
    --bitbucket-file-comparator-highlight-rejected: #fef2f2;
    
    --bitbucket-file-comparator-spinner-bg: #f3f4f6;
    --bitbucket-file-comparator-spinner-border: #e5e7eb;
    --bitbucket-file-comparator-spinner-accent: #7c3aed;
    
    --bitbucket-file-comparator-code-bg: #fafafa;
    --bitbucket-file-comparator-code-text: #383a42;
}

/* Dark Theme */
:host-context(.dark-theme),
:host.dark-theme {
    --bitbucket-file-comparator-bg-primary: #0a0a0b;
    --bitbucket-file-comparator-bg-secondary: #161618;
    --bitbucket-file-comparator-bg-tertiary: #1e1e20;
    --bitbucket-file-comparator-bg-overlay: #1a1d2e;
    
    --bitbucket-file-comparator-text-primary: #e6e6e6;
    --bitbucket-file-comparator-text-secondary: #9ca3af;
    --bitbucket-file-comparator-text-tertiary: #6b7280;
    
    --bitbucket-file-comparator-border-primary: #2d2d30;
    --bitbucket-file-comparator-border-secondary: #3d3d40;
    --bitbucket-file-comparator-border-tertiary: #4d4d50;
    
    --bitbucket-file-comparator-accent-primary: #3b82f6;
    --bitbucket-file-comparator-accent-secondary: #60a5fa;
    
    --bitbucket-file-comparator-comment-bg: #1e1e20;
    --bitbucket-file-comparator-comment-border: #4c1d95;
    --bitbucket-file-comparator-comment-shadow: rgba(0, 0, 0, 0.3);
    
    --bitbucket-file-comparator-success-bg: #14532d;
    --bitbucket-file-comparator-success-border: #16a34a;
    --bitbucket-file-comparator-success-text: #86efac;
    --bitbucket-file-comparator-success-bg-light: #166534;
    
    --bitbucket-file-comparator-error-bg: #450a0a;
    --bitbucket-file-comparator-error-border: #dc2626;
    --bitbucket-file-comparator-error-text: #fca5a5;
    --bitbucket-file-comparator-error-bg-light: #991b1b;
    
    --bitbucket-file-comparator-warning-bg: #451a03;
    --bitbucket-file-comparator-warning-text: #fbbf24;
    
    --bitbucket-file-comparator-info-bg: #1e3a8a;
    --bitbucket-file-comparator-info-text: #93c5fd;
    
    --bitbucket-file-comparator-purple-bg: #2e1065;
    --bitbucket-file-comparator-purple-text: #a78bfa;
    --bitbucket-file-comparator-purple-border: #7c3aed;
    
    --bitbucket-file-comparator-highlight-comment: #2e1065;
    --bitbucket-file-comparator-highlight-accepted: #14532d;
    --bitbucket-file-comparator-highlight-rejected: #450a0a;
    
    --bitbucket-file-comparator-spinner-bg: #2d2d30;
    --bitbucket-file-comparator-spinner-border: #3d3d40;
    --bitbucket-file-comparator-spinner-accent: #a78bfa;
    
    --bitbucket-file-comparator-code-bg: #282c34;
    --bitbucket-file-comparator-code-text: #abb2bf;
}

/* Highlight.js theme switching */
/* Light theme - show atom-one-light, hide atom-one-dark */
:host ::ng-deep .hljs {
    display: block;
    overflow-x: auto;
    padding: 0.5em;
    color: var(--bitbucket-file-comparator-code-text);
    background: var(--bitbucket-file-comparator-code-bg);
}

/* Hide dark theme in light mode */
:host ::ng-deep link[href*="atom-one-dark"] {
    display: none;
}

/* Dark theme - show atom-one-dark, hide atom-one-light */
:host-context(.dark-theme) ::ng-deep link[href*="atom-one-light"],
:host.dark-theme ::ng-deep link[href*="atom-one-light"] {
    display: none;
}

:host-context(.dark-theme) ::ng-deep link[href*="atom-one-dark"],
:host.dark-theme ::ng-deep link[href*="atom-one-dark"] {
    display: block;
}

/* Suggested patch code styling with highlight.js */
.suggested-patch-code {
    background-color: var(--bitbucket-file-comparator-code-bg);
    padding: 8px 12px;
    border-radius: 4px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    font-size: 13px;
    color: var(--bitbucket-file-comparator-code-text);
    white-space: pre-wrap;
    word-break: break-all;
    overflow-x: auto;
}

/* Override highlight.js background for suggested patches */
.suggested-patch-code ::ng-deep .hljs {
    background: transparent;
    padding: 0;
}











import { Component, OnInit, AfterViewInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import hljs from 'highlight.js';

// Declare Diff2HtmlUI for TypeScript
declare const Diff2HtmlUI: any;

// ... your interfaces ...

@Component({
  selector: 'app-ai-pr-diff-viewer',
  templateUrl: './ai-pr-diff-viewer.component.html',
  styleUrls: ['./ai-pr-diff-viewer.component.scss']
})
export class AiPrDiffViewerComponent implements OnInit, AfterViewInit {
  // ... existing properties ...
  
  isDarkTheme = false;

  constructor() { }

  ngOnInit(): void {
    this.initializeCommentStates();
    this.updateSummaryStats();
    
    // Detect system theme preference
    this.detectThemePreference();
  }

  ngAfterViewInit(): void {
    setTimeout(() => {
      this.renderAllDiffs();
      this.highlightCodeBlocks();
    }, 100);
  }

  detectThemePreference(): void {
    // Check if user has a theme preference saved
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      this.isDarkTheme = savedTheme === 'dark';
    } else {
      // Check system preference
      this.isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    this.applyTheme();
  }

  toggleTheme(): void {
    this.isDarkTheme = !this.isDarkTheme;
    localStorage.setItem('theme', this.isDarkTheme ? 'dark' : 'light');
    this.applyTheme();
  }

  applyTheme(): void {
    if (this.isDarkTheme) {
      document.body.classList.add('dark-theme');
    } else {
      document.body.classList.remove('dark-theme');
    }
    
    // Re-highlight code blocks when theme changes
    setTimeout(() => {
      this.highlightCodeBlocks();
    }, 50);
  }

  highlightCodeBlocks(): void {
    // Highlight all code blocks in suggested patches
    document.querySelectorAll('.suggested-patch-code').forEach((block) => {
      if (block.textContent) {
        // Detect language or default to javascript
        const code = block.textContent;
        const highlighted = hljs.highlightAuto(code, ['javascript', 'typescript', 'python', 'java', 'html', 'css']);
        block.innerHTML = highlighted.value;
      }
    });

    // Highlight any other code blocks
    document.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block as HTMLElement);
    });
  }

  // Update bindCommentEvents to re-highlight after cloning
  bindCommentEvents(commentElement: HTMLElement, fileIndex: number, commentIndex: number): void {
    const commentId = this.getCommentId(fileIndex, commentIndex);
    
    // ... existing binding code ...
    
    // Highlight code blocks in the cloned element
    commentElement.querySelectorAll('.suggested-patch-code').forEach((block) => {
      if (block.textContent) {
        const code = block.textContent;
        const highlighted = hljs.highlightAuto(code, ['javascript', 'typescript', 'python', 'java', 'html', 'css']);
        block.innerHTML = highlighted.value;
      }
    });
    
    // ... rest of existing binding code ...
  }

  // ... rest of your existing methods ...
}













