import { Injectable } from '@angular/core';
import { HttpClient, HttpEventType, HttpEvent } from '@angular/common/http';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

export interface UploadProgress {
  progress: number;
  status: 'pending' | 'uploading' | 'uploaded' | 'error';
}

export interface UploadResponse {
  success: boolean;
  message: string;
  fileId?: string;
  fileName?: string;
  fileUrl?: string;
}

export interface FileItem {
  id: number;
  original_name: string;
  inserted_at: string;
}

export interface FilesResponse {
  status: string;
  data: {
    files: FileItem[];
  };
}

export interface FilesByDateRequest {
  start_date: string;
  end_date: string;
}

@Injectable({
  providedIn: 'root'
})
export class UploadService {
  private apiUrl = 'http://localhost:3000/api';  // Replace with your API base URL

  constructor(private http: HttpClient) {}

  /**
   * Upload a single file with progress tracking
   * @param file - File to upload
   * @param metadata - Optional metadata to send with the file
   */
  uploadFile(file: File, metadata?: any): Observable<HttpEvent<UploadResponse>> {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('fileName', file.name);
    formData.append('fileSize', file.size.toString());
    formData.append('fileType', file.type);

    // Add any additional metadata
    if (metadata) {
      Object.keys(metadata).forEach(key => {
        formData.append(key, metadata[key]);
      });
    }

    return this.http.post<UploadResponse>(`${this.apiUrl}/upload`, formData, {
      reportProgress: true,
      observe: 'events'
    });
  }

  /**
   * Upload file and return progress as percentage
   */
  uploadFileWithProgress(file: File, metadata?: any): Observable<number | UploadResponse> {
    return this.uploadFile(file, metadata).pipe(
      map(event => {
        if (event.type === HttpEventType.UploadProgress) {
          const progress = event.total ? Math.round((100 * event.loaded) / event.total) : 0;
          return progress;
        } else if (event.type === HttpEventType.Response) {
          return event.body as UploadResponse;
        }
        return 0;
      })
    );
  }

  /**
   * Get list of uploaded files by date range
   * @param startDate - Start date in format 'YYYY-MM-DD'
   * @param endDate - End date in format 'YYYY-MM-DD'
   */
  getFilesByDate(startDate: string, endDate: string): Observable<FilesResponse> {
    const request: FilesByDateRequest = {
      start_date: startDate,
      end_date: endDate
    };

    return this.http.post<FilesResponse>(`${this.apiUrl}/files/by-date`, request);
  }

  /**
   * Get all uploaded files (uses current date)
   */
  getUploadedFiles(): Observable<FileItem[]> {
    const today = this.formatDate(new Date());
    
    return this.getFilesByDate(today, today).pipe(
      map(response => {
        if (response.status === 'success') {
          return response.data.files;
        }
        return [];
      })
    );
  }

  /**
   * Get files for a date range
   */
  getFilesInRange(startDate: Date, endDate: Date): Observable<FileItem[]> {
    const start = this.formatDate(startDate);
    const end = this.formatDate(endDate);
    
    return this.getFilesByDate(start, end).pipe(
      map(response => {
        if (response.status === 'success') {
          return response.data.files;
        }
        return [];
      })
    );
  }

  /**
   * Format date to 'YYYY-MM-DD'
   */
  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  /**
   * Delete uploaded file
   */
  deleteFile(fileId: string): Observable<any> {
    return this.http.delete(`${this.apiUrl}/files/${fileId}`);
  }

  /**
   * Get file details
   */
  getFileDetails(fileId: string): Observable<any> {
    return this.http.get(`${this.apiUrl}/files/${fileId}`);
  }
}











interface UploadFile {
  id: number;
  name: string;
  uploadDate: Date;
  insertedAt: string;
}

// ... rest of the component code ...

loadPreviousFiles(): void {
  // Get files from the last 30 days
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - 30);

  const sub = this.uploadService.getFilesInRange(startDate, endDate).subscribe({
    next: (files) => {
      this.allUploadedFiles = files.map(f => ({
        id: f.id,
        name: f.original_name,
        uploadDate: new Date(f.inserted_at),
        insertedAt: f.inserted_at
      }));
    },
    error: (error) => {
      console.error('Error loading previous files:', error);
      // Fallback to empty array or show error message
      this.allUploadedFiles = [];
    }
  });
  this.subscriptions.push(sub);
}

// Alternative: Load only today's files
loadTodaysFiles(): void {
  const sub = this.uploadService.getUploadedFiles().subscribe({
    next: (files) => {
      this.allUploadedFiles = files.map(f => ({
        id: f.id,
        name: f.original_name,
        uploadDate: new Date(f.inserted_at),
        insertedAt: f.inserted_at
      }));
    },
    error: (error) => {
      console.error('Error loading today\'s files:', error);
      this.allUploadedFiles = [];
    }
  });
  this.subscriptions.push(sub);
}

// Optional: Add method to load files with custom date range
loadFilesByCustomDate(startDate: Date, endDate: Date): void {
  const sub = this.uploadService.getFilesInRange(startDate, endDate).subscribe({
    next: (files) => {
      this.allUploadedFiles = files.map(f => ({
        id: f.id,
        name: f.original_name,
        uploadDate: new Date(f.inserted_at),
        insertedAt: f.inserted_at
      }));
    },
    error: (error) => {
      console.error('Error loading files by date:', error);
      this.allUploadedFiles = [];
    }
  });
  this.subscriptions.push(sub);
}
















constructor(
  private uploadService: UploadService,
  private generateService: GenerateService
) {
  // Choose one of these based on your requirement:
  
  // Option 1: Load files from last 30 days
  this.loadPreviousFiles();
  
  // Option 2: Load only today's files
  // this.loadTodaysFiles();
  
  // Option 3: Load files from specific date range
  // const start = new Date('2026-01-01');
  // const end = new Date();
  // this.loadFilesByCustomDate(start, end);
}
