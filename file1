public getDiffHtml(originalCode: string, modifiedCode: string, filename: string): string {
  const original = (originalCode || '').split('\n');
  const modified = (modifiedCode || '').split('\n');
  const language = this.getLanguageFromFilename(filename);
  
  // Safety check - limit total lines
  if (original.length > 1000 || modified.length > 1000) {
    return '<div class="vibe-coding-diff-line">File too large to display diff (>1000 lines)</div>';
  }
  
  const diff = this.computeDiff(original, modified);
  let diffHtml = '';
  let originalLineNum = 1;
  let modifiedLineNum = 1;
  
  // Safety counter to prevent infinite loops
  let blockCount = 0;
  const maxBlocks = 500;
  
  for (const block of diff) {
    blockCount++;
    if (blockCount > maxBlocks) {
      diffHtml += '<div class="vibe-coding-diff-line">... (diff truncated, too many changes)</div>';
      break;
    }
    
    if (block.type === 'unchanged') {
      // Unchanged lines
      for (const line of block.lines || []) {
        const highlightedCode = this.highlightCode(line, language);
        diffHtml += `<div class="vibe-coding-diff-line vibe-coding-unchanged">`;
        diffHtml += `<span class="vibe-coding-line-number">${originalLineNum}</span>`;
        diffHtml += `<span class="vibe-coding-line-number">${modifiedLineNum}</span>`;
        diffHtml += `<span class="vibe-coding-line-prefix">  </span>`;
        diffHtml += `<span class="vibe-coding-line-content">${highlightedCode}</span>`;
        diffHtml += `</div>`;
        originalLineNum++;
        modifiedLineNum++;
      }
    } else if (block.type === 'changed') {
      // Group all removed lines first
      for (const line of block.removed || []) {
        const highlightedCode = this.highlightCode(line, language);
        diffHtml += `<div class="vibe-coding-diff-line vibe-coding-removed">`;
        diffHtml += `<span class="vibe-coding-line-number">${originalLineNum}</span>`;
        diffHtml += `<span class="vibe-coding-line-number"></span>`;
        diffHtml += `<span class="vibe-coding-line-prefix">- </span>`;
        diffHtml += `<span class="vibe-coding-line-content">${highlightedCode}</span>`;
        diffHtml += `</div>`;
        originalLineNum++;
      }
      
      // Then group all added lines
      for (const line of block.added || []) {
        const highlightedCode = this.highlightCode(line, language);
        diffHtml += `<div class="vibe-coding-diff-line vibe-coding-added">`;
        diffHtml += `<span class="vibe-coding-line-number"></span>`;
        diffHtml += `<span class="vibe-coding-line-number">${modifiedLineNum}</span>`;
        diffHtml += `<span class="vibe-coding-line-prefix">+ </span>`;
        diffHtml += `<span class="vibe-coding-line-content">${highlightedCode}</span>`;
        diffHtml += `</div>`;
        modifiedLineNum++;
      }
    }
  }
  
  return diffHtml;
}
