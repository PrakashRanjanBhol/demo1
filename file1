import { Component, EventEmitter, Output, Input, OnDestroy, OnChanges, SimpleChanges, OnInit } from '@angular/core';
import { HttpEventType } from '@angular/common/http';
import { Subscription, interval } from 'rxjs';
import { switchMap, takeWhile } from 'rxjs/operators';
import { trigger, state, style, animate, transition } from '@angular/animations';
import {
  UploadGenerateService,
  UploadResponse,
  GenerateRequest,
  GenerateResponse,
  ProgressResponse,
  ModelsResponse
} from 'src/app/services/upload-generate.service';

interface FileWithStatus {
  file: File;
  status: 'pending' | 'uploading' | 'uploaded' | 'error';
  progress?: number;
  uploadedFileId?: number;
  uploadedFileName?: string;
  uploadedAt?: string;
}

interface RequestFile {
  id: number;
  name: string;
  hasResult: boolean;
  displayDate: string;
  summary_prompt: string | null;
  faq_prompt: string | null;
}

@Component({
  selector: 'app-upload-generate',
  templateUrl: './upload-generate.component.html',
  styleUrls: ['./upload-generate.component.css'],
  animations: [
    trigger('cardFlip', [
      state('upload', style({ transform: 'rotateY(0deg)' })),
      state('generate', style({ transform: 'rotateY(180deg)' })),
      transition('upload => generate', [
        animate('500ms cubic-bezier(0.4, 0.0, 0.2, 1)')
      ]),
      transition('generate => upload', [
        animate('500ms cubic-bezier(0.4, 0.0, 0.2, 1)')
      ])
    ]),
    trigger('flipFront', [
      state('upload', style({ opacity: 1, pointerEvents: 'auto' })),
      state('generate', style({ opacity: 0, pointerEvents: 'none' })),
      transition('upload => generate', [
        animate('250ms ease-in')
      ]),
      transition('generate => upload', [
        animate('250ms 250ms ease-out')
      ])
    ]),
    trigger('flipBack', [
      state('upload', style({ opacity: 0, pointerEvents: 'none' })),
      state('generate', style({ opacity: 1, pointerEvents: 'auto' })),
      transition('upload => generate', [
        animate('250ms 250ms ease-out')
      ]),
      transition('generate => upload', [
        animate('250ms ease-in')
      ])
    ])
  ]
})
export class UploadGenerateComponent implements OnInit, OnDestroy, OnChanges {
  @Input() requestFile: RequestFile | null = null;

  @Output() onGenerate = new EventEmitter<{ file: any, prompts: string, mode: 'new' }>();
  @Output() onFileRemoved = new EventEmitter<{ id: string | number, name: string }>();
  @Output() onGenerationComplete = new EventEmitter<{
    id: number,
    status: 'Success' | 'Failure',
    summary_prompt?: string,
    faq_prompt?: string
  }>();
  @Output() onFileUploaded = new EventEmitter<{
    id: number,
    original_name: string,
    created_at: string,
    summary_prompt: string | null,
    faq_prompt: string | null
  }>();
  @Output() onProcessingStatusChange = new EventEmitter<{
    isProcessing: boolean,
    id: number | null
  }>();
  @Output() onUploadStatusChange = new EventEmitter<{ isFileUploading: boolean }>();

  isDragging: boolean = false;
  summaryPrompt: string = '';
  faqPrompt: string = '';
  isProcessing: boolean = false;
  processingProgress: number = 0;
  processingFileName: string = '';
  processingFileId: string = '';

  currentTab: 'upload' | 'generate' = 'upload';
  uploadedFilesWithStatus: FileWithStatus[] = [];
  selectedUploadFile: File | null = null;
  isUploading: boolean = false;

  // Accepted file types
  acceptedFileTypes = ['.vtt', '.srt'];
  acceptedMimeTypes = ['text/vtt', 'application/x-subrip'];

  // For Generate tab
  selectedGenerateFile: {
    name: string,
    size: number,
    id: string | number,
    displayDate?: string,
    hasResult?: boolean,
    summary_prompt?: string | null,
    faq_prompt?: string | null
  } | null = null;
  isDraggingGenerate: boolean = false;

  // Highlight animation
  isFileHighlighted: boolean = false;

  // Generation status
  generationStatus: 'idle' | 'generating' | 'success' | 'error' = 'idle';
  generationErrorMessage: string = '';

  // Model properties
  availableModels: string[] = [];
  selectedModel: string = '';
  isLoadingModels: boolean = false;
  modelsLoadError: string = '';

  private subscriptions: Subscription[] = [];
  private highlightTimeout: any;
  private progressPollingSubscription: Subscription | null = null;

  constructor(
    private uploadGenerateService: UploadGenerateService
  ) { }

  ngOnInit(): void {
    this.loadModels();
  }

  ngOnChanges(changes: SimpleChanges): void {
    if (changes['requestFile']) {
      this.handleRequestFileChange(changes['requestFile'].currentValue);
    }
  }

  ngOnDestroy(): void {
    this.subscriptions.forEach(sub => sub.unsubscribe());
    if (this.highlightTimeout) {
      clearTimeout(this.highlightTimeout);
    }
    this.stopProgressPolling();
  }

  // Computed property for any operation in progress
  get isAnyOperationInProgress(): boolean {
    return this.isUploading || this.isProcessing;
  }

  // Load models from API
  loadModels(): void {
    this.isLoadingModels = true;
    this.modelsLoadError = '';

    const sub = this.uploadGenerateService.getModels().subscribe({
      next: (response: ModelsResponse) => {
        console.log('Models loaded:', response);

        if (response.status === 'Success' || response.status === 'success') {
          if (response.result && response.result.length > 0) {
            this.availableModels = response.result;
            // Select first model by default
            this.selectedModel = this.availableModels[0];
            this.modelsLoadError = '';
          } else {
            // Empty array - no models available
            this.availableModels = [];
            this.selectedModel = '';
            this.modelsLoadError = '';
          }
        } else {
          this.availableModels = [];
          this.selectedModel = '';
          this.modelsLoadError = 'No models available';
        }

        this.isLoadingModels = false;
      },
      error: (error) => {
        console.error('Error loading models:', error);
        this.availableModels = [];
        this.selectedModel = '';
        this.modelsLoadError = 'Failed to load models';
        this.isLoadingModels = false;
      }
    });

    this.subscriptions.push(sub);
  }

  // Refresh models
  refreshModels(): void {
    this.loadModels();
  }

  // Handle model selection change
  onModelChange(model: string): void {
    this.selectedModel = model;
    console.log('Model changed to:', model);
  }

  private handleRequestFileChange(requestFile: RequestFile | null): void {
    if (requestFile) {
      // Switch to Generate tab
      this.currentTab = 'generate';

      // Set the selected file for generation
      this.selectedGenerateFile = {
        name: requestFile.name,
        size: 0, // Size not provided from parent
        id: requestFile.id,
        displayDate: requestFile.displayDate,
        hasResult: requestFile.hasResult,
        summary_prompt: requestFile.summary_prompt,
        faq_prompt: requestFile.faq_prompt
      };

      // Set prompts from the file
      this.summaryPrompt = requestFile.summary_prompt || '';
      this.faqPrompt = requestFile.faq_prompt || '';

      // Trigger highlight animation
      this.triggerFileHighlight();
    } else {
      // Clear the selected file
      this.selectedGenerateFile = null;
      // Clear prompts
      this.summaryPrompt = '';
      this.faqPrompt = '';
      // Clear any existing highlight
      this.isFileHighlighted = false;
      if (this.highlightTimeout) {
        clearTimeout(this.highlightTimeout);
      }
    }
  }

  private triggerFileHighlight(): void {
    // Clear any existing timeout
    if (this.highlightTimeout) {
      clearTimeout(this.highlightTimeout);
    }

    // Add highlight class
    this.isFileHighlighted = true;

    // Remove highlight after 5 seconds
    this.highlightTimeout = setTimeout(() => {
      this.isFileHighlighted = false;
    }, 5000);
  }

  onFileSelected(event: any): void {
    if (this.isUploading) return;

    const files = event.target.files;
    if (files && files.length > 0) {
      for (let i = 0; i < files.length; i++) {
        // Check if file is valid type and has content
        if (this.isValidFileType(files[i])) {
          if (files[i].size === 0) {
            alert(`File "${files[i].name}" is empty and cannot be uploaded.`);
            continue; // Skip this file
          }

          const exists = this.uploadedFilesWithStatus.some(f => f.file.name === files[i].name);
          if (!exists) {
            this.uploadedFilesWithStatus.push({
              file: files[i],
              status: 'pending',
              progress: 0
            });
          }
        } else {
          alert(`Invalid file type: ${files[i].name}. Only .vtt and .srt files are allowed.`);
        }
      }
    }
    // Reset input value to allow re-uploading same file
    event.target.value = '';
  }

  onFileDrop(event: DragEvent): void {
    if (this.isUploading) return;

    event.preventDefault();
    this.isDragging = false;

    const files = event.dataTransfer?.files;
    if (files && files.length > 0) {
      for (let i = 0; i < files.length; i++) {
        // Check if file is valid type and has content
        if (this.isValidFileType(files[i])) {
          if (files[i].size === 0) {
            alert(`File "${files[i].name}" is empty and cannot be uploaded.`);
            continue; // Skip this file
          }

          const exists = this.uploadedFilesWithStatus.some(f => f.file.name === files[i].name);
          if (!exists) {
            this.uploadedFilesWithStatus.push({
              file: files[i],
              status: 'pending',
              progress: 0
            });
          }
        } else {
          alert(`Invalid file type: ${files[i].name}. Only .vtt and .srt files are allowed.`);
        }
      }
    }
  }

  private isValidFileType(file: File): boolean {
    const fileName = file.name.toLowerCase();
    const fileExtension = fileName.substring(fileName.lastIndexOf('.'));
    return this.acceptedFileTypes.includes(fileExtension);
  }

  selectUploadFile(file: File): void {
    this.selectedUploadFile = file;
  }

  isUploadFileSelected(file: File): boolean {
    return this.selectedUploadFile === file;
  }

  removeIndividualFile(index: number): void {
    if (this.isUploading) return;
    this.uploadedFilesWithStatus.splice(index, 1);
  }

  async onUpload(): Promise<void> {
    if (this.uploadedFilesWithStatus.length > 0 && !this.isUploading) {
      this.isUploading = true;

      // Emit upload started
      this.onUploadStatusChange.emit({ isFileUploading: true });

      await this.uploadFilesSequentially();

      this.isUploading = false;

      // Emit upload completed
      this.onUploadStatusChange.emit({ isFileUploading: false });

      // Stay on Upload tab - don't navigate to Generate
    }
  }

  async uploadFilesSequentially(): Promise<void> {
    for (let i = 0; i < this.uploadedFilesWithStatus.length; i++) {
      const fileWithStatus = this.uploadedFilesWithStatus[i];

      // Skip already uploaded files
      if (fileWithStatus.status === 'uploaded') {
        continue;
      }

      fileWithStatus.status = 'uploading';
      fileWithStatus.progress = 0;

      try {
        await this.uploadFileViaService(fileWithStatus);
        fileWithStatus.status = 'uploaded';
        fileWithStatus.progress = 100;
      } catch (error) {
        fileWithStatus.status = 'error';
        console.error(`Failed to upload ${fileWithStatus.file.name}:`, error);

        // Determine user-friendly error message
        let errorMessage = 'Unknown error occurred';

        if (error && (error as any).status) {
          const status = (error as any).status;
          switch (status) {
            case 400:
              errorMessage = 'Invalid file format or corrupted file';
              break;
            case 401:
              errorMessage = 'Authentication required';
              break;
            case 403:
              errorMessage = 'Permission denied';
              break;
            case 413:
              errorMessage = 'File size too large';
              break;
            case 500:
              errorMessage = 'Server error. Please try again later';
              break;
            case 503:
              errorMessage = 'Service temporarily unavailable';
              break;
            default:
              errorMessage = (error as any).message || `Server error (${status})`;
          }
        } else if (error && (error as any).message) {
          errorMessage = (error as any).message;
        }

        // Show alert for failed upload
        alert(`Failed to upload "${fileWithStatus.file.name}"\n\nReason: ${errorMessage}`);
      }
    }

    // Check if all files are uploaded successfully
    const allUploaded = this.uploadedFilesWithStatus.every(
      file => file.status === 'uploaded'
    );

    // Clear the list if all files uploaded successfully
    if (allUploaded && this.uploadedFilesWithStatus.length > 0) {
      // Optional: Add a small delay so users can see the "Uploaded" status
      setTimeout(() => {
        this.uploadedFilesWithStatus = [];
        this.selectedUploadFile = null;
      }, 1500); // 1.5 second delay before clearing
    }
  }

  private uploadFileViaService(fileWithStatus: FileWithStatus): Promise<void> {
    return new Promise((resolve, reject) => {
      const sub = this.uploadGenerateService.uploadFile(fileWithStatus.file).subscribe({
        next: (event: any) => {
          if (event.type === HttpEventType.UploadProgress) {
            if (event.total) {
              fileWithStatus.progress = Math.round((100 * event.loaded) / event.total);
            }
          } else if (event.type === HttpEventType.Response) {
            const response = event.body as UploadResponse;
            if (response.status === 'Success') {
              fileWithStatus.uploadedFileId = response.data.id;
              fileWithStatus.uploadedFileName = response.data.original_name;
              fileWithStatus.uploadedAt = response.data.created_at;
              console.log('Upload successful:', response);

              // Emit upload success event to parent
              this.onFileUploaded.emit({
                id: response.data.id,
                original_name: response.data.original_name,
                created_at: response.data.created_at,
                summary_prompt: response.data.summary_prompt,
                faq_prompt: response.data.faq_prompt
              });

              resolve();
            } else {
              reject(new Error('Upload failed with status: ' + response.status));
            }
          }
        },
        error: (error) => {
          console.error('Upload error:', error);
          reject(error);
        }
      });
      this.subscriptions.push(sub);
    });
  }

  onDragOver(event: DragEvent): void {
    if (this.isUploading) return;
    event.preventDefault();
    this.isDragging = true;
  }

  onDragLeave(event: DragEvent): void {
    event.preventDefault();
    this.isDragging = false;
  }

  // Generate tab drag and drop
  onGenerateDragOver(event: DragEvent): void {
    event.preventDefault();
    this.isDraggingGenerate = true;
  }

  onGenerateDragLeave(event: DragEvent): void {
    event.preventDefault();
    this.isDraggingGenerate = false;
  }

  onGenerateFileDrop(event: DragEvent): void {
    event.preventDefault();
    this.isDraggingGenerate = false;
    // Handle file drop from history section
    // This will be implemented when you integrate with actual history
  }

  removeGenerateFile(): void {
    if (this.selectedGenerateFile) {
      // Emit the file removed event to parent
      this.onFileRemoved.emit({
        id: this.selectedGenerateFile.id,
        name: this.selectedGenerateFile.name
      });
    }

    // Emit processing stopped if it was running
    if (this.isProcessing) {
      this.onProcessingStatusChange.emit({
        isProcessing: false,
        id: null
      });
    }

    // Clear the selected file
    this.selectedGenerateFile = null;

    // Clear prompts
    this.summaryPrompt = '';
    this.faqPrompt = '';

    // Clear highlight when file is removed
    this.isFileHighlighted = false;
    if (this.highlightTimeout) {
      clearTimeout(this.highlightTimeout);
    }

    // Stop any ongoing generation
    this.stopProgressPolling();
    this.isProcessing = false;
    this.generationStatus = 'idle';
  }

  handleGenerate(): void {
    if (this.selectedGenerateFile) {
      this.startGeneration();
    }
  }

  private startGeneration(): void {
    if (!this.selectedGenerateFile) return;

    this.isProcessing = true;
    this.processingProgress = 0;
    this.processingFileName = this.selectedGenerateFile.name;
    this.processingFileId = String(this.selectedGenerateFile.id);
    this.generationStatus = 'generating';
    this.generationErrorMessage = '';

    // Emit processing started
    this.onProcessingStatusChange.emit({
      isProcessing: true,
      id: Number(this.selectedGenerateFile.id)
    });

    const request: GenerateRequest = {
      fileID: Number(this.selectedGenerateFile.id),
      model_name: this.selectedModel,
      optional_prompt: '',
      summary_prompt: this.summaryPrompt || '',
      faq_prompt: this.faqPrompt || ''
    };

    const sub = this.uploadGenerateService.generateAnalysis(request).subscribe({
      next: (response: GenerateResponse) => {
        console.log('Generation API response:', response);

        if (response.status === 'Success') {
          // Start progress polling
          this.startProgressPolling(Number(this.selectedGenerateFile!.id));
        } else {
          // Generation failed to start
          this.handleGenerationError('Failed to start generation');
        }
      },
      error: (error) => {
        console.error('Generation error:', error);
        this.handleGenerationError('Failed to initiate generation: ' + (error.message || 'Unknown error'));
      }
    });
    this.subscriptions.push(sub);
  }

  private startProgressPolling(fileId: number): void {
    // Stop any existing polling
    this.stopProgressPolling();

    // Create a polling observable that checks every 10 seconds
    this.progressPollingSubscription = interval(10000)
      .pipe(
        switchMap(() => this.uploadGenerateService.getGenerationProgress(fileId)),
        takeWhile((response: ProgressResponse) => {
          // Continue polling while progress is between 0 and 99
          return response.status === 'Success' && response.progress >= 0 && response.progress < 100;
        }, true) // inclusive: true means it will emit the value that fails the condition
      )
      .subscribe({
        next: (response: ProgressResponse) => {
          console.log('Progress update:', response);

          if (response.status === 'Success') {
            const progress = response.progress;

            if (progress === -1) {
              // Generation failed
              this.handleGenerationError('Content generation failed');
              this.stopProgressPolling();
            } else if (progress === 100) {
              // Generation completed successfully
              this.handleGenerationSuccess();
              this.stopProgressPolling();
            } else if (progress >= 0 && progress < 100) {
              // Update progress
              this.processingProgress = progress;
            }
          } else {
            // Unexpected status
            this.handleGenerationError('Unexpected response status');
            this.stopProgressPolling();
          }
        },
        error: (error) => {
          console.error('Progress polling error:', error);
          this.handleGenerationError('Failed to fetch progress: ' + (error.message || 'Unknown error'));
          this.stopProgressPolling();
        }
      });
  }

  private stopProgressPolling(): void {
    if (this.progressPollingSubscription) {
      this.progressPollingSubscription.unsubscribe();
      this.progressPollingSubscription = null;
    }
  }

  private handleGenerationSuccess(): void {
    this.processingProgress = 100;
    this.generationStatus = 'success';

    // Emit success event to parent with the new format including prompts
    this.onGenerationComplete.emit({
      id: Number(this.processingFileId),
      status: 'Success',
      summary_prompt: this.summaryPrompt || undefined,
      faq_prompt: this.faqPrompt || undefined
    });

    // Emit the original onGenerate event for backward compatibility
    this.onGenerate.emit({
      file: {
        fileId: this.processingFileId,
        fileName: this.processingFileName
      },
      prompts: this.summaryPrompt + '\n\n' + this.faqPrompt,
      mode: 'new'
    });

    // Wait a bit to show the success state, then complete
    setTimeout(() => {
      this.completeProcessing();
    }, 2000);
  }

  private handleGenerationError(message: string): void {
    this.generationStatus = 'error';
    this.generationErrorMessage = message;
    this.isProcessing = false;
    this.processingProgress = 0;

    // Emit processing stopped with error
    this.onProcessingStatusChange.emit({
      isProcessing: false,
      id: null
    });

    // Emit failure event to parent with the new format including prompts
    this.onGenerationComplete.emit({
      id: Number(this.processingFileId),
      status: 'Failure',
      summary_prompt: this.summaryPrompt || undefined,
      faq_prompt: this.faqPrompt || undefined
    });
  }

  completeProcessing(): void {
    // Emit processing stopped
    this.onProcessingStatusChange.emit({
      isProcessing: false,
      id: null
    });

    this.isProcessing = false;
    this.processingProgress = 0;
    this.processingFileName = '';
    this.processingFileId = '';
    this.selectedGenerateFile = null;
    this.summaryPrompt = '';
    this.faqPrompt = '';
    this.generationStatus = 'idle';
    this.generationErrorMessage = '';

    // Clear highlight
    this.isFileHighlighted = false;
    if (this.highlightTimeout) {
      clearTimeout(this.highlightTimeout);
    }

    // Stop polling
    this.stopProgressPolling();
  }

  onReset(): void {
    if (this.isUploading) return;
    this.uploadedFilesWithStatus = [];
    this.selectedUploadFile = null;
    this.summaryPrompt = '';
    this.faqPrompt = '';
    this.isDragging = false;
  }

  onCancel(): void {
    // Stop any ongoing generation
    this.stopProgressPolling();

    // Emit processing stopped if it was running
    if (this.isProcessing) {
      this.onProcessingStatusChange.emit({
        isProcessing: false,
        id: null
      });
    }

    this.selectedGenerateFile = null;
    this.summaryPrompt = '';
    this.faqPrompt = '';
    this.isProcessing = false;
    this.processingProgress = 0;
    this.generationStatus = 'idle';
    this.generationErrorMessage = '';

    // Clear highlight
    this.isFileHighlighted = false;
    if (this.highlightTimeout) {
      clearTimeout(this.highlightTimeout);
    }
  }

  getStatusBadgeClass(status: string): string {
    return `status-badge status-${status}`;
  }

  getStatusText(status: string): string {
    const statusMap: { [key: string]: string } = {
      'pending': 'Pending',
      'uploading': 'Uploading',
      'uploaded': 'Uploaded',
      'error': 'Error'
    };
    return statusMap[status] || status;
  }

  switchToTab(tab: 'upload' | 'generate'): void {
    if (this.isUploading && tab === 'generate') return;
    if (this.isProcessing && tab === 'upload') return; // Prevent switching during generation

    // Don't reset if switching to generate tab with a requestFile
    if (tab === 'generate' && this.requestFile) {
      this.currentTab = tab;
      return;
    }

    // Reset all data when switching tabs manually
    this.uploadedFilesWithStatus = [];
    this.selectedUploadFile = null;

    // Only reset selectedGenerateFile if not coming from parent
    if (!this.requestFile) {
      this.selectedGenerateFile = null;
    }

    this.summaryPrompt = '';
    this.faqPrompt = '';
    this.isDragging = false;
    this.isDraggingGenerate = false;
    this.isProcessing = false;
    this.processingProgress = 0;
    this.processingFileName = '';
    this.generationStatus = 'idle';
    this.generationErrorMessage = '';

    this.currentTab = tab;
  }

  shouldShowStatusBadge(fileWithStatus: FileWithStatus): boolean {
    return fileWithStatus.status !== 'pending';
  }

  getFileSizeDisplay(): string {
    if (this.selectedGenerateFile && this.selectedGenerateFile.size > 0) {
      return `${(this.selectedGenerateFile.size / 1024 / 1024).toFixed(2)} MB`;
    }
    return 'Size unknown';
  }

  getProcessingStatusMessage(): string {
    if (this.generationStatus === 'generating') {
      return 'Analyzing content, extracting insights, and generating results...';
    } else if (this.generationStatus === 'success') {
      return 'Generation completed successfully!';
    } else if (this.generationStatus === 'error') {
      return this.generationErrorMessage || 'Generation failed. Please try again.';
    }
    return 'Processing...';
  }

  getProcessingStatusClass(): string {
    return `processing-status-${this.generationStatus}`;
  }
}









<div class="panel">
    <div class="panel-header">
        <h3 class="panel-title">Upload & Generate</h3>

        <!-- Model Selector -->
        <div class="model-selector-container">
            <div class="model-selector-wrapper">
                <label class="model-selector-label">Model:</label>

                <!-- Show dropdown when models are loaded (even if empty) -->
                <select class="model-dropdown" *ngIf="!modelsLoadError" [(ngModel)]="selectedModel"
                    (change)="onModelChange(selectedModel)"
                    [disabled]="isLoadingModels || isProcessing || isUploading || availableModels.length === 0">
                    <option value="" *ngIf="availableModels.length === 0" disabled>No models available</option>
                    <option *ngFor="let model of availableModels" [value]="model">
                        {{ model }}
                    </option>
                </select>

                <!-- Show error indicator when loading fails -->
                <div class="model-error-indicator" *ngIf="modelsLoadError" [title]="modelsLoadError">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                    <span>Error</span>
                </div>

                <button class="model-refresh-btn" (click)="refreshModels()"
                    [disabled]="isLoadingModels || isProcessing || isUploading"
                    [title]="modelsLoadError ? 'Retry loading models' : 'Refresh models'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" [class.spin]="isLoadingModels">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="panel-content">
        <!-- Mode Selection Header -->
        <div class="mode-selection-header">
            <div class="mode-header-content">
                <div class="mode-header-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <div class="mode-header-text">
                    <h4 class="mode-header-title">Choose Your Workflow</h4>
                    <p class="mode-header-subtitle">Select between uploading new files or generating from history</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mode-toggle-tabs">
            <button class="mode-tab" [class.active]="currentTab === 'upload'" (click)="switchToTab('upload')"
                [disabled]="isAnyOperationInProgress">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                <span>Upload</span>
            </button>
            <button class="mode-tab" [class.active]="currentTab === 'generate'" (click)="switchToTab('generate')"
                [disabled]="isAnyOperationInProgress">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                </svg>
                <span>Generate</span>
            </button>
        </div>

        <!-- FLIP CARD WRAPPER -->
        <div class="flip-card-scene">
          <div class="flip-card-inner" [@cardFlip]="currentTab">

            <!-- UPLOAD TAB (Front Face) -->
            <div class="flip-face flip-face-front" [@flipFront]="currentTab">
              <div class="upload-content-wrapper">
            <div class="upload-fields-container">
                <!-- File Upload Area -->
                <div class="upload-area-wrapper">
                    <label class="upload-area-label">Lecture / Related file or folder</label>
                    <div class="file-upload-zone" [class.drag-over]="isDragging" [class.disabled]="isUploading"
                        (drop)="onFileDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                            </svg>
                        </div>
                        <h3 class="upload-title">Drop your subtitle file here</h3>
                        <p class="upload-subtitle">or</p>
                        <div class="upload-btn-wrapper">
                            <button class="browse-btn" (click)="fileInput.click()" [disabled]="isUploading">Browse
                                Files</button>
                        </div>
                        <input #fileInput type="file" class="file-input-hidden" multiple accept=".vtt,.srt"
                            (change)="onFileSelected($event)" [disabled]="isUploading">
                        <p class="upload-info">Supported formats: VTT, SRT</p>
                    </div>
                </div>

                <!-- Uploaded Files List -->
                <div class="selected-files-list" *ngIf="uploadedFilesWithStatus.length > 0">
                    <div class="selected-files-header">
                        <span class="selected-files-count">{{ uploadedFilesWithStatus.length }} file(s) selected</span>
                    </div>
                    <div class="selected-file" *ngFor="let fileWithStatus of uploadedFilesWithStatus; let i = index">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <span class="file-name-display">{{ fileWithStatus.file.name }}</span>
                        <span class="file-size">({{ (fileWithStatus.file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                        <span *ngIf="shouldShowStatusBadge(fileWithStatus)"
                            [className]="getStatusBadgeClass(fileWithStatus.status)">
                            {{ getStatusText(fileWithStatus.status) }}
                        </span>
                        <button class="remove-file-btn" (click)="removeIndividualFile(i)"
                            [disabled]="fileWithStatus.status === 'uploading' || isUploading">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Upload Action Buttons -->
            <div class="action-buttons">
                <button class="generate-btn" [disabled]="uploadedFilesWithStatus.length === 0 || isUploading"
                    (click)="onUpload()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    {{ isUploading ? 'Uploading...' : 'Upload' }}
                </button>
                <button class="reset-btn" (click)="onReset()" [disabled]="isUploading" *ngIf="!isUploading">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Reset
                </button>
            </div>

              </div> <!-- end upload-content-wrapper -->
            </div> <!-- end flip-face-front -->

            <!-- GENERATE TAB (Back Face) -->
            <div class="flip-face flip-face-back" [@flipBack]="currentTab">
              <div class="upload-content-wrapper">
            <div class="upload-fields-container">
                <!-- File Selection Area -->
                <div class="generate-file-selection">
                    <div class="selection-header">
                        <label class="summary-label">Select One File to Generate</label>
                    </div>

                    <!-- Drag and Drop Area (Empty State) -->
                    <div class="generate-drop-zone" *ngIf="!selectedGenerateFile" [class.drag-over]="isDraggingGenerate"
                        (drop)="onGenerateFileDrop($event)" (dragover)="onGenerateDragOver($event)"
                        (dragleave)="onGenerateDragLeave($event)">
                        <div class="drop-zone-content">
                            <div class="pointing-hand">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3 class="drop-zone-title">No File Selected</h3>
                            <p class="drop-zone-subtitle">Select a file from History to generate content</p>
                            <div class="drop-zone-hint">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                </svg>
                                <span>Click the <strong>+</strong> icon on any file in the History panel</span>
                            </div>
                        </div>
                    </div>

                    <!-- Selected File Display -->
                    <div class="selected-generate-file" *ngIf="selectedGenerateFile"
                        [class.file-highlighted]="isFileHighlighted">
                        <div class="selected-file-card">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="file-icon">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            <div class="file-info">
                                <span class="file-name">
                                    <span class="file-id">#{{ selectedGenerateFile.id }}</span> {{
                                    selectedGenerateFile.name }}
                                </span>
                                <span class="file-size" *ngIf="selectedGenerateFile.size > 0">
                                    {{ getFileSizeDisplay() }}
                                </span>
                                <span class="file-date" *ngIf="selectedGenerateFile.displayDate">
                                    {{ selectedGenerateFile.displayDate }}
                                </span>
                            </div>
                            <button class="remove-file-btn" (click)="removeGenerateFile()" [disabled]="isProcessing">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Optional Summary Prompts -->
                <div class="prompts-area">
                    <label class="prompts-label">Optional Summary Prompts</label>
                    <textarea class="prompts-textarea" [(ngModel)]="summaryPrompt" name="summaryPrompt"
                        [disabled]="isProcessing"
                        placeholder="Enter any specific instructions for summary generation...&#10;&#10;Example:&#10;- Focus on key findings&#10;- Include main topics&#10;- Highlight important insights"
                        rows="6"></textarea>
                    <p class="prompts-hint">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                        Add custom instructions to guide the summary generation
                    </p>
                </div>

                <!-- Optional FAQ Prompts -->
                <div class="prompts-area">
                    <label class="prompts-label">Optional FAQ Prompts</label>
                    <textarea class="prompts-textarea" [(ngModel)]="faqPrompt" name="faqPrompt"
                        [disabled]="isProcessing"
                        placeholder="Enter any specific instructions for FAQ generation...&#10;&#10;Example:&#10;- Generate 5-10 questions&#10;- Focus on common queries&#10;- Include technical details"
                        rows="6"></textarea>
                    <p class="prompts-hint">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                        Add custom instructions to guide the FAQ generation
                    </p>
                </div>

                <!-- Processing Progress Bar -->
                <div class="processing-container" *ngIf="isProcessing" [ngClass]="getProcessingStatusClass()">
                    <div class="processing-header">
                        <div class="processing-icon-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="processing-icon" *ngIf="generationStatus === 'generating'">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="processing-icon" *ngIf="generationStatus === 'success'">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="processing-icon" *ngIf="generationStatus === 'error'">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="processing-info">
                            <h4 class="processing-title">
                                {{ generationStatus === 'generating' ? 'Processing Your File' :
                                generationStatus === 'success' ? 'Generation Complete' :
                                'Generation Failed' }}
                            </h4>
                            <p class="processing-filename">{{ processingFileName }}</p>
                        </div>
                        <span class="processing-percentage">{{ processingProgress }}%</span>
                    </div>

                    <div class="progress-bar-container">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" [style.width.%]="processingProgress">
                                <div class="progress-bar-shimmer" *ngIf="generationStatus === 'generating'"></div>
                            </div>
                        </div>
                    </div>

                    <p class="processing-message">
                        {{ getProcessingStatusMessage() }}
                    </p>
                </div>
            </div>

            <!-- Generate Action Buttons -->
            <div class="action-buttons">
                <button class="generate-btn" [disabled]="!selectedGenerateFile || isProcessing"
                    (click)="handleGenerate()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                    </svg>
                    {{ isProcessing ? 'Processing...' : 'Generate' }}
                </button>
                <button class="reset-btn" [disabled]="isProcessing" (click)="onCancel()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Cancel
                </button>
            </div>
              </div> <!-- end upload-content-wrapper (generate) -->
            </div> <!-- end flip-face-back -->

          </div> <!-- end flip-card-inner -->
        </div> <!-- end flip-card-scene -->
    </div>
</div>











/* Upload-Generate Component Styles */
:host {
    display: flex;
    flex: 1;
    min-width: 0;
    min-height: 0;
}

.panel {
    flex: 1;
    background-color: var(--bg-color);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
}

.panel-header {
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
}

.panel-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
    position: relative;
    padding-left: 16px;
    flex-shrink: 0;
}

.panel-title::before {
    content: '';
    position: absolute;
    left: 0;
    width: 3px;
    height: 20px;
    background: var(--primary-gradient);
    border-radius: 2px;
}

.panel-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    overflow-x: hidden;
    color: var(--text-color);
    min-height: 0;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Scrollbar Styling */
.panel-content::-webkit-scrollbar {
    width: 6px;
}

.panel-content::-webkit-scrollbar-track {
    background: var(--scrollbar-track-bg);
    border-radius: 3px;
}

.panel-content::-webkit-scrollbar-thumb {
    background-color: var(--scrollbar-thumb-bg);
    border-radius: 3px;
}

.panel-content::-webkit-scrollbar-thumb:hover {
    background: var(--primary-gradient);
}

/* Prompts Textarea Scrollbar Styling */
.prompts-textarea::-webkit-scrollbar {
    width: 6px;
}

.prompts-textarea::-webkit-scrollbar-track {
    background: var(--scrollbar-track-bg);
    border-radius: 3px;
}

.prompts-textarea::-webkit-scrollbar-thumb {
    background-color: var(--scrollbar-thumb-bg);
    border-radius: 3px;
}

.prompts-textarea::-webkit-scrollbar-thumb:hover {
    background: var(--primary-gradient);
}

/* Mode Selection Header */
.mode-selection-header {
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    border: 1px solid var(--primary-border-color);
    border-radius: 12px;
    padding: 16px 20px;
    flex-shrink: 0;
}

.mode-header-content {
    display: flex;
    align-items: center;
    gap: 14px;
}

.mode-header-icon {
    width: 44px;
    height: 44px;
    background: var(--primary-gradient);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 4px 12px var(--primary-shadow);
}

.mode-header-icon svg {
    width: 24px;
    height: 24px;
    stroke: white;
}

.mode-header-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.mode-header-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
    letter-spacing: -0.01em;
}

.mode-header-subtitle {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.7;
    margin: 0;
    line-height: 1.4;
}

/* Model Selector Styles */
.model-selector-container {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-shrink: 0;
}

.model-selector-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.model-selector-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
}

.model-dropdown {
    padding: 6px 12px;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 120px;
}

.model-dropdown:hover:not(:disabled) {
    border-color: var(--primary-color);
    background-color: var(--footer-bg);
}

.model-dropdown:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-focus-shadow);
}

.model-dropdown:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Model Error Indicator */
.model-error-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background-color: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px;
    cursor: help;
    min-width: 120px;
}

.model-error-indicator svg {
    width: 16px;
    height: 16px;
    stroke: #ef4444;
    flex-shrink: 0;
}

.model-error-indicator span {
    font-size: 13px;
    font-weight: 500;
    color: #ef4444;
}

.model-refresh-btn {
    width: 32px;
    height: 32px;
    padding: 6px;
    background-color: var(--footer-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.model-refresh-btn:hover:not(:disabled) {
    background: var(--primary-gradient);
    border-color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px var(--primary-shadow);
}

.model-refresh-btn:hover:not(:disabled) svg {
    stroke: white;
}

.model-refresh-btn:active:not(:disabled) {
    transform: translateY(0);
}

.model-refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.model-refresh-btn svg {
    width: 18px;
    height: 18px;
    stroke: var(--text-color);
    transition: all 0.3s ease;
}

.model-refresh-btn svg.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }
}

/* Tab Navigation */
.mode-toggle-tabs {
    display: flex;
    gap: 8px;
    padding: 0;
    flex-shrink: 0;
}

.mode-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    background-color: var(--footer-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0.6;
}

.mode-tab svg {
    width: 18px;
    height: 18px;
    stroke: var(--text-color);
    transition: all 0.3s ease;
}

.mode-tab:hover:not(:disabled) {
    opacity: 1;
    border-color: var(--primary-color);
    background-color: var(--bg-color);
}

.mode-tab.active {
    background: var(--primary-gradient);
    border-color: var(--primary-color);
    color: white;
    opacity: 1;
    box-shadow: 0 4px 12px var(--primary-shadow);
}

.mode-tab.active svg {
    stroke: white;
}

.mode-tab:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* Upload Content Wrapper */
.upload-content-wrapper {
    display: flex;
    flex-direction: column;
    gap: 20px;
    flex: 1;
}

.upload-fields-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    flex: 1;
}

/* File Upload Area */
.upload-area-wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.upload-area-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.upload-area-label::before {
    content: '';
    font-size: 15px;
}

.file-upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 30px 24px;
    text-align: center;
    background-color: var(--bg-color);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.file-upload-zone.drag-over {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
}

.file-upload-zone:hover:not(.disabled) {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, var(--primary-gradient-lighter-start), var(--primary-gradient-lighter-end));
}

.file-upload-zone.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.upload-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-icon svg {
    width: 24px;
    height: 24px;
    stroke: var(--primary-color);
}

.upload-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0 0 6px 0;
}

.upload-subtitle {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.5;
    margin: 0 0 12px 0;
}

.upload-btn-wrapper {
    display: flex;
    justify-content: center;
    position: relative;
    z-index: 1;
}

.browse-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 20px;
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px var(--primary-shadow-light);
}

.browse-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--primary-shadow);
}

.browse-btn:active:not(:disabled) {
    transform: translateY(0);
}

.browse-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.file-input-hidden {
    display: none;
}

.upload-info {
    font-size: 11px;
    color: var(--text-color);
    opacity: 0.5;
    margin: 12px 0 0 0;
}

/* Selected Files List */
.selected-files-list {
    padding: 16px;
    background-color: var(--footer-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.selected-files-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

.selected-files-count {
    font-size: 13px;
    font-weight: 600;
    color: var(--primary-color);
}

.selected-file {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.selected-file:last-child {
    margin-bottom: 0;
}

.selected-file svg {
    width: 20px;
    height: 20px;
    stroke: var(--primary-color);
    flex-shrink: 0;
}

.file-name-display {
    flex: 1;
    font-size: 13px;
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    font-size: 11px;
    color: var(--text-color);
    opacity: 0.6;
    flex-shrink: 0;
}

.remove-file-btn {
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.remove-file-btn:hover:not(:disabled) {
    background-color: rgba(239, 68, 68, 0.1);
}

.remove-file-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.remove-file-btn svg {
    width: 16px;
    height: 16px;
    stroke: #ef4444;
}

/* Status Badge */
.status-badge {
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    line-height: 1.2;
}

.status-pending {
    background-color: rgba(156, 163, 175, 0.15);
    color: #6b7280;
    border: 1px solid rgba(156, 163, 175, 0.3);
}

.status-uploading {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.4);
    animation: pulse 1.5s ease-in-out infinite;
}

.status-uploaded {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.4);
}

.status-error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
}

@keyframes pulse {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0.6;
    }
}

/* Generate Tab */
.generate-file-selection {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.summary-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.summary-label::before {
    content: '';
    font-size: 15px;
}

.selection-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

/* Generate Drop Zone */
.generate-drop-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 48px 24px;
    text-align: center;
    background-color: var(--bg-color);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 280px;
}

.generate-drop-zone.drag-over {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    transform: scale(1.01);
}

.drop-zone-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.pointing-hand {
    width: 72px;
    height: 72px;
    margin: 0 auto;
    background: linear-gradient(135deg, var(--primary-gradient-medium-start), var(--primary-gradient-medium-end));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pointRight 2s ease-in-out infinite;
}

@keyframes pointRight {

    0%,
    100% {
        transform: translateX(0);
    }

    50% {
        transform: translateX(10px);
    }
}

.pointing-hand svg {
    width: 36px;
    height: 36px;
    stroke: var(--primary-color);
}

.drop-zone-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
}

.drop-zone-subtitle {
    font-size: 14px;
    color: var(--text-color);
    opacity: 0.6;
    margin: 0;
}

.drop-zone-hint {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    border: 1px solid var(--primary-border-color);
    border-radius: 8px;
    margin-top: 8px;
}

.drop-zone-hint svg {
    width: 20px;
    height: 20px;
    stroke: var(--primary-color);
    flex-shrink: 0;
}

.drop-zone-hint span {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.8;
}

.drop-zone-hint strong {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 14px;
}

/* Selected Generate File */
.selected-generate-file {
    padding: 16px;
    background-color: var(--footer-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.selected-file-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    border: 1px solid var(--primary-color);
    border-radius: 8px;
    box-shadow: 0 2px 8px var(--primary-shadow-lighter);
}

.selected-file-card .file-icon {
    width: 24px;
    height: 24px;
    stroke: var(--primary-color);
    flex-shrink: 0;
}

.selected-file-card .file-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
}

.selected-file-card .file-info .file-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.selected-file-card .file-info .file-size {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.6;
}

.selected-file-card .file-info .file-date {
    font-size: 11px;
    color: var(--text-color);
    opacity: 0.5;
    font-style: italic;
}

/* File ID styling - inline with file name */
.selected-file-card .file-info .file-id {
    display: inline;
    padding: 2px 6px;
    background: var(--primary-gradient);
    color: white;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    margin-right: 6px;
    letter-spacing: 0.3px;
}

/* Highlight animation for file addition */
.selected-generate-file.file-highlighted {
    animation: highlightPulse 5s ease-in-out;
}

.selected-generate-file.file-highlighted .selected-file-card {
    animation: highlightGlow 5s ease-in-out;
}

@keyframes highlightPulse {

    0%,
    100% {
        transform: scale(1);
    }

    2%,
    8%,
    14%,
    20% {
        transform: scale(1.02);
    }

    5%,
    11%,
    17% {
        transform: scale(1);
    }

    25% {
        transform: scale(1);
    }
}

@keyframes highlightGlow {
    0% {
        box-shadow: 0 2px 8px var(--primary-shadow-lighter);
        border-color: var(--primary-color);
    }

    5%,
    15%,
    25% {
        box-shadow: 0 0 0 4px var(--primary-glow-medium), 0 0 20px var(--primary-glow-strong);
        border-color: var(--primary-color);
    }

    10%,
    20%,
    30% {
        box-shadow: 0 0 0 2px var(--primary-glow-light), 0 0 12px var(--primary-glow-medium);
        border-color: var(--primary-color);
    }

    50% {
        box-shadow: 0 0 0 0 var(--primary-glow-lighter), 0 2px 8px var(--primary-shadow-lighter);
        border-color: var(--primary-color);
    }

    100% {
        box-shadow: 0 2px 8px var(--primary-shadow-lighter);
        border-color: var(--primary-color);
    }
}

/* Optional Prompts */
.prompts-area {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.prompts-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.prompts-label::before {
    content: '';
    font-size: 15px;
}

.prompts-textarea {
    width: 100%;
    padding: 12px;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 13px;
    color: var(--text-color);
    resize: vertical;
    font-family: inherit;
    transition: all 0.2s ease;
}

.prompts-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-focus-shadow);
}

.prompts-textarea::placeholder {
    color: var(--text-color);
    opacity: 0.5;
}

.prompts-textarea:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.prompts-hint {
    font-size: 11px;
    color: var(--text-color);
    opacity: 0.6;
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 0;
}

.prompts-hint svg {
    width: 14px;
    height: 14px;
    stroke: var(--primary-color);
}

/* Processing Container */
.processing-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 20px;
    background: linear-gradient(135deg, var(--primary-gradient-light-start), var(--primary-gradient-light-end));
    border: 1px solid var(--primary-border-color);
    border-radius: 12px;
}

.processing-header {
    display: flex;
    align-items: center;
    gap: 12px;
}

.processing-icon-wrapper {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--primary-gradient-medium-start), var(--primary-gradient-medium-end));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.processing-icon {
    width: 24px;
    height: 24px;
    stroke: var(--primary-color);
    animation: sparkle 2s ease-in-out infinite;
}

@keyframes sparkle {

    0%,
    100% {
        opacity: 1;
        transform: scale(1);
    }

    50% {
        opacity: 0.7;
        transform: scale(1.1);
    }
}

.processing-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.processing-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
}

.processing-filename {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.7;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.processing-percentage {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-color);
    flex-shrink: 0;
}

.progress-bar-container {
    width: 100%;
}

.progress-bar-track {
    width: 100%;
    height: 8px;
    background-color: var(--primary-progress-track);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: var(--primary-gradient-animated);
    background-size: 200% 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
    position: relative;
    animation: gradientShift 2s ease infinite;
}

@keyframes gradientShift {
    0% {
        background-position: 0% 50%;
    }

    50% {
        background-position: 100% 50%;
    }

    100% {
        background-position: 0% 50%;
    }
}

.progress-bar-shimmer {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% {
        left: -100%;
    }

    100% {
        left: 100%;
    }
}

.processing-message {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.7;
    margin: 0;
    text-align: center;
}

/* Processing status styles */
.processing-status-success .processing-container {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
    border-color: rgba(16, 185, 129, 0.3);
}

.processing-status-success .processing-icon {
    stroke: #10b981;
}

.processing-status-success .processing-title,
.processing-status-success .processing-percentage {
    color: #10b981;
}

.processing-status-success .progress-bar-fill {
    background: linear-gradient(90deg, #10b981, #059669);
}

.processing-status-error .processing-container {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05));
    border-color: rgba(239, 68, 68, 0.3);
}

.processing-status-error .processing-icon {
    stroke: #ef4444;
}

.processing-status-error .processing-title,
.processing-status-error .processing-percentage {
    color: #ef4444;
}

.processing-status-error .progress-bar-fill {
    background: linear-gradient(90deg, #ef4444, #dc2626);
}

.processing-status-error .processing-message {
    color: #ef4444;
    font-weight: 500;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 12px;
    padding-top: 8px;
    flex-shrink: 0;
}

.generate-btn,
.reset-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.generate-btn {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 2px 8px var(--primary-shadow-light);
}

.generate-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--primary-shadow);
}

.generate-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.generate-btn svg,
.reset-btn svg {
    width: 16px;
    height: 16px;
}

.reset-btn {
    background-color: var(--footer-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.reset-btn:hover:not(:disabled) {
    background-color: var(--bg-color);
    border-color: var(--primary-color);
}

/* ===== FLIP CARD ANIMATION ===== */
.flip-card-scene {
    flex: 1;
    perspective: 1200px;
    min-height: 0;
    display: flex;
    flex-direction: column;
}

.flip-card-inner {
    flex: 1;
    position: relative;
    transform-style: preserve-3d;
    min-height: 0;
    display: flex;
    flex-direction: column;
}

.flip-face {
    position: absolute;
    inset: 0;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
}

.flip-face-front {
    transform: rotateY(0deg);
}

.flip-face-back {
    transform: rotateY(180deg);
}
