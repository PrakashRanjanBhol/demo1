import { Component, Input, OnChanges, SimpleChanges } from '@angular/core';

@Component({
  selector: 'app-chat',
  templateUrl: './chat.component.html',
  styleUrls: ['./chat.component.css']
})
export class ChatComponent implements OnChanges {
  @Input() chunk: string = '';   // incoming streamed chunk from parent

  htmlCode: string = '';
  cssCode: string = '';
  jsCode: string = '';

  private currentLang: string | null = null;
  private isInsideBlock = false;

  ngOnChanges(changes: SimpleChanges): void {
    if (changes['chunk'] && this.chunk) {
      this.processChunk(this.chunk);
    }
  }

  private processChunk(chunk: string): void {
    const lines = chunk.split(/\r?\n/);

    for (let line of lines) {
      if (line.startsWith('```')) {
        if (!this.isInsideBlock) {
          // Opening a block
          this.isInsideBlock = true;
          this.currentLang = line.replace(/```/, '').trim().toLowerCase();
        } else {
          // Closing the block
          this.isInsideBlock = false;
          this.currentLang = null;
        }
        continue;
      }

      if (this.isInsideBlock && this.currentLang) {
        switch (this.currentLang) {
          case 'html':
            this.htmlCode += line + '\n';
            break;
          case 'css':
            this.cssCode += line + '\n';
            break;
          case 'js':
          case 'javascript':
            this.jsCode += line + '\n';
            break;
        }
      }
    }
  }
}
