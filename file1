// Initiate SSO login with WebSocket
initiateSSO(): Observable<any> {
  return new Observable(observer => {
    // Clear all localStorage data before starting SSO
    localStorage.clear();
    this.currentUserSubject.next(null);
    
    // Create WebSocket connection
    this.ws = new WebSocket(this.wsUrl);

    this.ws.onopen = () => {
      console.log('WebSocket connection opened');
      
      // Send initial message
      const message = {
        rqtype: environment.SSO.RQTYPE,
        token: '',
        data: environment.SSO.DATA
      };
      
      this.ws?.send(JSON.stringify(message));
    };

    this.ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        
        if (msg?.rpcode === 'RETURN_SUCCESS') {
          // Success - parse the data and make SSO API call
          const ssoInfo = JSON.parse(msg?.data);
          const request = {
            userInfo: ssoInfo.userInfo,
            aeskey: ssoInfo.key
          };
          
          this.performSSOLogin(request).subscribe({
            next: (response) => {
              observer.next(response);
              observer.complete();
              // WebSocket connection stays open
            },
            error: (error) => {
              observer.error(error);
              this.closeWebSocket();
            }
          });
        } else {
          // SSO login failed
          const errorMsg = 'SSO login failed';
          this.ssoErrorSubject.next(errorMsg);
          observer.error(new Error(errorMsg));
          this.closeWebSocket();
        }
      } catch (error) {
        observer.error(error);
        this.closeWebSocket();
      }
    };

    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      observer.error(new Error('WebSocket connection error'));
      this.closeWebSocket();
    };

    this.ws.onclose = () => {
      console.log('WebSocket connection closed');
      // Trigger logout when WebSocket closes
      this.logout();
    };
  });
}
