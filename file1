<!-- Repository Sidebar Component -->
<div class="repository-sidebar">
  <!-- Header -->
  <div class="sidebar-header">
    <h2 class="sidebar-title">Repositories</h2>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'all'"
      (click)="setActiveTab('all')">
      All Repository
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'favorites'"
      (click)="setActiveTab('favorites')">
      Favorites
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- ALL REPOSITORY TAB -->
    <div *ngIf="activeTab === 'all'">
      
      <!-- All Projects View -->
      <div id="all-projects-view" *ngIf="showAllProjectsView">
        <!-- Search Box for Projects -->
        <div class="search-container">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" 
                   class="search-input" 
                   placeholder="Search projects..."
                   [(ngModel)]="projectSearchText">
            <button class="clear-search-btn" 
                    *ngIf="projectSearchText"
                    (click)="projectSearchText = ''">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="search-results-count" *ngIf="projectSearchText">
            {{ filteredProjects.length }} of {{ allProjects.length }} projects
          </div>
        </div>

        <!-- Project Cards -->
        <div class="project-card" 
             *ngFor="let project of filteredProjects; trackBy: trackByProjectKey"
             (click)="showRepositories(project.project_key)">
          <div class="project-name">{{ project.project_name }}</div>
          <div class="project-info">{{ project.project_url }}</div>
          <div class="repo-count">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            {{ getRepoCount(project.project_key) }} repositories
          </div>
        </div>

        <!-- No Results -->
        <div class="no-results" *ngIf="projectSearchText && filteredProjects.length === 0">
          <svg class="no-results-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <div class="no-results-text">No projects found</div>
          <div class="no-results-hint">Try a different search term</div>
        </div>
      </div>

      <!-- All Repository View -->
      <div id="all-repos-view" *ngIf="showAllReposView">
        <div class="view-header">
          <button class="back-button" (click)="backToProjects()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
          </button>
          <div class="view-title">{{ currentProject?.project_name }}</div>
        </div>

        <!-- Search Box for Repositories -->
        <div class="search-container">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" 
                   class="search-input" 
                   placeholder="Search repositories..."
                   [(ngModel)]="repoSearchText">
            <button class="clear-search-btn" 
                    *ngIf="repoSearchText"
                    (click)="repoSearchText = ''">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="search-results-count" *ngIf="repoSearchText">
            {{ displayedRepositories.length }} of {{ currentRepositories.length }} repositories
          </div>
        </div>

        <!-- Repository List -->
        <div id="repos-list">
          <div class="repo-card" 
               *ngFor="let repo of displayedRepositories; trackBy: trackByRepoKey"
               [class.loading]="loadingRepos[repo.repo_key]">
            <div class="repo-header">
              <div class="repo-info-section" 
                   (click)="openRepositoryWithLoading(repo.repo_key, repo.repo_name)">
                <div class="repo-name">{{ repo.repo_name }}</div>
                <div class="repo-description" [title]="repo.repo_url">
                  {{ repo.repo_url }}
                </div>
              </div>
              <button class="star-button" 
                      [class.favorited]="isFavoriteRepo(repo.repo_key)"
                      (click)="toggleFavorite(repo.repo_key, currentProject?.project_key || '', $event)">
                <div class="spinner" *ngIf="loadingRepos[repo.repo_key]"></div>
                <svg *ngIf="!loadingRepos[repo.repo_key]" 
                     viewBox="0 0 24 24" 
                     fill="none" 
                     stroke="currentColor" 
                     stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
              </button>
            </div>
          </div>

          <!-- No Results -->
          <div class="no-results" *ngIf="repoSearchText && displayedRepositories.length === 0">
            <svg class="no-results-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <div class="no-results-text">No repositories found</div>
            <div class="no-results-hint">Try a different search term</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FAVORITES TAB -->
    <div *ngIf="activeTab === 'favorites'">
      
      <!-- Favorites Projects View -->
      <div id="favorites-projects-view" *ngIf="showFavoritesProjectsView">
        <div class="project-card" 
             *ngFor="let project of favoritesGroupedByProject; trackBy: trackByProjectKey"
             (click)="showFavoritesRepositories(project.project_key)">
          <div class="project-name">{{ project.project_name }}</div>
          <div class="project-info">{{ project.project_url }}</div>
          <div class="repo-count">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            {{ project.repo_count }} repositories
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="favoritesGroupedByProject.length === 0">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
          </svg>
          <div class="empty-state-text">No favorite repositories yet</div>
        </div>
      </div>

      <!-- Favorites Repos View -->
      <div id="favorites-repos-view" *ngIf="showFavoritesReposView">
        <div class="view-header">
          <button class="back-button" (click)="backToFavoritesProjects()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
          </button>
          <div class="view-title">{{ currentFavoritesProject?.project_name }}</div>
        </div>

        <!-- Favorites Repository List -->
        <div id="favorites-repos-list">
          <div class="repo-card" 
               *ngFor="let repo of currentFavoritesRepos; trackBy: trackByRepoKey">
            <div class="repo-header">
              <div class="repo-info-section" 
                   (click)="openRepositoryWithLoading(repo.repo_key, repo.repo_name)">
                <div class="repo-name">{{ repo.repo_name }}</div>
                <div class="repo-description" [title]="repo.repo_url">
                  {{ repo.repo_url }}
                </div>
              </div>
              <button class="star-button favorited" 
                      (click)="toggleFavorite(repo.repo_key, currentFavoritesProject?.project_key || '', $event)">
                <svg viewBox="0 0 24 24" 
                     fill="none" 
                     stroke="currentColor" 
                     stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Favorites Browser View -->
      <div id="favorites-browser-view" *ngIf="showFavoritesBrowserView">
        <div class="view-header">
          <button class="back-button" (click)="backToFavoritesRepos()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
          </button>
          <div class="view-title">{{ currentRepo?.name }}</div>
        </div>

        <!-- Branch Selector -->
        <div class="branch-selector-container">
          <div class="branch-selector-header" (click)="toggleBranchSelector()">
            <div class="branch-info">
              <svg class="branch-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="6" y1="3" x2="6" y2="15"></line>
                <circle cx="18" cy="6" r="3"></circle>
                <circle cx="6" cy="18" r="3"></circle>
                <path d="M18 9a9 9 0 0 1-9 9"></path>
              </svg>
              <div class="branch-details">
                <span class="branch-label">Branch</span>
                <span class="branch-name">{{ selectedBranch }}</span>
              </div>
            </div>
            <div class="header-actions">
              <span class="branch-count" *ngIf="branches.length > 0">{{ branches.length }}</span>
              <svg class="toggle-icon" 
                   [class.rotated]="branchSelectorVisible"
                   viewBox="0 0 24 24" 
                   fill="none" 
                   stroke="currentColor" 
                   stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>
          
          <!-- Branch Selector Dropdown -->
          <div class="branch-selector-content" [class.visible]="branchSelectorVisible">
            <!-- Search Box -->
            <div class="branch-search">
              <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="text" 
                     class="branch-search-input" 
                     placeholder="Search branches..."
                     [(ngModel)]="branchSearchText"
                     (click)="$event.stopPropagation()"
                     #searchInput>
              <button class="clear-search-btn" 
                      *ngIf="branchSearchText"
                      (click)="branchSearchText = ''; searchInput.focus(); $event.stopPropagation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            
            <!-- Branch List -->
            <div class="branch-list">
              <div class="branch-option" 
                   *ngFor="let branch of filteredBranches"
                   [class.selected]="branch === selectedBranch"
                   (click)="selectBranch(branch); $event.stopPropagation()">
                <div class="branch-option-content">
                  <svg class="branch-option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="6" y1="3" x2="6" y2="15"></line>
                    <circle cx="18" cy="6" r="3"></circle>
                    <circle cx="6" cy="18" r="3"></circle>
                    <path d="M18 9a9 9 0 0 1-9 9"></path>
                  </svg>
                  <span class="branch-option-text">{{ branch }}</span>
                </div>
                <svg class="check-icon" 
                     *ngIf="branch === selectedBranch"
                     viewBox="0 0 24 24" 
                     fill="none" 
                     stroke="currentColor" 
                     stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              
              <!-- No Results -->
              <div class="no-results" *ngIf="filteredBranches.length === 0">
                <svg class="no-results-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
                <span class="no-results-text">No branches found</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
          <span class="breadcrumb-item" 
                *ngFor="let item of currentPath; let i = index"
                (click)="navigateToPath(i)">
            {{ item }}
            <span class="breadcrumb-separator" *ngIf="i < currentPath.length - 1">/</span>
          </span>
        </div>

        <!-- Files List -->
        <div id="favorites-files-list">
          <div *ngIf="loadingFiles" class="loading-state">
            <div class="spinner"></div>
            <div class="loading-text">Loading files...</div>
          </div>

          <div *ngIf="!loadingFiles">
            <div class="empty-state" *ngIf="currentFolderItems.length === 0">
              <div class="empty-state-text">Empty folder</div>
            </div>

            <div class="file-item" 
                 *ngFor="let item of currentFolderItems; trackBy: trackByFileName"
                 [class.clickable]="item.isFolder"
                 (click)="item.isFolder && openFolder(item.name)"
                 (dblclick)="!item.isFolder && handleFileDoubleClick(item.name)"
                 (contextmenu)="!item.isFolder && onFileRightClick($event, item.name)">
              <svg class="file-icon" 
                   [class.folder-icon]="item.isFolder"
                   [class.file-icon-default]="!item.isFolder"
                   viewBox="0 0 24 24" 
                   fill="none" 
                   stroke="currentColor" 
                   stroke-width="2">
                <path *ngIf="item.isFolder" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path>
                <path *ngIf="!item.isFolder" d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline *ngIf="!item.isFolder" points="13 2 13 9 20 9"></polyline>
              </svg>
              <span class="file-name">{{ item.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>















import { Component, OnInit } from '@angular/core';

// Interfaces
interface Project {
  project_key: string;
  project_name: string;
  project_url: string;
}

interface Repository {
  repo_key: string;
  repo_name: string;
  repo_url: string;
}

interface FileSystemItem {
  name: string;
  type: 'file' | 'folder';
  children?: FileSystemItem[];
}

@Component({
  selector: 'app-repository-sidebar',
  templateUrl: './repository-sidebar.component.html',
  styleUrls: ['./repository-sidebar.component.css']
})
export class RepositorySidebarComponent implements OnInit {
  
  // ========================================
  // Properties
  // ========================================
  
  // Tab Management
  activeTab: 'all' | 'favorites' = 'all';
  
  // Projects and Repositories
  allProjects: Project[] = [];
  repositoriesByProject: { [key: string]: Repository[] } = {};
  favoriteRepositories: Repository[] = [];
  
  // File System
  fileSystem: FileSystemItem[] = [];
  
  // Favorite Repos State
  favoriteRepos: string[] = [];
  
  // Current State
  currentProject: Project | null = null;
  currentPath: string[] = ['root'];
  currentRepo: { id: string; name: string } | null = null;
  
  // Branch Management
  branches: string[] = ['main', 'develop', 'feature/new-ui', 'hotfix/bug-123'];
  selectedBranch: string = 'main';
  branchSelectorVisible: boolean = false;
  branchSearchText: string = '';
  
  // View State
  showAllProjectsView: boolean = true;
  showAllReposView: boolean = false;
  showFavoritesProjectsView: boolean = true;
  showFavoritesReposView: boolean = false;
  showFavoritesBrowserView: boolean = false;
  
  // Loading States
  loadingRepos: { [key: string]: boolean } = {};
  loadingFiles: boolean = false;
  
  // Favorites Tab State
  currentFavoritesProject: Project | null = null;
  currentFavoritesRepos: Repository[] = [];
  
  // Search
  projectSearchText: string = '';
  repoSearchText: string = '';
  
  // ========================================
  // Cache Properties for Performance
  // ========================================
  
  // File Browser Cache
  private _currentFolderItems: { name: string; isFolder: boolean }[] = [];
  private _lastPath: string = '';
  
  // Repository Cache
  private _cachedRepositories: Repository[] = [];
  private _lastProjectKey: string = '';
  
  // Favorites Cache
  private _favoriteRepoKeys: Set<string> = new Set();
  
  // Project Repo Counts Cache
  private _projectRepoCounts: { [key: string]: number } = {};
  
  // Filtered Projects Cache
  private _filteredProjects: Project[] = [];
  private _lastProjectSearchText: string = '';
  
  // Filtered Repositories Cache
  private _displayedRepositories: Repository[] = [];
  private _lastRepoSearchText: string = '';
  private _lastCurrentReposLength: number = 0;
  
  // ========================================
  // Lifecycle
  // ========================================
  
  ngOnInit(): void {
    this.loadProjects();
    this.loadFavorites();
    
    // Build caches on init
    this.updateFavoriteKeysCache();
    this.updateProjectRepoCountsCache();
  }
  
  // ========================================
  // Data Loading
  // ========================================
  
  private loadProjects(): void {
    // Mock data - Replace with actual API call
    this.allProjects = [
      {
        project_key: 'ECOM',
        project_name: 'E-Commerce Platform',
        project_url: 'https://bitbucket.org/workspace/ecommerce'
      },
      {
        project_key: 'MOBILE',
        project_name: 'Mobile Banking App',
        project_url: 'https://bitbucket.org/workspace/mobile-banking'
      },
      {
        project_key: 'ANALYTICS',
        project_name: 'Analytics Dashboard',
        project_url: 'https://bitbucket.org/workspace/analytics'
      },
      {
        project_key: 'API',
        project_name: 'API Gateway',
        project_url: 'https://bitbucket.org/workspace/api-gateway'
      }
    ];
    
    this.repositoriesByProject = {
      'ECOM': [
        {
          repo_key: 'ecom-frontend',
          repo_name: 'frontend-app',
          repo_url: 'https://bitbucket.org/workspace/ecommerce/frontend-app'
        },
        {
          repo_key: 'ecom-backend',
          repo_name: 'backend-api',
          repo_url: 'https://bitbucket.org/workspace/ecommerce/backend-api'
        },
        {
          repo_key: 'ecom-mobile',
          repo_name: 'mobile-app',
          repo_url: 'https://bitbucket.org/workspace/ecommerce/mobile-app'
        }
      ],
      'MOBILE': [
        {
          repo_key: 'mobile-ios',
          repo_name: 'ios-app',
          repo_url: 'https://bitbucket.org/workspace/mobile-banking/ios-app'
        },
        {
          repo_key: 'mobile-android',
          repo_name: 'android-app',
          repo_url: 'https://bitbucket.org/workspace/mobile-banking/android-app'
        }
      ],
      'ANALYTICS': [
        {
          repo_key: 'analytics-dashboard',
          repo_name: 'dashboard',
          repo_url: 'https://bitbucket.org/workspace/analytics/dashboard'
        },
        {
          repo_key: 'analytics-backend',
          repo_name: 'backend',
          repo_url: 'https://bitbucket.org/workspace/analytics/backend'
        }
      ],
      'API': [
        {
          repo_key: 'api-gateway',
          repo_name: 'gateway',
          repo_url: 'https://bitbucket.org/workspace/api-gateway/gateway'
        }
      ]
    };
    
    // Build cache after loading
    this.updateProjectRepoCountsCache();
  }
  
  private loadFavorites(): void {
    // Mock data - Replace with actual API call
    this.favoriteRepositories = [
      {
        repo_key: 'ecom-frontend',
        repo_name: 'frontend-app',
        repo_url: 'https://bitbucket.org/workspace/ecommerce/frontend-app'
      },
      {
        repo_key: 'mobile-ios',
        repo_name: 'ios-app',
        repo_url: 'https://bitbucket.org/workspace/mobile-banking/ios-app'
      }
    ];
  }
  
  // ========================================
  // Tab Management
  // ========================================
  
  setActiveTab(tab: 'all' | 'favorites'): void {
    this.activeTab = tab;
    
    if (tab === 'all') {
      this.showAllProjectsView = true;
      this.showAllReposView = false;
      this.showFavoritesProjectsView = false;
      this.showFavoritesReposView = false;
      this.showFavoritesBrowserView = false;
    } else {
      this.showAllProjectsView = false;
      this.showAllReposView = false;
      this.showFavoritesProjectsView = true;
      this.showFavoritesReposView = false;
      this.showFavoritesBrowserView = false;
    }
  }
  
  // ========================================
  // Project Management
  // ========================================
  
  showRepositories(projectKey: string): void {
    this.currentProject = this.allProjects.find(p => p.project_key === projectKey) || null;
    if (!this.currentProject) return;

    this.repoSearchText = ''; // Clear repo search
    this.showAllProjectsView = false;
    this.showAllReposView = true;
  }
  
  backToProjects(): void {
    this.showAllReposView = false;
    this.showAllProjectsView = true;
    this.currentProject = null;
    this.repoSearchText = ''; // Clear repo search
  }
  
  // ========================================
  // Cached Getters for Performance
  // ========================================
  
  // Current repositories for selected project (cached)
  get currentRepositories(): Repository[] {
    const projectKey = this.currentProject?.project_key || '';
    
    // Only recalculate if project changed
    if (this._lastProjectKey !== projectKey) {
      this._lastProjectKey = projectKey;
      this._cachedRepositories = this.repositoriesByProject[projectKey] || [];
    }
    
    return this._cachedRepositories;
  }
  
  // Displayed repositories with search filter (memoized)
  get displayedRepositories(): Repository[] {
    const currentReposLength = this.currentRepositories.length;
    
    // Only recalculate if search text or repos changed
    if (this._lastRepoSearchText !== this.repoSearchText || 
        this._lastCurrentReposLength !== currentReposLength) {
      this._lastRepoSearchText = this.repoSearchText;
      this._lastCurrentReposLength = currentReposLength;
      
      if (!this.repoSearchText.trim()) {
        this._displayedRepositories = this.currentRepositories;
      } else {
        const searchLower = this.repoSearchText.toLowerCase();
        this._displayedRepositories = this.currentRepositories.filter(repo => 
          repo.repo_name.toLowerCase().includes(searchLower) ||
          repo.repo_url.toLowerCase().includes(searchLower)
        );
      }
    }
    
    return this._displayedRepositories;
  }
  
  // Filtered projects with search (memoized)
  get filteredProjects(): Project[] {
    // Only recalculate if search text changed
    if (this._lastProjectSearchText !== this.projectSearchText) {
      this._lastProjectSearchText = this.projectSearchText;
      
      if (!this.projectSearchText.trim()) {
        this._filteredProjects = this.allProjects;
      } else {
        const searchLower = this.projectSearchText.toLowerCase();
        this._filteredProjects = this.allProjects.filter(project => 
          project.project_name.toLowerCase().includes(searchLower) ||
          project.project_key.toLowerCase().includes(searchLower) ||
          project.project_url.toLowerCase().includes(searchLower)
        );
      }
    }
    
    return this._filteredProjects;
  }
  
  // Fast favorite check using Set (O(1) instead of O(n))
  isFavoriteRepo(repoKey: string): boolean {
    return this._favoriteRepoKeys.has(repoKey);
  }
  
  // Get repo count from cache
  getRepoCount(projectKey: string): number {
    return this._projectRepoCounts[projectKey] || 0;
  }
  
  // ========================================
  // Cache Builders
  // ========================================
  
  private updateFavoriteKeysCache(): void {
    this._favoriteRepoKeys = new Set(
      this.favoriteRepositories.map(repo => repo.repo_key)
    );
  }
  
  private updateProjectRepoCountsCache(): void {
    this._projectRepoCounts = {};
    
    for (const projectKey in this.repositoriesByProject) {
      this._projectRepoCounts[projectKey] = this.repositoriesByProject[projectKey].length;
    }
  }
  
  // ========================================
  // Repository Actions
  // ========================================
  
  openRepositoryWithLoading(repoId: string, repoName: string): void {
    this.loadingRepos[repoId] = true;

    setTimeout(() => {
      this.openRepository(repoId, repoName);
      this.loadingRepos[repoId] = false;
    }, 1000);
  }
  
  openRepository(repoId: string, repoName: string): void {
    this.currentRepo = { id: repoId, name: repoName };
    this.currentPath = ['root'];
    
    // Reset cache when switching repos
    this._lastPath = '';
    this._currentFolderItems = [];
    this.fileSystem = [];
    
    this.showFavoritesReposView = false;
    this.showFavoritesBrowserView = true;
    this.loadingFiles = true;

    // Simulate API call
    setTimeout(() => {
      this.fileSystem = this.getMockFileSystemData();
      this._lastPath = ''; // Force cache refresh
      this.loadingFiles = false;
    }, 1500);
  }
  
  toggleFavorite(repoKey: string, projectKey: string, event: Event): void {
    event.stopPropagation();
    
    this.loadingRepos[repoKey] = true;

    setTimeout(() => {
      const index = this.favoriteRepositories.findIndex(r => r.repo_key === repoKey);
      
      if (index > -1) {
        this.favoriteRepositories.splice(index, 1);
      } else {
        const repos = this.repositoriesByProject[projectKey] || [];
        const repo = repos.find(r => r.repo_key === repoKey);
        if (repo) {
          this.favoriteRepositories.push(repo);
        }
      }
      
      // Refresh favorites cache
      this.updateFavoriteKeysCache();
      this.loadingRepos[repoKey] = false;
    }, 500);
  }
  
  // ========================================
  // Branch Management
  // ========================================
  
  get filteredBranches(): string[] {
    if (!this.branchSearchText.trim()) {
      return this.branches;
    }
    
    const searchLower = this.branchSearchText.toLowerCase();
    return this.branches.filter(branch => 
      branch.toLowerCase().includes(searchLower)
    );
  }
  
  toggleBranchSelector(): void {
    this.branchSelectorVisible = !this.branchSelectorVisible;
    
    // Clear search when closing
    if (!this.branchSelectorVisible) {
      this.branchSearchText = '';
    }
  }
  
  selectBranch(branch: string): void {
    this.selectedBranch = branch;
    this.branchSelectorVisible = false;
    this.branchSearchText = '';
  }
  
  // ========================================
  // File Browser
  // ========================================
  
  // Memoized getter for current folder items
  get currentFolderItems(): { name: string; isFolder: boolean }[] {
    const currentPathKey = this.currentPath.join('/');
    
    // Only recalculate if path changed
    if (this._lastPath !== currentPathKey) {
      this._lastPath = currentPathKey;
      this._currentFolderItems = this.calculateFolderItems();
    }
    
    return this._currentFolderItems;
  }
  
  // Calculate folder items from array-based file system
  private calculateFolderItems(): { name: string; isFolder: boolean }[] {
    let currentItems: FileSystemItem[] = this.fileSystem;
    
    // Navigate through path (skip 'root' at index 0)
    for (let i = 1; i < this.currentPath.length; i++) {
      const folderName = this.currentPath[i];
      const folder = currentItems.find(item => item.name === folderName && item.type === 'folder');
      
      if (folder && folder.children) {
        currentItems = folder.children;
      } else {
        return [];
      }
    }
    
    // Convert to format expected by template
    const items = currentItems.map(item => ({
      name: item.name,
      isFolder: item.type === 'folder'
    }));
    
    // Sort: Folders first, then files (alphabetically)
    return items.sort((a, b) => {
      // Folders come before files
      if (a.isFolder && !b.isFolder) return -1;
      if (!a.isFolder && b.isFolder) return 1;
      
      // Both same type: sort alphabetically (case-insensitive, numeric-aware)
      return a.name.localeCompare(b.name, undefined, {
        numeric: true,
        sensitivity: 'base'
      });
    });
  }
  
  openFolder(folderName: string): void {
    this.currentPath.push(folderName);
  }
  
  navigateToPath(index: number): void {
    this.currentPath = this.currentPath.slice(0, index + 1);
  }
  
  handleFileDoubleClick(fileName: string): void {
    console.log('File double-clicked:', fileName);
    // Implement file open logic here
  }
  
  onFileRightClick(event: MouseEvent, fileName: string): void {
    event.preventDefault();
    console.log('File right-clicked:', fileName);
    // Implement context menu logic here
  }
  
  // ========================================
  // Favorites Tab Management
  // ========================================
  
  get favoritesGroupedByProject(): (Project & { repo_count: number })[] {
    const projectMap = new Map<string, { project: Project; count: number }>();
    
    this.favoriteRepositories.forEach(repo => {
      for (const projectKey in this.repositoriesByProject) {
        const repos = this.repositoriesByProject[projectKey];
        if (repos.some(r => r.repo_key === repo.repo_key)) {
          const project = this.allProjects.find(p => p.project_key === projectKey);
          if (project) {
            if (!projectMap.has(projectKey)) {
              projectMap.set(projectKey, { project, count: 0 });
            }
            projectMap.get(projectKey)!.count++;
          }
          break;
        }
      }
    });
    
    return Array.from(projectMap.values()).map(({ project, count }) => ({
      ...project,
      repo_count: count
    }));
  }
  
  showFavoritesRepositories(projectKey: string): void {
    this.currentFavoritesProject = this.allProjects.find(p => p.project_key === projectKey) || null;
    
    this.currentFavoritesRepos = this.favoriteRepositories.filter(repo => {
      const repos = this.repositoriesByProject[projectKey] || [];
      return repos.some(r => r.repo_key === repo.repo_key);
    });
    
    this.showFavoritesProjectsView = false;
    this.showFavoritesReposView = true;
  }
  
  backToFavoritesProjects(): void {
    this.showFavoritesReposView = false;
    this.showFavoritesProjectsView = true;
    this.currentFavoritesProject = null;
  }
  
  backToFavoritesRepos(): void {
    this.showFavoritesBrowserView = false;
    this.showFavoritesReposView = true;
  }
  
  // ========================================
  // TrackBy Functions for Performance
  // ========================================
  
  trackByProjectKey(index: number, project: Project): string {
    return project.project_key;
  }
  
  trackByRepoKey(index: number, repo: Repository): string {
    return repo.repo_key;
  }
  
  trackByFileName(index: number, item: { name: string; isFolder: boolean }): string {
    return item.name;
  }
  
  // ========================================
  // Mock Data
  // ========================================
  
  private getMockFileSystemData(): FileSystemItem[] {
    return [
      {
        name: 'src',
        type: 'folder',
        children: [
          {
            name: 'components',
            type: 'folder',
            children: [
              { name: 'Header.tsx', type: 'file' },
              { name: 'Footer.tsx', type: 'file' },
              { name: 'Sidebar.tsx', type: 'file' }
            ]
          },
          {
            name: 'utils',
            type: 'folder',
            children: [
              { name: 'api.ts', type: 'file' },
              { name: 'helpers.ts', type: 'file' }
            ]
          },
          { name: 'App.tsx', type: 'file' },
          { name: 'index.ts', type: 'file' }
        ]
      },
      {
        name: 'public',
        type: 'folder',
        children: [
          { name: 'index.html', type: 'file' },
          { name: 'favicon.ico', type: 'file' }
        ]
      },
      { name: 'package.json', type: 'file' },
      { name: 'README.md', type: 'file' },
      { name: '.gitignore', type: 'file' }
    ];
  }
}


