import { Component, EventEmitter, Output, OnDestroy } from '@angular/core';
import { HttpEventType } from '@angular/common/http';
import { Subscription } from 'rxjs';
import { UploadResponse, UploadService } from 'src/app/services/upload.service';
import { GenerateService } from 'src/app/services/generate.service';
import { ModelService } from 'src/app/services/model.service';

interface UploadFile {
  id: number;
  name: string;
  uploadDate: Date;
  insertedAt: string;
}

interface FileWithStatus {
  file: File;
  status: 'pending' | 'uploading' | 'uploaded' | 'error';
  progress?: number;
  uploadedFileId?: string;
}

interface GenerateRequest {
  fileID: string | number;
  optional_prompt: string;
  model_name: string;
}

@Component({
  selector: 'app-upload-generate',
  templateUrl: './upload-generate.component.html',
  styleUrls: ['./upload-generate.component.css']
})
export class UploadGenerateComponent implements OnDestroy {
  @Output() onGenerate = new EventEmitter<{ file: any, prompts: string, mode: 'new' | 'previous' }>();

  isDragging: boolean = false;
  optionalPrompts: string = '';
  isProcessing: boolean = false;
  processingProgress: number = 0;
  processingFileName: string = '';

  currentStep: number = 1;
  uploadedFilesWithStatus: FileWithStatus[] = [];
  selectedUploadFile: File | null = null;

  uploadMode: 'new' | 'previous' = 'new';
  allUploadedFiles: UploadFile[] = [];
  selectedPreviousFile: UploadFile | null = null;

  private subscriptions: Subscription[] = [];

  private filesLoaded: boolean = false;
  isLoadingFiles: boolean = false;

  selectedStartDate: Date = new Date();
  selectedEndDate: Date = new Date();

  uploadStarted: boolean = false;

  // Model dropdown properties
  availableModels: string[] = [];
  selectedModel: string = '';
  isLoadingModels: boolean = false;
  showModelDropdown: boolean = false;

  // Cached computed values
  private _hasUploadingOrUploadedCache: boolean = false;
  private _hasSuccessfulUploadCache: boolean = false;
  private _needsRecalculation: boolean = true;

  constructor(
    private uploadService: UploadService,
    private generateService: GenerateService,
    private modelService: ModelService
  ) {
    // Initialize date range to last 30 days
    this.selectedEndDate = new Date();
    this.selectedStartDate = new Date();
    this.selectedStartDate.setDate(this.selectedStartDate.getDate() - 30);
    
    // Load models on component initialization
    this.loadModels();
  }

  ngOnDestroy(): void {
    this.subscriptions.forEach(sub => sub.unsubscribe());
  }

  loadModels(): void {
    this.isLoadingModels = true;
    const sub = this.modelService.getModels().subscribe({
      next: (models) => {
        this.availableModels = models;
        if (models.length > 0) {
          this.selectedModel = models[0];
        }
        this.isLoadingModels = false;
      },
      error: (error) => {
        console.error('Error loading models:', error);
        this.availableModels = [];
        this.isLoadingModels = false;
      }
    });
    this.subscriptions.push(sub);
  }

  toggleModelDropdown(): void {
    this.showModelDropdown = !this.showModelDropdown;
  }

  selectModel(model: string): void {
    this.selectedModel = model;
    this.showModelDropdown = false;
  }

  loadPreviousFiles(): void {
    this.isLoadingFiles = true;

    const sub = this.uploadService.getFilesInRange(this.selectedStartDate, this.selectedEndDate).subscribe({
      next: (files) => {
        this.allUploadedFiles = files.map(f => ({
          id: f.id,
          name: f.original_name,
          uploadDate: new Date(f.inserted_at),
          insertedAt: f.inserted_at
        }));
        this.filesLoaded = true;
        this.isLoadingFiles = false;
      },
      error: (error) => {
        console.error('Error loading previous files:', error);
        this.allUploadedFiles = [];
        this.filesLoaded = true;
        this.isLoadingFiles = false;
      }
    });
    this.subscriptions.push(sub);
  }

  private isValidFileType(file: File): boolean {
    const allowedExtensions = ['.vtt', '.srt'];
    const fileName = file.name.toLowerCase();
    return allowedExtensions.some(ext => fileName.endsWith(ext));
  }

  onFileSelected(event: any): void {
    const files = event.target.files;
    if (files && files.length > 0) {
      for (let i = 0; i < files.length; i++) {
        if (!this.isValidFileType(files[i])) {
          alert(`Invalid file type: ${files[i].name}. Only .vtt and .srt files are allowed.`);
          continue;
        }
        
        const exists = this.uploadedFilesWithStatus.some(f => f.file.name === files[i].name);
        if (!exists) {
          this.uploadedFilesWithStatus.push({
            file: files[i],
            status: 'pending',
            progress: 0
          });
          this.markForRecalculation();
        }
      }
    }
    event.target.value = '';
  }

  onFileDrop(event: DragEvent): void {
    event.preventDefault();
    this.isDragging = false;

    const files = event.dataTransfer?.files;
    if (files && files.length > 0) {
      for (let i = 0; i < files.length; i++) {
        if (!this.isValidFileType(files[i])) {
          alert(`Invalid file type: ${files[i].name}. Only .vtt and .srt files are allowed.`);
          continue;
        }
        
        const exists = this.uploadedFilesWithStatus.some(f => f.file.name === files[i].name);
        if (!exists) {
          this.uploadedFilesWithStatus.push({
            file: files[i],
            status: 'pending',
            progress: 0
          });
          this.markForRecalculation();
        }
      }
    }
  }

  selectUploadFile(file: File): void {
    this.selectedUploadFile = file;
  }

  isUploadFileSelected(file: File): boolean {
    return this.selectedUploadFile === file;
  }

  removeIndividualFile(index: number): void {
    this.uploadedFilesWithStatus.splice(index, 1);
    this.markForRecalculation();
  }

  async onUpload(): Promise<void> {
    if (this.uploadedFilesWithStatus.length > 0) {
      this.uploadStarted = true;
      await this.uploadFilesSequentially();
      this.markForRecalculation();
    }
  }

  async uploadFilesSequentially(): Promise<void> {
    for (let i = 0; i < this.uploadedFilesWithStatus.length; i++) {
      const fileWithStatus = this.uploadedFilesWithStatus[i];

      fileWithStatus.status = 'uploading';
      fileWithStatus.progress = 0;
      this.markForRecalculation();

      try {
        await this.uploadFileViaService(fileWithStatus);
        fileWithStatus.status = 'uploaded';
        fileWithStatus.progress = 100;
        this.markForRecalculation();
      } catch (error) {
        fileWithStatus.status = 'error';
        this.markForRecalculation();
        console.error(`Failed to upload ${fileWithStatus.file.name}:`, error);
      }
    }
  }

  private uploadFileViaService(fileWithStatus: FileWithStatus): Promise<void> {
    return new Promise((resolve, reject) => {
      const sub = this.uploadService.uploadFile(fileWithStatus.file).subscribe({
        next: (event: any) => {
          if (event.type === HttpEventType.UploadProgress) {
            if (event.total) {
              fileWithStatus.progress = Math.round((100 * event.loaded) / event.total);
            }
          } else if (event.type === HttpEventType.Response) {
            const response = event.body as UploadResponse;
            fileWithStatus.uploadedFileId = response.fileId;
            console.log('Upload successful:', response);
            resolve();
          }
        },
        error: (error) => {
          console.error('Upload error:', error);
          reject(error);
        }
      });
      this.subscriptions.push(sub);
    });
  }

  onDragOver(event: DragEvent): void {
    event.preventDefault();
    this.isDragging = true;
  }

  onDragLeave(event: DragEvent): void {
    event.preventDefault();
    this.isDragging = false;
  }

  handleGenerate(): void {
    if (this.uploadMode === 'new' && this.selectedUploadFile) {
      this.startProcessing(this.selectedUploadFile.name);

      const fileWithStatus = this.uploadedFilesWithStatus.find(
        f => f.file.name === this.selectedUploadFile?.name
      );

      const request: GenerateRequest = {
        fileID: fileWithStatus?.uploadedFileId || '',
        optional_prompt: this.optionalPrompts,
        model_name: this.selectedModel
      };

      this.generateAnalysis(request);
    } else if (this.uploadMode === 'previous' && this.selectedPreviousFile) {
      this.startProcessing(this.selectedPreviousFile.name);

      const request: GenerateRequest = {
        fileID: this.selectedPreviousFile.id,
        optional_prompt: this.optionalPrompts,
        model_name: this.selectedModel
      };

      this.generateAnalysis(request);
    }
  }

  private generateAnalysis(request: GenerateRequest): void {
    const sub = this.generateService.generateAnalysis(request).subscribe({
      next: (response) => {
        console.log('Generation successful:', response);
        this.onGenerate.emit({
          file: request,
          prompts: this.optionalPrompts,
          mode: this.uploadMode
        });

        setTimeout(() => {
          this.completeProcessing();
        }, 500);
      },
      error: (error) => {
        console.error('Generation error:', error);
        this.isProcessing = false;
      }
    });
    this.subscriptions.push(sub);
  }

  startProcessing(fileName: string): void {
    this.isProcessing = true;
    this.processingProgress = 0;
    this.processingFileName = fileName;

    const interval = setInterval(() => {
      this.processingProgress += 5;

      if (this.processingProgress >= 100) {
        clearInterval(interval);
        this.processingProgress = 100;
      }
    }, 1000);
  }

  completeProcessing(): void {
    this.isProcessing = false;
    this.processingProgress = 0;
    this.selectedUploadFile = null;
    this.uploadedFilesWithStatus = [];
    this.selectedPreviousFile = null;
    this.optionalPrompts = '';
    this.currentStep = 1;
    this.uploadStarted = false;
    this.markForRecalculation();
  }

  onReset(): void {
    this.uploadedFilesWithStatus = [];
    this.selectedUploadFile = null;
    this.optionalPrompts = '';
    this.isDragging = false;
    this.currentStep = 1;
    this.uploadStarted = false;
    this.markForRecalculation();
  }

  onNext(): void {
    this.currentStep = 2;
    this.selectedUploadFile = null;
  }

  onCancel(): void {
    this.currentStep = 1;
    this.selectedUploadFile = null;
    this.optionalPrompts = '';
  }

  toggleFileSelection(file: UploadFile): void {
    if (this.selectedPreviousFile?.id === file.id) {
      this.selectedPreviousFile = null;
    } else {
      this.selectedPreviousFile = file;
    }
  }

  isFileSelected(file: UploadFile): boolean {
    return this.selectedPreviousFile?.id === file.id;
  }

  clearPreviousSelection(): void {
    this.selectedPreviousFile = null;
    this.optionalPrompts = '';
  }

  getStatusBadgeClass(status: string): string {
    return `status-badge status-${status}`;
  }

  getStatusText(status: string): string {
    const statusMap: { [key: string]: string } = {
      'pending': 'Pending',
      'uploading': 'Uploading',
      'uploaded': 'Uploaded',
      'error': 'Error'
    };
    return statusMap[status] || status;
  }

  switchToMode(mode: 'new' | 'previous'): void {
    this.uploadMode = mode;

    if (mode === 'previous') {
      this.loadPreviousFiles();
    } else if (mode === 'new') {
      this.currentStep = 1;
    }
  }

  refreshPreviousFiles(): void {
    if (typeof this.selectedStartDate === 'string') {
      this.selectedStartDate = new Date(this.selectedStartDate);
    }
    if (typeof this.selectedEndDate === 'string') {
      this.selectedEndDate = new Date(this.selectedEndDate);
    }
    
    this.filesLoaded = false;
    this.loadPreviousFiles();
  }

  getFormattedDate(date: Date): string {
    if (!date) return '';
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Optimized methods with caching
  private markForRecalculation(): void {
    this._needsRecalculation = true;
  }

  private recalculateIfNeeded(): void {
    if (this._needsRecalculation) {
      this._hasUploadingOrUploadedCache = this.uploadedFilesWithStatus.some(f => 
        f.status === 'uploading' || f.status === 'uploaded'
      );
      this._hasSuccessfulUploadCache = this.uploadedFilesWithStatus.some(f => 
        f.status === 'uploaded'
      );
      this._needsRecalculation = false;
    }
  }

  get hasUploadingOrUploaded(): boolean {
    this.recalculateIfNeeded();
    return this._hasUploadingOrUploadedCache;
  }

  get hasAtLeastOneSuccessfulUpload(): boolean {
    this.recalculateIfNeeded();
    return this._hasSuccessfulUploadCache;
  }

  get hasFilesSelected(): boolean {
    return this.uploadedFilesWithStatus.length > 0;
  }

  get canGenerate(): boolean {
    if (this.uploadMode === 'new') {
      return !!this.selectedUploadFile && !this.isProcessing;
    } else {
      return !!this.selectedPreviousFile && !this.isProcessing;
    }
  }

  onDateChange(type: 'start' | 'end', value: any): void {
    if (type === 'start') {
      this.selectedStartDate = value;
    } else {
      this.selectedEndDate = value;
    }
  }
}













<div class="upload-third">
    <div class="section-header-inline">
        <h3 class="section-inline-title">Upload & Generate</h3>
        
        <div class="model-controls">
            <!-- Model Dropdown -->
            <div class="model-dropdown-container" *ngIf="!isLoadingModels && availableModels.length > 0">
                <button class="model-selector-btn" (click)="toggleModelDropdown()" [disabled]="isLoadingModels">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="model-icon">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                    </svg>
                    <span class="model-name">{{ selectedModel }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="dropdown-arrow" [class.rotate]="showModelDropdown">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                
                <div class="model-dropdown-menu" *ngIf="showModelDropdown">
                    <div class="model-option" *ngFor="let model of availableModels" 
                        [class.selected]="model === selectedModel"
                        (click)="selectModel(model)">
                        <div class="model-radio">
                            <div class="radio-dot" *ngIf="model === selectedModel"></div>
                        </div>
                        <span class="model-option-name">{{ model }}</span>
                        <svg *ngIf="model === selectedModel" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                            stroke-width="2" stroke="currentColor" class="check-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Refresh Models Button -->
            <button class="refresh-models-btn" (click)="loadModels()" [disabled]="isLoadingModels" 
                *ngIf="!isLoadingModels && availableModels.length > 0" title="Refresh Models">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
            
            <!-- Loading Animation -->
            <div class="model-loading" *ngIf="isLoadingModels">
                <div class="loading-dots">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <span class="loading-text">Loading models...</span>
            </div>
        </div>
    </div>

    <!-- Mode Toggle Tabs -->
    <div class="mode-toggle-tabs">
        <button class="mode-tab" [class.active]="uploadMode === 'new'" (click)="switchToMode('new')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
            </svg>
            <span>New Upload</span>
        </button>
        <button class="mode-tab" [class.active]="uploadMode === 'previous'" (click)="switchToMode('previous')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Previous Files</span>
        </button>
    </div>

    <!-- NEW UPLOAD MODE -->
    <div *ngIf="uploadMode === 'new'">
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step-item" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
                <div class="step-number">1</div>
                <div class="step-label">Upload</div>
            </div>
            <div class="step-connector" [class.active]="currentStep > 1"></div>
            <div class="step-item" [class.active]="currentStep === 2">
                <div class="step-number">2</div>
                <div class="step-label">Generate</div>
            </div>
        </div>

        <!-- STEP 1: Upload -->
        <div class="upload-content-wrapper" *ngIf="currentStep === 1">
            <div class="upload-fields-container">
                <!-- File Upload Area -->
                <div class="upload-area-wrapper">
                    <label class="upload-area-label">Lecture / Related file or folder</label>
                    <div class="file-upload-zone" [class.drag-over]="isDragging" (drop)="onFileDrop($event)"
                        (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                            </svg>
                        </div>
                        <h3 class="upload-title">Drop your file here</h3>
                        <p class="upload-subtitle">or</p>
                        <div class="upload-btn-wrapper">
                            <button class="browse-btn" (click)="fileInput.click()">Browse Files</button>
                        </div>
                        <input #fileInput type="file" class="file-input-hidden" multiple accept=".vtt,.srt"
                            (change)="onFileSelected($event)">
                        <p class="upload-info">Supported formats: VTT, SRT</p>
                    </div>
                </div>

                <!-- Uploaded Files List -->
                <div class="selected-files-list" *ngIf="hasFilesSelected">
                    <div class="selected-files-header">
                        <span class="selected-files-count">{{ uploadedFilesWithStatus.length }} file(s) selected</span>
                    </div>
                    <div class="selected-file" *ngFor="let fileWithStatus of uploadedFilesWithStatus; let i = index">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                        </svg>
                        <span class="file-name-display">{{ fileWithStatus.file.name }}</span>
                        <span class="file-size">({{ (fileWithStatus.file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                        <span *ngIf="uploadStarted" [className]="getStatusBadgeClass(fileWithStatus.status)">
                            {{ getStatusText(fileWithStatus.status) }}
                        </span>
                        <button *ngIf="!uploadStarted" class="remove-file-btn" (click)="removeIndividualFile(i)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 1 Action Buttons -->
            <div class="action-buttons step-1-buttons">
                <div class="left-buttons">
                    <button class="upload-btn" [disabled]="!hasFilesSelected || hasUploadingOrUploaded" (click)="onUpload()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                        Upload
                    </button>
                    <button class="reset-btn" [disabled]="!hasFilesSelected" (click)="onReset()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Reset
                    </button>
                </div>
                <button class="next-btn" [disabled]="!hasAtLeastOneSuccessfulUpload" (click)="onNext()">
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- STEP 2: Generate (New Upload) -->
        <div class="upload-content-wrapper" *ngIf="currentStep === 2">
            <div class="upload-fields-container">
                <!-- Uploaded Files with Radio Selection -->
                <div class="uploaded-files-summary">
                    <label class="summary-label">Select One File to Generate</label>
                    <div class="summary-files-list radio-selection">
                        <div class="summary-file-item radio-select"
                            *ngFor="let fileWithStatus of uploadedFilesWithStatus"
                            [class.selected]="isUploadFileSelected(fileWithStatus.file)"
                            (click)="selectUploadFile(fileWithStatus.file)">
                            <div class="file-radio">
                                <div class="radio-dot" *ngIf="isUploadFileSelected(fileWithStatus.file)"></div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            <span class="file-name-truncate">{{ fileWithStatus.file.name }}</span>
                        </div>
                    </div>
                </div>

                <!-- Optional Prompts -->
                <div class="prompts-area">
                    <label class="prompts-label">Optional Prompts (Notes)</label>
                    <textarea class="prompts-textarea" [(ngModel)]="optionalPrompts" name="prompts"
                        placeholder="Enter any specific instructions or notes for the AI analysis...&#10;&#10;Example:&#10;- Focus on extracting key topics&#10;- Identify speakers&#10;- Summarize main points"
                        rows="8"></textarea>
                    <p class="prompts-hint">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                        Add custom instructions to guide the AI analysis
                    </p>
                </div>

                <!-- Processing Progress Bar -->
                <div class="processing-container" *ngIf="isProcessing">
                    <div class="processing-header">
                        <div class="processing-icon-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="processing-icon">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                            </svg>
                        </div>
                        <div class="processing-info">
                            <h4 class="processing-title">Processing Your File</h4>
                            <p class="processing-filename">{{ processingFileName }}</p>
                        </div>
                        <span class="processing-percentage">{{ processingProgress }}%</span>
                    </div>

                    <div class="progress-bar-container">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" [style.width.%]="processingProgress">
                                <div class="progress-bar-shimmer"></div>
                            </div>
                        </div>
                    </div>

                    <p class="processing-message">
                        Analyzing content, extracting insights, and generating results...
                    </p>
                </div>
            </div>

            <!-- Step 2 Action Buttons -->
            <div class="action-buttons">
                <button class="generate-btn" [disabled]="!canGenerate" (click)="handleGenerate()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                    </svg>
                    {{ isProcessing ? 'Processing...' : 'Generate' }}
                </button>
                <button class="reset-btn" [disabled]="isProcessing" (click)="onCancel()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                    </svg>
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- PREVIOUS FILES MODE -->
    <div *ngIf="uploadMode === 'previous'">
        <div class="upload-content-wrapper">
            <div class="upload-fields-container">
                <!-- Previous Files Selection -->
                <div class="previous-files-section">
                    <div class="previous-files-header">
                        <label class="previous-files-label">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                            </svg>
                            Select One File from Previously Uploaded
                        </label>
                    </div>

                    <!-- Add Date Range Selector -->
                    <div class="date-range-selector">
                        <div class="date-input-group">
                            <label class="date-label">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                </svg>
                                From
                            </label>
                            <input type="date" class="date-input" 
                                [ngModel]="getFormattedDate(selectedStartDate)"
                                (ngModelChange)="onDateChange('start', $event)" 
                                [disabled]="isLoadingFiles">
                        </div>
                        <div class="date-separator">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" />
                            </svg>
                        </div>
                        <div class="date-input-group">
                            <label class="date-label">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                </svg>
                                To
                            </label>
                            <input type="date" class="date-input" 
                                [ngModel]="getFormattedDate(selectedEndDate)"
                                (ngModelChange)="onDateChange('end', $event)" 
                                [disabled]="isLoadingFiles">
                        </div>
                        <button class="refresh-btn-inline" (click)="refreshPreviousFiles()" [disabled]="isLoadingFiles" title="Apply Date Filter">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div class="loading-container" *ngIf="isLoadingFiles">
                        <div class="loading-spinner">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                        </div>
                        <p class="loading-text">Loading previous files...</p>
                    </div>

                    <!-- Files List -->
                    <div class="previous-files-list" *ngIf="!isLoadingFiles && allUploadedFiles.length > 0">
                        <div class="previous-file-item" *ngFor="let file of allUploadedFiles"
                            [class.selected]="isFileSelected(file)" (click)="toggleFileSelection(file)">
                            <div class="file-radio">
                                <div class="radio-dot" *ngIf="isFileSelected(file)"></div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="file-icon">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            <div class="file-details">
                                <span class="file-name">{{ file.name }}</span>
                                <span class="file-date">{{ file.insertedAt }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- No Files State -->
                    <div class="no-previous-files" *ngIf="!isLoadingFiles && allUploadedFiles.length === 0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.25 13.5h3.86a2.25 2.25 0 012.012 1.244l.256.512a2.25 2.25 0 002.013 1.244h3.218a2.25 2.25 0 002.013-1.244l.256-.512a2.25 2.25 0 012.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 00-2.15-1.588H6.911a2.25 2.25 0 00-2.15 1.588L2.35 13.177a2.25 2.25 0 00-.1.661z" />
                        </svg>
                        <p>No previously uploaded files</p>
                        <small>Upload new files to see them here</small>
                    </div>
                </div>

                <!-- Optional Prompts -->
                <div class="prompts-area">
                    <label class="prompts-label">Optional Prompts (Notes)</label>
                    <textarea class="prompts-textarea" [(ngModel)]="optionalPrompts" name="prompts"
                        placeholder="Enter any specific instructions or notes for the AI analysis...&#10;&#10;Example:&#10;- Focus on extracting key topics&#10;- Identify speakers&#10;- Summarize main points"
                        rows="8"></textarea>
                    <p class="prompts-hint">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                        Add custom instructions to guide the AI analysis
                    </p>
                </div>

                <!-- Processing Progress Bar -->
                <div class="processing-container" *ngIf="isProcessing">
                    <div class="processing-header">
                        <div class="processing-icon-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="processing-icon">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                            </svg>
                        </div>
                        <div class="processing-info">
                            <h4 class="processing-title">Processing Your File</h4>
                            <p class="processing-filename">{{ processingFileName }}</p>
                        </div>
                        <span class="processing-percentage">{{ processingProgress }}%</span>
                    </div>

                    <div class="progress-bar-container">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" [style.width.%]="processingProgress">
                                <div class="progress-bar-shimmer"></div>
                            </div>
                        </div>
                    </div>

                    <p class="processing-message">
                        Analyzing content, extracting insights, and generating results...
                    </p>
                </div>
            </div>

            <!-- Previous Files Action Buttons -->
            <div class="action-buttons">
                <button class="generate-btn" [disabled]="!canGenerate" (click)="handleGenerate()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                    </svg>
                    {{ isProcessing ? 'Processing...' : 'Generate' }}
                </button>
                <button class="reset-btn" [disabled]="isProcessing" (click)="clearPreviousSelection()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Clear
                </button>
            </div>
        </div>
    </div>
</div>
