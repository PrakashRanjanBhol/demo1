import { Component, EventEmitter, Output, Input, OnInit, OnChanges, SimpleChanges } from '@angular/core';
import { HistoryService, FileItem } from './history.service';

interface HistoryItem {
  id: string;
  name: string;
  displayDate: string;
  date: Date;
  hasResult: boolean;
}

interface RemoveGenerateFile {
  id: number;
  name: string;
}

interface GenerationStatus {
  id: number;
  status: 'Success' | 'Failure';
}

interface NewUploadFile {
  id: number;
  original_name: string;
  created_at: string;
}

@Component({
  selector: 'app-history',
  templateUrl: './history.component.html',
  styleUrls: ['./history.component.css']
})
export class HistoryComponent implements OnInit, OnChanges {
  @Input() removeGenerateFile: RemoveGenerateFile | null = null;
  @Input() generationStatus: GenerationStatus | null = null;
  @Input() newUploadFile: NewUploadFile | null = null;
  
  // Changed from string to HistoryItem
  @Output() onItemSelect = new EventEmitter<HistoryItem>();
  @Output() onAddToContentGeneration = new EventEmitter<HistoryItem>();
  @Output() onRemoveFromContentGeneration = new EventEmitter<string>();

  selectedHistoryItem: HistoryItem | null = null;
  addedToGenerationId: string | null = null;
  isPendingExpanded: boolean = true;
  isCompletedExpanded: boolean = true;

  startDate: string = '';
  endDate: string = '';

  historyItems: HistoryItem[] = [];
  isLoading: boolean = false;
  isRefreshing: boolean = false;
  errorMessage: string = '';

  // Filter properties
  isFilterVisible: boolean = false;
  filterFromDate: string = '';
  filterToDate: string = '';
  searchText: string = '';

  constructor(private historyService: HistoryService) {}

  ngOnInit(): void {
    this.initializeDateRange();
    this.fetchHistoryData();
  }

  ngOnChanges(changes: SimpleChanges): void {
    if (changes['removeGenerateFile'] && changes['removeGenerateFile'].currentValue) {
      const fileToRemove = changes['removeGenerateFile'].currentValue as RemoveGenerateFile;
      this.handleRemoveFromParent(fileToRemove);
    }

    if (changes['generationStatus'] && changes['generationStatus'].currentValue) {
      const statusUpdate = changes['generationStatus'].currentValue as GenerationStatus;
      this.handleGenerationStatusChange(statusUpdate);
    }

    if (changes['newUploadFile'] && changes['newUploadFile'].currentValue) {
      const newFile = changes['newUploadFile'].currentValue as NewUploadFile;
      this.handleNewFileUpload(newFile);
    }
  }

  get pendingFiles(): HistoryItem[] {
    return this.historyItems.filter(item => !item.hasResult);
  }

  get completedFiles(): HistoryItem[] {
    return this.historyItems.filter(item => item.hasResult);
  }

  get filteredPendingFiles(): HistoryItem[] {
    return this.applyTextSearch(this.pendingFiles);
  }

  get filteredCompletedFiles(): HistoryItem[] {
    return this.applyTextSearch(this.completedFiles);
  }

  onHistoryItemClick(itemId: string): void {
    const item = this.historyItems.find(i => i.id === itemId);
    if (item) {
      this.selectedHistoryItem = item;
      
      // Emit the full HistoryItem object
      const itemToEmit = {
        id: item.id,
        name: item.name,
        displayDate: item.displayDate,
        date: item.date
      };
      
      this.onItemSelect.emit(itemToEmit);
    }
  }

  // ... rest of the methods remain the same ...
}














// parent.component.ts
export class ParentComponent {
  removeGenerateFile: { id: number; name: string } | null = null;
  generationStatus: { id: number; status: 'Success' | 'Failure' } | null = null;
  newUploadFile: { id: number; original_name: string; created_at: string } | null = null;

  // Updated handler to receive full object
  handleItemSelect(item: { id: string; name: string; displayDate: string; date: Date }) {
    console.log('Selected Item ID:', item.id);
    console.log('Selected Item Name:', item.name);
    console.log('Selected Item Display Date:', item.displayDate);
    console.log('Selected Item Date Object:', item.date);
    
    // You can now use all the properties
    // For example, format the date differently
    const formattedDate = item.date.toLocaleDateString();
    console.log('Formatted Date:', formattedDate);
  }

  handleAddToGeneration(item: any) {
    console.log('File added:', item);
  }

  handleRemoveFromGeneration(itemId: string) {
    console.log('File removed:', itemId);
  }
}













<!-- parent.component.html -->
<app-history 
  [removeGenerateFile]="removeGenerateFile"
  [generationStatus]="generationStatus"
  [newUploadFile]="newUploadFile"
  (onItemSelect)="handleItemSelect($event)"
  (onAddToContentGeneration)="handleAddToGeneration($event)"
  (onRemoveFromContentGeneration)="handleRemoveFromGeneration($event)">
</app-history>
