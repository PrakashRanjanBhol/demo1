// MODIFIED setupCallbacks - Remove setTimeout
private setupCallbacks(): void {
  this.parserService.setCallbacks({
    onToolDetected: (toolData: ToolData) => {
      this.logToolDetected(toolData);
      this.updateLists();
      
      if (toolData.tool === 'READ') {
        this.appendReadContent(toolData);
        this.scrollToBottom();
      } else {
        this.cdr.detectChanges();
        this.scrollToBottom();
      }
    },
    onApprovalRequest: (approvalRequest: ApprovalRequest) => {
      this.isWaitingForApproval = true;
      this.currentApprovalRequest = approvalRequest;
      this.isApprovingChanges = false;
      this.logWaitingForApproval(approvalRequest.data);
      this.updateLists();
      
      // MODIFIED: No setTimeout, just state changes
      this.showStreamingContainer = false;
      this.showApprovalCard = true;
      this.cdr.detectChanges();
      this.scrollToBottom();
    },
    onCompletion: () => {
      this.isProcessing = false;
      this.isApprovingChanges = false;
      this.hasReceivedFirstChunk = false;
      this.isCompleted = true;
      this.logCompleted();
      this.updateLists();
      this.cdr.detectChanges();
    },
    onError: (error: string) => {
      this.isProcessing = false;
      this.isApprovingChanges = false;
      this.hasReceivedFirstChunk = false;
      this.logError(error);
    },
    onFirstChunk: () => {
      this.hasReceivedFirstChunk = true;
      this.logFirstChunkReceived();
      this.cdr.detectChanges();
    }
  });
}

// MODIFIED approveAndContinue - Remove setTimeout except for spinner
public async approveAndContinue(): Promise<void> {
  if (this.currentApprovalRequest && !this.isApprovingChanges) {
    console.log('✅ APPROVED:', this.currentApprovalRequest.data);
    console.log('Saving code changes via API...\n');
    
    this.isApprovingChanges = true;
    this.cdr.detectChanges();
    
    try {
      const fileDetails = this.getFileDetails(this.currentApprovalRequest.data.content);
      
      if (fileDetails) {
        const payload = {
          tool: this.currentApprovalRequest.data.tool,
          file_path: fileDetails.file_path,
          file_name: fileDetails.file_name,
          original_code: fileDetails.original_code || '',
          modified_code: fileDetails.modified_code || '',
          reasoning: this.getReasoning(this.currentApprovalRequest.data.content),
          timestamp: new Date().toISOString()
        };
        
        await this.saveCodeChanges(payload);
        console.log('✅ Code changes saved successfully');
      }
      
      // MODIFIED: Remove setTimeout, direct state changes
      this.showApprovalCard = false;
      this.isWaitingForApproval = false;
      this.currentApprovalRequest = null;
      this.showStreamingContainer = true;
      
      this.parserService.approveAndContinue();
      this.updateLists();
      this.scrollToBottom();
      this.cdr.detectChanges();
      
    } catch (error) {
      console.error('❌ Failed to save code changes:', error);
      alert('Failed to save code changes. Please try again.');
      this.isApprovingChanges = false;
      this.cdr.detectChanges();
      return;
    }
    
    // KEEP: Only setTimeout for spinner (for better UX)
    setTimeout(() => {
      this.isApprovingChanges = false;
      this.cdr.detectChanges();
    }, 300);
  }
}

// MODIFIED rejectChanges - Remove setTimeout
public rejectChanges(): void {
  if (this.currentApprovalRequest) {
    console.log('❌ REJECTED:', this.currentApprovalRequest.data);
    console.log('Continuing with next operation...\n');
    
    this.currentApprovalRequest.data.rejected = true;
    this.executedItems.push(this.currentApprovalRequest.data);
    
    // MODIFIED: Remove setTimeout, direct state changes
    this.showApprovalCard = false;
    this.isWaitingForApproval = false;
    this.currentApprovalRequest = null;
    this.showStreamingContainer = true;
    
    this.parserService.approveAndContinue();
    this.updateLists();
    this.scrollToBottom();
    this.cdr.detectChanges();
  }
}
